---
applyTo: "**"
---

# 🧠 Prompt Canvas AI Backend 개발 지침 (Copilot용)

## 🎯 목적

Freshdesk Custom App에서 상담사를 위한 **AI 응답 보조 도구**를 개발한다. 백엔드는 LLM과 Vector DB 기반으로 응답 생성에 필요한 정보를 수집하고 가공하며, 프론트는 이를 탭 기반 UI로 구성하여 사용자 경험을 제공한다.

---

## 📌 백엔드 아키텍처 핵심

### 1. 전체 구조 분리 원칙

- `API Layer`: 프론트로부터 요청을 받고 분기
- `Context Builder`: 티켓 요약, 관련 문서, 유사 티켓 등 컨텍스트 구성
- `Retriever`: Vector DB에서 유사 문서/티켓 검색
- `LLM Orchestrator`: 프롬프트 구성 및 LLM 호출
- `Response Assembler`: LLM 응답 후 최종 포맷 구성

> 모든 서비스는 **함수형 모듈로 분리**하고, 고객/세션 정보는 메타데이터로 포함

---

### 2. API 설계 기본

| API Path           | 기능                      | 호출 시점                    |
| ------------------ | ------------------------- | ---------------------------- |
| `/init`            | 티켓 요약 / 컨텍스트 구성 | 프롬프트 캔버스 최초 로드 시 |
| `/generate_reply`  | AI 답변 생성              | "답변 제안" 버튼 클릭 시     |
| `/similar_tickets` | 유사 티켓 검색            | 탭 진입 시                   |
| `/related_docs`    | KB 연관 문서 검색         | 탭 진입 시                   |
| `/image_gallery`   | 관련 이미지 목록 제공     | 갤러리 탭 진입 시            |

- 모든 API는 `ticket_id` 기반으로 작동
- 캐싱 전략 필요 (최초 요청 이후에는 재요청 제한)

---

### 3. 컨텍스트 구성 흐름 (`Context Builder`)

1. **티켓 메타 정보 추출**: 제목, 본문, 그룹, 태그, 상태 등
2. **요약 생성**: LLM으로 `에이전트용 요약` (1회만 생성)
3. **벡터 검색**:
   - 유사 티켓: 벡터DB에서 유사 이슈 검색
   - 관련 KB 문서: 벡터DB 또는 사전 정의한 Notion/Docs 데이터
4. **컨텍스트 조합**:
   - 요약 + 유사 항목 + KB 문서 = LLM 입력용 context 구성
   - 길이 초과 시 chunk 및 우선순위 조절

---

### 4. LLM 요청 규칙

- `generate_reply`: 요약 + 관련 문서 기반 prompt 구성
- `rewrite_block`: 특정 블록 문장을 개선하는 LLM 요청
- 프롬프트는 지침 기반 템플릿화하여 관리 가능

---

## 🔍 프론트와의 연동 조건 (Trigger 기준)

| 기능           | 백엔드 요청 조건 | 추가 설명                   |
| -------------- | ---------------- | --------------------------- |
| 요약           | 최초 로딩 시만   | localStorage 등 캐싱 고려   |
| 답변 생성      | 버튼 클릭 시만   | 자동 호출 없음              |
| 유사/문서 추천 | 탭 진입 시       | API 응답 캐시 여부 검토     |
| 이미지 갤러리  | 탭 진입 시       | 문서/티켓에 포함된 이미지만 |

---

## 🧾 관리자 설정 항목 (iparams.html용)

| 항목                 | 설명                              |
| -------------------- | --------------------------------- |
| 스타일 지침          | 공식/친근/기술적 등               |
| 금지 표현 목록       | 예: "죄송합니다" → "안내드립니다" |
| 기본 인삿말/마무리문 | 자동 삽입 여부 선택               |
| 향후 옵션 (로드맵)   | 학습 범위 설정 (기간, 그룹 등)    |

---

## ✅ 기타 설계 원칙

- LLM 호출은 사용자의 **명시적 요청**이 있어야만 수행
- 응답 길이 제한에 대비한 컨텍스트 chunk 처리 필요
- 모든 응답은 프론트가 바로 사용 가능한 구조 (`block`, `title`, `summary`, `image_url` 등)로 포맷

## 소통원칙

- 모든 소통은 한국어로만 합니다.
