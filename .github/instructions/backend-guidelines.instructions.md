---
applyTo: "**"
---

# 🧠 자연어 기반 상담사 지원 시스템 - 코파일럿 백엔드 지침서

## 🎯 목적

Freshdesk Custom App에서 상담사를 위한 자연어 기반 AI 응답 지원 시스템을 개발합니다. 백엔드는 LLM과 Vector DB 기반으로 상담사의 자연어 요청을 처리하여 유사 티켓·추천 솔루션·이미지·첨부파일 데이터를 제공하고 프론트가 바로 사용할 수 있는 JSON을 반환합니다.

---

## 📌 백엔드 아키텍처 핵심

### 1. 전체 구조 분리 원칙

- `API Layer`: 프론트로부터 요청을 받고 분기
- `Context Builder`: 티켓 요약, 관련 문서, 유사 티켓 등 컨텍스트 구성
- `Retriever`: Vector DB에서 유사 문서/티켓 검색
- `LLM Orchestrator`: 프롬프트 구성 및 LLM 호출
- `Response Assembler`: LLM 응답 후 최종 포맷 구성

> 모든 서비스는 **함수형 모듈로 분리**하고, 고객/세션 정보는 메타데이터로 포함

---

### 2. ⚡️ 주요 엔드포인트

| 엔드포인트         | 설명                                                  | 프론트 호출 여부 |
| ------------------ | ----------------------------------------------------- | ---------------- |
| `/init`            | 티켓 요약, 유사 티켓, 추천 솔루션 등 초기 데이터 제공 | ✅ 1회 호출      |
| **`/query`**       | 자연어 요청 처리 (검색할 콘텐츠 선택 기반)            | ✅ 요청마다 호출 |
| `/similar_tickets` | 유사 티켓 검색 (내부 전용)                            | ❌ 내부만 사용   |
| `/related_docs`    | 추천 솔루션/이미지/첨부파일 검색 (내부 전용)          | ❌ 내부만 사용   |

- 모든 API는 `ticket_id`를 기본으로 하며 자연어 요청 텍스트를 함께 처리
- 캐싱 전략 필요 (자주 요청되는 패턴 인식 및 응답 최적화)

---

## 🟢 주요 엔드포인트 상세

### 1. 🟢 /init

✅ **기능**

- 프론트 최초 로딩 시 호출
- `/similar_tickets`, `/related_docs`를 내부적으로 호출 → 모든 초기 데이터를 단일 응답으로 구성
- 티켓 메타 정보 추출 및 LLM으로 요약 생성 (1회만 생성)
- 현재 상담사가 조회하고 있는 티켓을 parameter로 처리.
- 기존 /init/{{ticket_id}} 그대로 사용하면 될 것 같음.

✅ **처리 흐름**

1.
2. **요약 생성**: LLM으로 `에이전트용 요약` 생성
3. **벡터 검색**:
   - 유사 티켓: `similar_tickets` 내부 호출
   - 관련 솔루션: `related_docs` 내부 호출
4. **응답 구성**:
   - 요약 + 유사 티켓 + 추천 솔루션 통합 JSON 반환

### 2. 🟢 /query

✅ **기능**

- "OO와 대화하기" 탭에서 자연어 입력 + 콘텐츠 타입 선택 시 호출
- 자연어 요청 의도 분석 및 검색 콘텐츠 타입에 따른 응답 생성
- 티켓 컨텍스트를 기반으로 관련 정보 검색 및 응답 구성

✅ **입력 예시**

```json
{
  "intent": "search",
  "type": ["tickets", "solutions", "images", "attachments"],
  "query": "이 문제 관련 자료를 찾아줘"
}
```

✅ **처리 흐름**

- `intent_classification`: 상담사 요청의 의도 분류 및 적절한 작업 선택
- 선택된 콘텐츠 타입에 따라 내부 검색 모듈 호출
- 결과를 타입별로 정리하여 JSON 응답 구성

### 3. 🟢 /similar_tickets (내부 전용)

✅ **기능**

- 현재 티켓과 유사한 과거 티켓을 벡터 DB에서 검색
- `/init` 및 `/query` 내부에서 호출하여 결과 활용
- 프론트에서 직접 호출 금지

✅ **처리 방식**

- 티켓 컨텍스트를 임베딩하여 벡터 DB에서 유사도 검색
- 결과는 관련성 점수 내림차순 정렬 후 상위 N개 반환

### 4. 🟢 /related_docs (내부 전용)

✅ **기능**

- 현재 티켓 관련 지식베이스 문서/솔루션을 벡터 DB에서 검색
- `/init` 및 `/query` 내부에서 호출하여 결과 활용

✅ **처리 방식**

- 티켓 컨텍스트를 임베딩하여 문서/이미지/첨부파일 DB 검색
- 결과는 타입별로 분류하여 반환

---

## 🔍 프론트와의 연동 흐름

### 페이지 최초 로드

- 프론트에서 `/init` 호출 → 티켓 요약, 유사 티켓, 추천 솔루션 한 번에 제공
- 초기 데이터는 프론트에서 로컬 캐싱하여 사용

### 자연어 요청 처리

- "대화하기" 탭에서 검색 콘텐츠 선택 및 자연어 입력 후 `/query` 호출
- 요청마다 새로운 검색 및 LLM 처리 수행
- 결과는 타입별(티켓/솔루션/이미지/첨부파일)로 구분하여 반환

---

## ⚙️ 관리자 설정 항목 (iparams.html용)

| 항목                  | 설명                                   |
| --------------------- | -------------------------------------- |
| 자연어 명령 인식 범위 | 지원할 자연어 명령 패턴 설정           |
| 스타일 지침           | 공식/친근/기술적 등                    |
| 금지 표현 목록        | 예: "죄송합니다" → "안내드립니다"      |
| 데이터 검색 기간 설정 | 1개월, 3개월, 6개월, 전체 등           |
| 향후 옵션 (로드맵)    | 자동화 수준 세분화, 상담사별 맞춤 설정 |

---

## 🛠️ 백엔드 개발 핵심 지침

- LLM 호출은 사용자의 **명시적 요청**이 있어야만 수행
- 자연어 요청의 의도 파악 정확성 향상을 위한 컨텍스트 최적화
- 모든 응답은 프론트가 바로 사용 가능한 구조로 JSON 포맷
- `/init`, `/query`만 프론트에 노출, 나머지는 내부용
- 티켓 ID를 기준으로 모든 요청 처리
- 자연어 명령 대표 패턴:
  - "이 문제 관련 자료 찾아줘"
  - "비슷한 문제 해결 사례 찾아줘"
  - "이 이슈의 해결책 제안해줘"
  - "이 문제에 대한 대응 방법은?"

## 소통원칙

- 모든 소통은 한국어로만 합니다.
