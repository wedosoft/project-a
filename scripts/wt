#!/bin/bash

# 워크트리 통합 관리 도구
# 브랜치와 워크트리 생성/환경설정/병합/제거를 한 번에 처리

# 프로젝트 루트 경로
export PROJECT_A_ROOT="/Users/alan/GitHub/project-a"

# 색상 코드
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 도움말 출력
show_help() {
    echo -e "${BLUE}🛠️  워크트리 통합 관리 도구${NC}"
    echo ""
    echo "사용법:"
    echo "  $(basename $0) create <branch-name>    - 워크트리 생성 및 환경 설정"
    echo "  $(basename $0) list                    - 워크트리 목록 조회"
    echo "  $(basename $0) remove <branch-name>    - 워크트리 및 브랜치 제거"
    echo "  $(basename $0) goto <branch-name>      - 워크트리로 이동"
    echo "  $(basename $0) backend <branch-name>   - 백엔드로 이동하고 가상환경 활성화"
    echo "  $(basename $0) start                   - 백엔드 서버 시작"
    echo "  $(basename $0) merge <branch-name>     - 브랜치를 dev에 병합 후 제거"
    echo ""
    echo "예시:"
    echo "  $(basename $0) create feature/admin"
    echo "  $(basename $0) backend feature/admin"
    echo "  $(basename $0) start"
    echo "  $(basename $0) merge feature/admin"
}

# 워크트리 생성 및 환경 설정
create_worktree() {
    local branch_name="$1"
    
    if [ -z "$branch_name" ]; then
        echo -e "${RED}❌ 브랜치 이름을 입력해주세요.${NC}"
        echo "사용법: $(basename $0) create <branch-name>"
        exit 1
    fi
    
    local folder_name=$(echo "$branch_name" | sed 's/\//-/g')
    local worktree_path="/Users/alan/GitHub/project-a-$folder_name"
    
    echo -e "${BLUE}🚀 워크트리 생성 중: $branch_name${NC}"
    
    # 프로젝트 루트로 이동
    cd "$PROJECT_A_ROOT" || exit 1
    
    # 새 브랜치 생성 (dev에서)
    echo -e "${YELLOW}📋 dev 브랜치에서 새 브랜치 생성 중...${NC}"
    git checkout dev
    git pull origin dev
    git checkout -b "$branch_name"
    git checkout dev
    
    # 워크트리 생성
    echo -e "${YELLOW}📁 워크트리 생성 중: $worktree_path${NC}"
    git worktree add "$worktree_path" "$branch_name"
    
    # .env 파일 복사
    echo -e "${YELLOW}📄 .env 파일 복사 중...${NC}"
    if [ -f "$PROJECT_A_ROOT/backend/.env" ]; then
        cp "$PROJECT_A_ROOT/backend/.env" "$worktree_path/backend/.env"
        echo -e "${GREEN}✅ .env 파일이 복사되었습니다.${NC}"
    else
        echo -e "${YELLOW}⚠️ .env 파일이 없습니다.${NC}"
    fi
    
    # 가상환경 생성
    echo -e "${YELLOW}🐍 가상환경 생성 중...${NC}"
    cd "$worktree_path/backend"
    python3 -m venv venv
    source venv/bin/activate
    
    # requirements.txt가 있으면 패키지 설치
    if [ -f "requirements.txt" ]; then
        echo -e "${YELLOW}📦 패키지 설치 중...${NC}"
        pip install -r requirements.txt
    fi
    
    # .autoenv 파일 생성 (폴더 진입시 자동 가상환경 활성화)
    echo "source venv/bin/activate" > .autoenv
    
    echo -e "${GREEN}🎉 워크트리 생성 완료!${NC}"
    echo -e "${BLUE}📍 경로: $worktree_path${NC}"
    echo -e "${BLUE}🌿 브랜치: $branch_name${NC}"
    echo ""
    echo "다음 명령어로 시작하세요:"
    echo "  $(basename $0) backend $branch_name"
    echo "  $(basename $0) start"
}

# 워크트리 목록 조회
list_worktrees() {
    echo -e "${BLUE}📋 워크트리 목록${NC}"
    cd "$PROJECT_A_ROOT"
    git worktree list
}

# 워크트리 및 브랜치 제거
remove_worktree() {
    local branch_name="$1"
    
    if [ -z "$branch_name" ]; then
        echo -e "${RED}❌ 브랜치 이름을 입력해주세요.${NC}"
        echo "사용법: $(basename $0) remove <branch-name>"
        exit 1
    fi
    
    local folder_name=$(echo "$branch_name" | sed 's/\//-/g')
    local worktree_path="/Users/alan/GitHub/project-a-$folder_name"
    
    echo -e "${YELLOW}🗑️ 워크트리 제거 중: $worktree_path${NC}"
    
    cd "$PROJECT_A_ROOT"
    
    # 워크트리 제거
    if [ -d "$worktree_path" ]; then
        git worktree remove "$worktree_path" --force
        echo -e "${GREEN}✅ 워크트리가 제거되었습니다.${NC}"
    else
        echo -e "${YELLOW}⚠️ 워크트리가 존재하지 않습니다: $worktree_path${NC}"
    fi
    
    # 브랜치 제거
    git branch -D "$branch_name" 2>/dev/null || echo -e "${YELLOW}⚠️ 로컬 브랜치가 이미 제거되었거나 존재하지 않습니다.${NC}"
    
    echo -e "${GREEN}🎉 정리 완료!${NC}"
}

# 워크트리로 이동
goto_worktree() {
    local branch_name="$1"
    
    if [ -z "$branch_name" ]; then
        echo -e "${RED}❌ 브랜치 이름을 입력해주세요.${NC}"
        echo "사용법: $(basename $0) goto <branch-name>"
        exit 1
    fi
    
    local folder_name=$(echo "$branch_name" | sed 's/\//-/g')
    local worktree_path="/Users/alan/GitHub/project-a-$folder_name"
    
    if [ -d "$worktree_path" ]; then
        cd "$worktree_path"
        echo -e "${GREEN}📍 워크트리로 이동했습니다: $worktree_path${NC}"
    else
        echo -e "${RED}❌ 워크트리가 존재하지 않습니다: $worktree_path${NC}"
        exit 1
    fi
}

# 백엔드로 이동하고 가상환경 활성화
goto_backend() {
    local branch_name="$1"
    
    if [ -z "$branch_name" ]; then
        echo -e "${RED}❌ 브랜치 이름을 입력해주세요.${NC}"
        echo "사용법: $(basename $0) backend <branch-name>"
        exit 1
    fi
    
    local folder_name=$(echo "$branch_name" | sed 's/\//-/g')
    local backend_path="/Users/alan/GitHub/project-a-$folder_name/backend"
    
    if [ -d "$backend_path" ]; then
        cd "$backend_path"
        if [ -f "venv/bin/activate" ]; then
            source venv/bin/activate
            echo -e "${GREEN}🐍 백엔드로 이동하고 가상환경을 활성화했습니다: $backend_path${NC}"
        else
            echo -e "${YELLOW}⚠️ 가상환경이 없습니다. 다시 생성해주세요.${NC}"
        fi
    else
        echo -e "${RED}❌ 백엔드 폴더가 존재하지 않습니다: $backend_path${NC}"
        exit 1
    fi
}

# 백엔드 서버 시작
start_server() {
    # 현재 디렉토리가 backend 폴더인지 확인
    if [[ $(basename "$PWD") != "backend" ]]; then
        echo -e "${RED}❌ backend 폴더에서 실행해주세요.${NC}"
        echo "사용법: $(basename $0) backend <branch-name> 으로 이동 후 $(basename $0) start 실행"
        exit 1
    fi
    
    # 가상환경이 활성화되어 있는지 확인
    if [[ -z "$VIRTUAL_ENV" ]]; then
        echo -e "${YELLOW}⚠️ 가상환경이 활성화되지 않았습니다. 가상환경을 활성화합니다...${NC}"
        if [ -f "venv/bin/activate" ]; then
            source venv/bin/activate
        else
            echo -e "${RED}❌ 가상환경이 없습니다. 워크트리를 다시 생성해주세요.${NC}"
            exit 1
        fi
    fi
    
    echo -e "${GREEN}🚀 백엔드 서버를 시작합니다...${NC}"
    uvicorn api.main:app --reload --host 0.0.0.0 --port 8000
}

# 브랜치를 dev에 병합 후 제거
merge_and_cleanup() {
    local branch_name="$1"
    
    if [ -z "$branch_name" ]; then
        echo -e "${RED}❌ 브랜치 이름을 입력해주세요.${NC}"
        echo "사용법: $(basename $0) merge <branch-name>"
        exit 1
    fi
    
    echo -e "${BLUE}🔄 브랜치 병합 및 정리 시작: $branch_name${NC}"
    
    cd "$PROJECT_A_ROOT"
    
    # dev 브랜치로 전환하고 최신 상태로 업데이트
    echo -e "${YELLOW}📋 dev 브랜치로 전환 중...${NC}"
    git checkout dev
    git pull origin dev
    
    # 브랜치 병합
    echo -e "${YELLOW}🔄 브랜치 병합 중...${NC}"
    git merge "$branch_name" --no-ff -m "feat: Merge $branch_name into dev"
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✅ 병합 완료!${NC}"
        
        # 원격에 푸시
        echo -e "${YELLOW}📤 dev 브랜치를 원격에 푸시 중...${NC}"
        git push origin dev
        
        # 워크트리와 브랜치 제거
        echo -e "${YELLOW}🗑️ 워크트리와 브랜치 정리 중...${NC}"
        remove_worktree "$branch_name"
        
        echo -e "${GREEN}🎉 모든 작업이 완료되었습니다!${NC}"
    else
        echo -e "${RED}❌ 병합 중 충돌이 발생했습니다. 수동으로 해결해주세요.${NC}"
        exit 1
    fi
}

# 메인 로직
case "$1" in
    "create")
        create_worktree "$2"
        ;;
    "list")
        list_worktrees
        ;;
    "remove")
        remove_worktree "$2"
        ;;
    "goto")
        goto_worktree "$2"
        ;;
    "backend")
        goto_backend "$2"
        ;;
    "start")
        start_server
        ;;
    "merge")
        merge_and_cleanup "$2"
        ;;
    *)
        show_help
        ;;
esac
