<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: api_original.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: api_original.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * ğŸŒ ë°±ì—”ë“œ API í†µì‹  ì „ë‹´ í´ë¼ì´ì–¸íŠ¸ - Freshdesk ì—°ë™ í†µì‹  ëª¨ë“ˆ
 * 
 * ì´ ëª¨ë“ˆì€ Freshdesk Custom Appê³¼ ë°±ì—”ë“œ AI ì„œë²„ ê°„ì˜ ëª¨ë“  í†µì‹ ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.
 * Python FastAPI ë°±ì—”ë“œì™€ ì•ˆì „í•˜ê³  íš¨ìœ¨ì ì¸ ë°ì´í„° êµí™˜ì„ ìœ„í•œ í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤.
 * 
 * ì£¼ìš” ê¸°ëŠ¥:
 * - ë™ì  Freshdesk ì„¤ì • ì§€ì› (ë©€í‹°í…Œë„ŒíŠ¸ í™˜ê²½)
 * - ìë™ í—¤ë” êµ¬ì„± ë° ì¸ì¦ ì²˜ë¦¬
 * - ì—ëŸ¬ ë³µêµ¬ ë° ì¬ì‹œë„ ë¡œì§
 * - API ì‘ë‹µ ìºì‹± ë° ì„±ëŠ¥ ìµœì í™”
 * - ë°±ì—”ë“œ 9ê°œ ì—”ë“œí¬ì¸íŠ¸ ì „ì²´ ì§€ì›
 * 
 * ì§€ì› ì—”ë“œí¬ì¸íŠ¸:
 * - /init: í‹°ì¼“ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
 * - /query: ìì—°ì–´ AI ì±„íŒ… ì²˜ë¦¬
 * - /generate_reply: ì¶”ì²œ ë‹µë³€ ìƒì„±
 * - /ingest: ë°ì´í„° ìˆ˜ì§‘ ê´€ë¦¬
 * - /health, /metrics: ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§
 * - /query/stream, /generate_reply/stream: ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°
 * - /attachments/*: ì²¨ë¶€íŒŒì¼ ì ‘ê·¼
 * 
 * @author We Do Soft Inc.
 * @since 2025.06.16
 * @version 2.0.0 (ë©€í‹°í…Œë„ŒíŠ¸ ì§€ì› ë° ë¬¸ì„œí™” ê°•í™”)
 */

// API ëª¨ë“ˆ ì •ì˜ - ëª¨ë“  API ê´€ë ¨ í•¨ìˆ˜ë¥¼ í•˜ë‚˜ì˜ ê°ì²´ë¡œ ê´€ë¦¬
window.API = window.API || {};

/**
 * ğŸ”— ë°±ì—”ë“œ API í˜¸ì¶œ í•µì‹¬ í•¨ìˆ˜
 * 
 * Freshdesk Custom Appê³¼ Python FastAPI ë°±ì—”ë“œ ê°„ì˜ ëª¨ë“  í†µì‹ ì„ ì²˜ë¦¬í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜ì…ë‹ˆë‹¤.
 * ë©€í‹°í…Œë„ŒíŠ¸ í™˜ê²½ì—ì„œ ê° ê³ ê°ì‚¬ì˜ Freshdesk ì„¤ì •ì„ ë™ì ìœ¼ë¡œ ì ìš©í•˜ì—¬ ì•ˆì „í•œ ë°ì´í„° ê²©ë¦¬ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.
 * 
 * ì£¼ìš” ì²˜ë¦¬ ê³¼ì •:
 * 1. iparamsì—ì„œ ê³ ê°ì‚¬ë³„ Freshdesk ì„¤ì • ë¡œë“œ
 * 2. ë™ì  í—¤ë” êµ¬ì„± (X-Freshdesk-Domain, X-Freshdesk-API-Key)
 * 3. ë°±ì—”ë“œ API í˜¸ì¶œ ë° ì‘ë‹µ ì²˜ë¦¬
 * 4. ì—ëŸ¬ ìƒí™© ì‹œ ì ì ˆí•œ í´ë°± ì²˜ë¦¬
 * 5. ì‘ë‹µ ë°ì´í„° ê²€ì¦ ë° ìºì‹±
 * 
 * @param {Object} client - FDK í´ë¼ì´ì–¸íŠ¸ ê°ì²´ (Freshdesk SDK)
 * @param {string} endpoint - API ì—”ë“œí¬ì¸íŠ¸ (ì˜ˆ: "init/123", "query")
 * @param {Object|null} data - ìš”ì²­ ë°ì´í„° (POST ìš”ì²­ì˜ ê²½ìš°)
 * @param {string} method - HTTP ë©”ì„œë“œ ("GET" ë˜ëŠ” "POST")
 * @returns {Promise&lt;Object>} API ì‘ë‹µ ê²°ê³¼ {ok: boolean, data?: Object, error?: string}
 * 
 * @example
 * // í‹°ì¼“ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
 * const result = await callBackendAPI(client, "init/12345", null, "GET");
 * 
 * // ìì—°ì–´ ì¿¼ë¦¬ ì‹¤í–‰
 * const queryData = { query: "ìœ ì‚¬í•œ ë¬¸ì œë¥¼ ì°¾ì•„ì¤˜", type: ["tickets", "solutions"] };
 * const result = await callBackendAPI(client, "query", queryData, "POST");
 */
async function callBackendAPI(client, endpoint, data = null, method = "GET") {
  let loadingId = null;
  
  try {
    console.log(`ğŸš€ ë°±ì—”ë“œ API í˜¸ì¶œ: ${method} /${endpoint}`);

    // ë¡œë”© ìƒíƒœ í‘œì‹œ
    const loadingMessage = method === "GET" ? "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..." : "ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘...";
    if (typeof UI !== 'undefined' &amp;&amp; UI.showLoading) {
      UI.showLoading(loadingMessage);
      loadingId = 'api-call';
    }

    // iparamsì—ì„œ Freshdesk ì„¤ì •ê°’ ê°€ì ¸ì˜¤ê¸°
    // ê° ê³ ê°ì‚¬ë³„ë¡œ ë‹¤ë¥¸ ë„ë©”ì¸ê³¼ API í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ë¡œë“œ
    const config = await getFreshdeskConfigFromIparams(client);

    if (!config || !config.domain || !config.apiKey) {
      console.warn(
        "âš ï¸ iparamsì—ì„œ Freshdesk ì„¤ì •ê°’ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í™˜ê²½ë³€ìˆ˜ í´ë°± ì‹œë„..."
      );

      // í´ë°±: requests.jsonì˜ ê¸°ë³¸ í—¤ë” ì‚¬ìš© (ê°œë°œ í™˜ê²½ìš©)
      if (method === "GET") {
        const response = await client.request.invokeTemplate("backendApi", {
          context: { path: endpoint },
        });
        return { ok: true, data: response };
      } else {
        const response = await client.request.invokeTemplate("backendApiPost", {
          context: { path: endpoint },
          body: JSON.stringify(data),
        });
        return { ok: true, data: response };
      }
    }

    // iparams ê°’ìœ¼ë¡œ ë™ì  í—¤ë” ìƒì„±
    const dynamicHeaders = {
      "Content-Type": "application/json",
      "X-Freshdesk-Domain":
        config.companyId || extractCompanyIdFromDomain(config.domain), // company_id ì „ë‹¬
      "X-Freshdesk-API-Key": config.apiKey,
      "ngrok-skip-browser-warning": "true", // ngrok í™˜ê²½ìš©
    };

    console.log("ğŸ“¡ ë™ì  í—¤ë” ìƒì„±:", {
      domain: dynamicHeaders["X-Freshdesk-Domain"],
      hasApiKey: !!dynamicHeaders["X-Freshdesk-API-Key"],
    });

    // ë™ì  ìš”ì²­ ì„¤ì •ìœ¼ë¡œ API í˜¸ì¶œ
    const requestConfig = {
      method: method,
      protocol: "https",
      host: config.backendUrl
        ? new URL(config.backendUrl).host
        : "7987-58-122-170-2.ngrok-free.app",
      path: `/${endpoint}`,
      headers: dynamicHeaders,
    };

    if (method === "GET") {
      const response = await client.request.invoke("generic", {
        schema: requestConfig,
        context: { path: endpoint },
      });
      return { ok: true, data: response.response || response };
    } else {
      requestConfig.body = JSON.stringify(data);
      const response = await client.request.invoke("generic", {
        schema: requestConfig,
        context: { path: endpoint },
        body: JSON.stringify(data),
      });
      return { ok: true, data: response.response || response };
    }
    
  } catch (error) {
    console.error(`âŒ ë°±ì—”ë“œ API í˜¸ì¶œ ì˜¤ë¥˜ (${method} /${endpoint}):`, error);
    
    // ê°œì„ ëœ ì—ëŸ¬ ì²˜ë¦¬ ì‚¬ìš©
    GlobalState.ErrorHandler.handleError(error, {
      module: 'api',
      function: 'callBackendAPI',
      context: `${method} /${endpoint}`,
      severity: 'error',
      userMessage: 'ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'
    });
    
    return { ok: false, error: error.message };
    
  } finally {
    // ë¡œë”© ìƒíƒœ í•´ì œ
    if (loadingId &amp;&amp; typeof UI !== 'undefined' &amp;&amp; UI.hideLoading) {
      UI.hideLoading();
    }
  }
}

/**
 * ë°±ì—”ë“œì—ì„œ ì´ˆê¸° ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜ (/init ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ)
 * @param {Object} client - FDK í´ë¼ì´ì–¸íŠ¸ ê°ì²´
 * @param {Object} basicTicketInfo - ê¸°ë³¸ í‹°ì¼“ ì •ë³´
 */
async function loadInitialDataFromBackend(client, basicTicketInfo) {
  try {
    console.log("ğŸš€ ë°±ì—”ë“œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹œì‘");

    // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
    if (globalTicketData.isLoading) {
      console.log("âš ï¸ ì´ë¯¸ ë¡œë”© ì¤‘ì´ë¯€ë¡œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€");
      return;
    }

    // ë¡œë”© ìƒíƒœ ì„¤ì •
    globalTicketData.isLoading = true;

    try {
      // FDKë¥¼ í†µí•œ ë°±ì—”ë“œ /init API í˜¸ì¶œ (GET ë©”ì„œë“œ, ë°ì´í„° ì—†ìŒ)
      const response = await callBackendAPI(
        client,
        `init/${basicTicketInfo.id}`,
        null,
        "GET"
      );

      if (response.ok) {
        const data = response.data;
        console.log("âœ… ë°±ì—”ë“œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", data);

        // ì‘ë‹µ ë°ì´í„° êµ¬ì¡° í™•ì¸ ë° ë¡œê¹…
        console.log("ğŸ“Š ì‘ë‹µ ë°ì´í„° ë¶„ì„:");
        console.log(
          "- similar_tickets ê°œìˆ˜:",
          data.similar_tickets?.length || 0
        );
        console.log("- kb_documents ê°œìˆ˜:", data.kb_documents?.length || 0);
        console.log("- similar_tickets ë°ì´í„°:", data.similar_tickets);
        console.log("- kb_documents ë°ì´í„°:", data.kb_documents);

        // ë°±ì—”ë“œì—ì„œ ë°›ì€ ì™„ì „í•œ í‹°ì¼“ ì •ë³´ë¡œ UI ì—…ë°ì´íŠ¸
        if (data.ticket_data) {
          console.log("ğŸ« ë°±ì—”ë“œì—ì„œ ë°›ì€ ì™„ì „í•œ í‹°ì¼“ ì •ë³´ë¡œ UI ì—…ë°ì´íŠ¸");
          updateTicketInfo(data.ticket_data);
        } else {
          // ë°±ì—”ë“œì—ì„œ í‹°ì¼“ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì •ë³´ ì‚¬ìš©
          console.log("ğŸ« ê¸°ë³¸ í‹°ì¼“ ì •ë³´ë¡œ UI ì—…ë°ì´íŠ¸");
          updateTicketInfo(basicTicketInfo);
        }

        // ì „ì—­ ìºì‹œì— ë°ì´í„° ì €ì¥ (ticket_info í¬í•¨)
        globalTicketData = {
          summary: data.ticket_summary,
          similar_tickets: data.similar_tickets || [],
          recommended_solutions: data.kb_documents || [], // ë°±ì—”ë“œì—ì„œëŠ” kb_documentsë¡œ ì˜¨ë‹¤
          cached_ticket_id: basicTicketInfo.id,
          ticket_info: data.ticket_data || basicTicketInfo, // ë°±ì—”ë“œ í‹°ì¼“ ì •ë³´ë¥¼ ìºì‹œì— ì €ì¥
          isLoading: false,
          lastLoadTime: Date.now(),
        };

        // /init ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ëª¨ë“  ë°ì´í„°ë¥¼ í•œ ë²ˆì— ë°›ì•„ì„œ í‘œì‹œ
        if (data.ticket_summary) {
          displayTicketSummary(data.ticket_summary);
        }

        if (data.similar_tickets &amp;&amp; data.similar_tickets.length > 0) {
          console.log(`ğŸ“‹ ìœ ì‚¬ í‹°ì¼“ ${data.similar_tickets.length}ê°œ í‘œì‹œ`);
          displaySimilarTickets(data.similar_tickets);
        } else {
          console.log("ğŸ“‹ ë°±ì—”ë“œì—ì„œ ìœ ì‚¬ í‹°ì¼“ ì—†ìŒ, ë¹ˆ ìƒíƒœ í‘œì‹œ");
          displaySimilarTickets([]);
        }

        if (data.kb_documents &amp;&amp; data.kb_documents.length > 0) {
          console.log(`ğŸ’¡ ì¶”ì²œ ì†”ë£¨ì…˜ ${data.kb_documents.length}ê°œ í‘œì‹œ`);
          displaySuggestedSolutions(data.kb_documents);
        } else {
          console.log("ğŸ’¡ ë°±ì—”ë“œì—ì„œ ì¶”ì²œ ì†”ë£¨ì…˜ ì—†ìŒ, ë¹ˆ ìƒíƒœ í‘œì‹œ");
          displaySuggestedSolutions([]);
        }
      } else {
        console.error("âŒ ë°±ì—”ë“œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", response.status);
        // í´ë°±: Freshdesk API ì‚¬ìš©
        console.log("ğŸ”„ ë°±ì—”ë“œ ì‹¤íŒ¨, Freshdesk API í´ë°± ì‚¬ìš©");
        updateTicketInfo(basicTicketInfo);
        await loadSimilarTicketsFromFreshdesk(basicTicketInfo);
        displaySuggestedSolutions(generateMockSolutions());

        // ìºì‹œ ì´ˆê¸°í™”
        globalTicketData = {
          summary: null,
          similar_tickets: [],
          recommended_solutions: [],
          cached_ticket_id: basicTicketInfo.id,
          ticket_info: basicTicketInfo,
          isLoading: false,
          lastLoadTime: Date.now(),
        };
      }
    } finally {
      // ë¡œë”© ìƒíƒœ í•´ì œ
      globalTicketData.isLoading = false;
    }
  } catch (error) {
    console.error("âŒ ë°±ì—”ë“œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", error);
    globalTicketData.isLoading = false;

    // í´ë°± ì²˜ë¦¬
    try {
      console.log("ğŸ”„ ì˜ˆì™¸ ë°œìƒìœ¼ë¡œ ì¸í•œ í´ë°± ì²˜ë¦¬");
      updateTicketInfo(basicTicketInfo);
      await loadSimilarTicketsFromFreshdesk(basicTicketInfo);
      displaySuggestedSolutions(generateMockSolutions());
    } catch (fallbackError) {
      console.error("âŒ í´ë°± ì²˜ë¦¬ë„ ì‹¤íŒ¨:", fallbackError);
    }
  }
}

/**
 * ë°±ì—”ë“œì—ì„œ ìœ ì‚¬ í‹°ì¼“ì„ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
 * @param {Object} ticket - í‹°ì¼“ ì •ë³´
 */
async function loadSimilarTicketsFromBackend(ticket) {
  try {
    console.log("ğŸ” ìœ ì‚¬ í‹°ì¼“ ê²€ìƒ‰ ì‹œì‘");

    // ìºì‹œëœ ë°ì´í„°ê°€ ìˆê³  ê°™ì€ í‹°ì¼“ì¸ ê²½ìš° ì¬ì‚¬ìš©
    if (
      globalTicketData.cached_ticket_id === ticket.id &amp;&amp;
      globalTicketData.similar_tickets.length > 0
    ) {
      console.log("ğŸ”„ ìºì‹œëœ ìœ ì‚¬ í‹°ì¼“ ë°ì´í„° ì‚¬ìš©");
      displaySimilarTickets(globalTicketData.similar_tickets);
      return;
    }

    console.log(
      "âš ï¸ ìœ ì‚¬ í‹°ì¼“ì´ ìºì‹œì— ì—†ìŒ - /init ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì´ë¯¸ ë°›ì•˜ì–´ì•¼ í•˜ëŠ” ë°ì´í„°"
    );

    // /init ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì´ë¯¸ ëª¨ë“  ë°ì´í„°ë¥¼ ë°›ì•˜ì–´ì•¼ í•˜ë¯€ë¡œ,
    // ë³„ë„ API í˜¸ì¶œ ëŒ€ì‹  Freshdesk API í´ë°± ì‚¬ìš©
    console.log("ğŸ”„ Freshdesk API í´ë°± ì‚¬ìš©");
    await loadSimilarTicketsFromFreshdesk(ticket);
  } catch (error) {
    console.error("âŒ ë°±ì—”ë“œ ì—°ê²° ì˜¤ë¥˜:", error);
    // í´ë°±: Freshdesk API ì‚¬ìš©
    await loadSimilarTicketsFromFreshdesk(ticket);
  }
}

/**
 * iparamsì—ì„œ Freshdesk ì„¤ì •ê°’ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
 * @param {Object} client - FDK í´ë¼ì´ì–¸íŠ¸ ê°ì²´
 * @returns {Promise&lt;Object|null>} Freshdesk ì„¤ì • ì •ë³´
 */
async function getFreshdeskConfigFromIparams(client) {
  try {
    console.log("ğŸ”§ iparamsì—ì„œ Freshdesk ì„¤ì •ê°’ ê°€ì ¸ì˜¤ê¸° ì‹œì‘");

    // FDKì˜ iparams APIë¥¼ í†µí•´ ì„¤ì •ê°’ ì¡°íšŒ
    const iparams = await client.iparams.get();

    if (!iparams) {
      console.warn("âš ï¸ iparams ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return null;
    }

    const config = {
      domain: iparams.freshdesk_domain,
      apiKey: iparams.freshdesk_api_key,
      backendUrl: iparams.backend_url,
      companyId: iparams.company_id,
    };

    console.log("âœ… iparams ì„¤ì •ê°’ ì¡°íšŒ ì™„ë£Œ:", {
      domain: config.domain ? "âœ“" : "âœ—",
      apiKey: config.apiKey ? "âœ“" : "âœ—",
      backendUrl: config.backendUrl ? "âœ“" : "âœ—",
      companyId: config.companyId ? "âœ“" : "âœ—",
    });

    // ìŠ¤ë§ˆíŠ¸ ë„ë©”ì¸ íŒŒì‹± (í”„ë¡ íŠ¸ì—”ë“œì—ì„œë„ ì ìš©)
    if (config.domain) {
      config.normalizedDomain = smartDomainParsingFrontend(config.domain);
      console.log(
        `ğŸ”„ ë„ë©”ì¸ ì •ê·œí™”: ${config.domain} â†’ ${config.normalizedDomain}`
      );
    }

    return config;
  } catch (error) {
    console.error("âŒ iparams ì„¤ì •ê°’ ì¡°íšŒ ì‹¤íŒ¨:", error);
    return null;
  }
}

/**
 * í”„ë¡ íŠ¸ì—”ë“œìš© ìŠ¤ë§ˆíŠ¸ ë„ë©”ì¸ íŒŒì‹± í•¨ìˆ˜
 * @param {string} inputDomain - ì…ë ¥ ë„ë©”ì¸
 * @returns {string} ì •ê·œí™”ëœ ë„ë©”ì¸
 */
function smartDomainParsingFrontend(inputDomain) {
  if (!inputDomain || !inputDomain.trim()) {
    throw new Error("ë„ë©”ì¸ ì…ë ¥ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
  }

  let domain = inputDomain.trim().toLowerCase();

  // URL í˜•íƒœì¸ ê²½ìš° ë„ë©”ì¸ ë¶€ë¶„ë§Œ ì¶”ì¶œ
  if (domain.startsWith("http://") || domain.startsWith("https://")) {
    try {
      const url = new URL(domain);
      domain = url.hostname;
    } catch (e) {
      throw new Error(`URL íŒŒì‹± ì‹¤íŒ¨: ${domain}`);
    }
  }

  // ì´ë¯¸ ì™„ì „í•œ .freshdesk.com ë„ë©”ì¸ì¸ ê²½ìš°
  if (domain.endsWith(".freshdesk.com")) {
    const companyId = domain.replace(".freshdesk.com", "");
    if (!companyId || companyId.length &lt; 2) {
      throw new Error(`ìœ íš¨í•˜ì§€ ì•Šì€ company_id: ${companyId}`);
    }
    return domain;
  }

  // company_idë§Œ ì…ë ¥ëœ ê²½ìš°
  if (domain.length &lt; 2) {
    throw new Error(`company_idê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤: ${domain}`);
  }

  // íŠ¹ìˆ˜ë¬¸ì ê²€ì¦ (ê¸°ë³¸ì ì¸ ì²´í¬)
  if (!/^[a-z0-9\-]+$/.test(domain)) {
    throw new Error(
      `company_idì— í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤: ${domain}`
    );
  }

  return `${domain}.freshdesk.com`;
}

/**
 * ë„ë©”ì¸ì—ì„œ company_idë¥¼ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
 * @param {string} domain - Freshdesk ë„ë©”ì¸
 * @returns {string} company_id
 */
function extractCompanyIdFromDomain(domain) {
  if (!domain) {
    return "";
  }

  // ì´ë¯¸ company_idë§Œ ìˆëŠ” ê²½ìš°
  if (!domain.includes(".")) {
    return domain;
  }

  // .freshdesk.comì—ì„œ company_id ì¶”ì¶œ
  if (domain.endsWith(".freshdesk.com")) {
    return domain.replace(".freshdesk.com", "");
  }

  return domain.split(".")[0];
}

/**
 * ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ê²°ê³¼ ì˜ì—­ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
 * @param {string} message - ì—ëŸ¬ ë©”ì‹œì§€
 * @param {string} containerId - ì»¨í…Œì´ë„ˆ ID
 */
function showErrorInResults(
  message,
  containerId = "similar-tickets-list"
) {
  try {
    const container = document.getElementById(containerId);
    if (container) {
      container.innerHTML = `
        &lt;div class="error-message alert alert-warning">
          &lt;i class="fas fa-exclamation-triangle">&lt;/i>
          ${message}
        &lt;/div>
      `;
    } else {
      console.warn(`âš ï¸ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${containerId}`);
    }
  } catch (error) {
    console.error("âŒ showErrorInResults ì˜¤ë¥˜", error);
  }
}

/**
 * ë¡œë”© ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
 * @param {string} containerId - ì»¨í…Œì´ë„ˆ ID
 */
function showLoadingInResults(containerId = "similar-tickets-list") {
  try {
    const container = document.getElementById(containerId);
    if (container) {
      container.innerHTML = `
        &lt;div class="loading-message">
          &lt;i class="fas fa-spinner fa-spin">&lt;/i>
          ë¡œë”© ì¤‘...
        &lt;/div>
      `;
    } else {
      console.warn(`âš ï¸ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${containerId}`);
    }
  } catch (error) {
    console.error("âŒ showLoadingInResults ì˜¤ë¥˜", error);
  }
}

// API í˜¸ì¶œ í•¨ìˆ˜ë“¤ì— ì—ëŸ¬ ì²˜ë¦¬ ë³´ê°•
window.API = {
  ...window.API,

  // Freshdesk API ì—°ê²° í…ŒìŠ¤íŠ¸
  async testConnection() {
    try {
      const response = await this.makeRequest('/api/test');
      console.log('[API] ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ:', response);
      return response;
    } catch (error) {
      console.error('[API] ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
      GlobalState.ErrorHandler.handleError(error, {
        context: 'api_connection_test',
        userMessage: 'API ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
      });
      throw error;
    }
  },

  // ë°±ì—”ë“œ API ìš”ì²­ ê¸°ë³¸ í•¨ìˆ˜
  async makeRequest(endpoint, options = {}) {
    try {
      const baseUrl = 'http://localhost:8000';
      const url = `${baseUrl}${endpoint}`;
      
      const defaultOptions = {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        ...options
      };

      console.log(`[API] ìš”ì²­ ì‹œì‘: ${defaultOptions.method} ${url}`);
      
      const response = await fetch(url, defaultOptions);
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errorText}`);
      }

      const data = await response.json();
      console.log(`[API] ìš”ì²­ ì™„ë£Œ: ${url}`, data);
      return data;
      
    } catch (error) {
      console.error(`[API] ìš”ì²­ ì‹¤íŒ¨: ${endpoint}`, error);
      
      // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ê°ì§€
      if (error.name === 'TypeError' &amp;&amp; error.message.includes('fetch')) {
        GlobalState.ErrorHandler.handleError(error, {
          context: 'api_network_error',
          userMessage: 'API ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'
        });
      } else {
        GlobalState.ErrorHandler.handleError(error, {
          context: 'api_request_error',
          userMessage: 'API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
        });
      }
      
      throw error;
    }
  },
};

// ì˜ì¡´ì„± í™•ì¸ í•¨ìˆ˜ - ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ API ëª¨ë“ˆ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬
API.isAvailable = function() {
  return typeof GlobalState !== 'undefined';
};

console.log('ğŸ“¡ API ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ - 8ê°œ í•¨ìˆ˜ exportë¨');

// ëª¨ë“ˆ ì˜ì¡´ì„± ì‹œìŠ¤í…œì— ë“±ë¡
if (typeof ModuleDependencyManager !== 'undefined') {
  ModuleDependencyManager.registerModule('api', Object.keys(API).length);
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="global.html#API">API</a></li><li><a href="Data.html">Data</a></li><li><a href="DebugTools.html">DebugTools</a></li><li><a href="Events.html">Events</a></li><li><a href="GlobalState.html">GlobalState</a></li><li><a href="ModuleDependencyManager.html">ModuleDependencyManager</a></li><li><a href="UI.html">UI</a></li><li><a href="Utils.html">Utils</a></li></ul><h3>Global</h3><ul><li><a href="global.html#callBackendAPI">callBackendAPI</a></li><li><a href="global.html#client">client</a></li><li><a href="global.html#debugGlobalState">debugGlobalState</a></li><li><a href="global.html#extractCompanyIdFromDomain">extractCompanyIdFromDomain</a></li><li><a href="global.html#getFreshdeskConfigFromIparams">getFreshdeskConfigFromIparams</a></li><li><a href="global.html#getGlobalLoading">getGlobalLoading</a></li><li><a href="global.html#getGlobalTicketData">getGlobalTicketData</a></li><li><a href="global.html#getInitialized">getInitialized</a></li><li><a href="global.html#globalTicketData">globalTicketData</a></li><li><a href="global.html#initializeApp">initializeApp</a></li><li><a href="global.html#isGlobalDataValid">isGlobalDataValid</a></li><li><a href="global.html#isInitialized">isInitialized</a></li><li><a href="global.html#loadInitialDataFromBackend">loadInitialDataFromBackend</a></li><li><a href="global.html#loadSimilarTicketsFromBackend">loadSimilarTicketsFromBackend</a></li><li><a href="global.html#resetGlobalTicketCache">resetGlobalTicketCache</a></li><li><a href="global.html#setGlobalLoading">setGlobalLoading</a></li><li><a href="global.html#setInitialized">setInitialized</a></li><li><a href="global.html#showErrorInResults">showErrorInResults</a></li><li><a href="global.html#showLoadingInResults">showLoadingInResults</a></li><li><a href="global.html#smartDomainParsingFrontend">smartDomainParsingFrontend</a></li><li><a href="global.html#updateGlobalTicketData">updateGlobalTicketData</a></li><li><a href="global.html#validateAndInitializeApp">validateAndInitializeApp</a></li><li><a href="global.html#validateGlobalState">validateGlobalState</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Mon Jun 16 2025 23:16:45 GMT+0900 (ëŒ€í•œë¯¼êµ­ í‘œì¤€ì‹œ)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
