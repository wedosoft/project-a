<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: api.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: api.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Optimized API module for Freshdesk Custom App backend communication
 * @description ğŸš€ ìµœì í™”ëœ API ëª¨ë“ˆ (api.js) - Freshdesk Custom App ë°±ì—”ë“œ API í†µì‹  ë° ì„±ëŠ¥ ìµœì í™”
 * 
 * Main features:
 * ì£¼ìš” ê¸°ëŠ¥:
 * - Caching and memoization support / ìºì‹± ë° ë©”ëª¨ì´ì œì´ì…˜ ì§€ì›
 * - Batch API call processing / ë°°ì¹˜ API í˜¸ì¶œ ì²˜ë¦¬
 * - Retry logic with exponential backoff / ì¬ì‹œë„ ë¡œì§ ë° ì§€ìˆ˜ì  ë°±ì˜¤í”„
 * - Performance monitoring and metrics collection / ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë° ë©”íŠ¸ë¦­ ìˆ˜ì§‘
 * - Smart loading state management / ìŠ¤ë§ˆíŠ¸ ë¡œë”© ìƒíƒœ ê´€ë¦¬
 * 
 * @author We Do Soft Inc.
 * @since 2025.06.16
 * @version 3.0.0 (ì„±ëŠ¥ ìµœì í™” ë° ìºì‹± ê°•í™”)
 * @namespace API
 */

/**
 * ğŸ”— iparamsì—ì„œ Freshdesk ì„¤ì •ê°’ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
 * ê³ ê°ì‚¬ë³„ë¡œ ë‹¤ë¥¸ ë„ë©”ì¸ê³¼ API í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ë¡œë“œí•˜ì—¬ ë©€í‹°í…Œë„ŒíŠ¸ í™˜ê²½ ì§€ì›
 */
async function getFreshdeskConfigFromIparams(client) {
  try {
    console.log("ğŸ“‹ iparamsì—ì„œ Freshdesk ì„¤ì •ê°’ ë¡œë“œ ì¤‘...");
    
    const iparams = await client.iparams.get();
    
    if (iparams &amp;&amp; iparams.freshdesk_domain &amp;&amp; iparams.freshdesk_api_key) {
      console.log(`âœ… iparams ë¡œë“œ ì„±ê³µ: ë„ë©”ì¸ ${iparams.freshdesk_domain}`);
      return {
        domain: iparams.freshdesk_domain,
        apiKey: iparams.freshdesk_api_key
      };
    }
    
    console.warn("âš ï¸ iparamsì—ì„œ í•„ìˆ˜ ì„¤ì •ê°’ì´ ëˆ„ë½ë¨");
    return null;
    
  } catch (error) {
    console.error("âŒ iparams ë¡œë“œ ì‹¤íŒ¨:", error);
    return null;
  }
}

/**
 * ìµœì í™”ëœ API ëª¨ë“ˆ
 */
const API = {
  /**
   * ëª¨ë“ˆ ê°€ìš©ì„± í™•ì¸
   */
  isAvailable() {
    const dependencies = ['GlobalState', 'PerformanceOptimizer'];
    const missing = dependencies.filter(dep => !window[dep]);
    
    if (missing.length > 0) {
      console.warn('[API] ëˆ„ë½ëœ ì˜ì¡´ì„±:', missing);
      return false;
    }
    
    console.log('[API] ìµœì í™”ëœ ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ (ìºì‹±, ë°°ì¹˜ ì²˜ë¦¬, ì¬ì‹œë„ ì§€ì›)');
    return true;
  },

  /**
   * ìºì‹œ í‚¤ ìƒì„±
   */
  generateCacheKey(endpoint, data, method) {
    const base = `${method}:${endpoint}`;
    if (data) {
      const dataHash = this.hashObject(data);
      return `${base}:${dataHash}`;
    }
    return base;
  },

  /**
   * ê°ì²´ í•´ì‹œ ìƒì„± (ê°„ë‹¨í•œ ìºì‹œ í‚¤ìš©)
   */
  hashObject(obj) {
    const str = JSON.stringify(obj);
    let hash = 0;
    for (let i = 0; i &lt; str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash &lt;&lt; 5) - hash) + char;
      hash = hash &amp; hash; // 32bit ì •ìˆ˜ë¡œ ë³€í™˜
    }
    return hash.toString(36);
  },

  /**
   * ì§€ì—° í•¨ìˆ˜
   */
  delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  },

  /**
   * ë°°ì¹˜ API í˜¸ì¶œ ì§€ì›
   * ì—¬ëŸ¬ API í˜¸ì¶œì„ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬
   */
  async batchAPICall(client, requests, options = {}) {
    const { concurrency = 3, delay = 100 } = options;
    const results = [];
    
    console.log(`[API ë°°ì¹˜] ${requests.length}ê°œ ìš”ì²­ì„ ${concurrency}ê°œì”© ì²˜ë¦¬`);
    
    for (let i = 0; i &lt; requests.length; i += concurrency) {
      const batch = requests.slice(i, i + concurrency);
      
      const batchPromises = batch.map(async (request, index) => {
        try {
          // ì§€ì—° ì²˜ë¦¬ë¡œ ì„œë²„ ë¶€í•˜ ë¶„ì‚°
          if (index > 0) {
            await this.delay(delay);
          }
          
          const result = await this.callBackendAPIWithCache(
            client, 
            request.endpoint, 
            request.data, 
            request.method,
            { ...request.options, showLoading: false }
          );
          
          return { index: i + index, success: true, data: result };
        } catch (error) {
          return { 
            index: i + index, 
            success: false, 
            error: error.message,
            request: request
          };
        }
      });
      
      const batchResults = await Promise.allSettled(batchPromises);
      results.push(...batchResults.map(r => r.value || r.reason));
      
      // ë°°ì¹˜ ê°„ ì§€ì—°
      if (i + concurrency &lt; requests.length) {
        await this.delay(delay * 2);
      }
    }
    
    const successful = results.filter(r => r.success).length;
    const failed = results.filter(r => !r.success).length;
    
    console.log(`[API ë°°ì¹˜] ì™„ë£Œ: ì„±ê³µ ${successful}ê°œ, ì‹¤íŒ¨ ${failed}ê°œ`);
    
    return results;
  },

  /**
   * ìºì‹± ì§€ì› ë°±ì—”ë“œ API í˜¸ì¶œ
   */
  async callBackendAPIWithCache(client, endpoint, data = null, method = "GET", options = {}) {
    const cacheKey = this.generateCacheKey(endpoint, data, method);
    
    // GET ìš”ì²­ê³¼ ëª…ì‹œì ìœ¼ë¡œ ìºì‹œë¥¼ í—ˆìš©í•œ ê²½ìš°ë§Œ ìºì‹œ í™•ì¸
    if ((method === "GET" || options.useCache) &amp;&amp; options.bypassCache !== true) {
      const cached = window.PerformanceOptimizer.getCachedApiResult(cacheKey);
      if (cached) {
        console.log(`[API ìºì‹œ] ${method} /${endpoint} - ìºì‹œ ì ì¤‘`);
        return cached;
      }
    }
    
    // ì¬ì‹œë„ ë¡œì§
    const maxRetries = options.maxRetries || 2;
    let lastError;
    
    for (let attempt = 0; attempt &lt;= maxRetries; attempt++) {
      try {
        const result = await this.performAPICall(client, endpoint, data, method, {
          ...options,
          attempt: attempt + 1,
          maxRetries: maxRetries + 1
        });
        
        // ì„±ê³µí•œ ê²°ê³¼ ìºì‹± (GET ìš”ì²­ ë˜ëŠ” ëª…ì‹œì  í—ˆìš©)
        if ((method === "GET" || options.useCache) &amp;&amp; result.ok) {
          const ttl = options.cacheTTL || 300000; // ê¸°ë³¸ 5ë¶„
          window.PerformanceOptimizer.cacheApiResult(cacheKey, result, ttl);
        }
        
        return result;
        
      } catch (error) {
        lastError = error;
        
        // 4xx ì—ëŸ¬ëŠ” ì¬ì‹œë„í•˜ì§€ ì•ŠìŒ
        if (error.status >= 400 &amp;&amp; error.status &lt; 500) {
          break;
        }
        
        // ë§ˆì§€ë§‰ ì‹œë„ê°€ ì•„ë‹ˆë©´ ì¬ì‹œë„
        if (attempt &lt; maxRetries) {
          const delayTime = 1000 * Math.pow(2, attempt); // ì§€ìˆ˜ì  ë°±ì˜¤í”„
          console.warn(`[API ì¬ì‹œë„] ${method} /${endpoint} - ${error.message}, ${delayTime}ms í›„ ì¬ì‹œë„`);
          await this.delay(delayTime);
          continue;
        }
      }
    }
    
    throw lastError;
  },

  /**
   * ì‹¤ì œ API í˜¸ì¶œ ìˆ˜í–‰
   */
  async performAPICall(client, endpoint, data, method, options = {}) {
    let loadingId = null;
    
    try {
      console.log(`ğŸš€ ë°±ì—”ë“œ API í˜¸ì¶œ: ${method} /${endpoint} ${options.attempt ? `(${options.attempt}/${options.maxRetries})` : ''}`);

      // ë¡œë”© ìƒíƒœ í‘œì‹œ
      if (options.showLoading !== false) {
        const loadingMessage = method === "GET" ? "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..." : "ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘...";
        const retryText = options.attempt > 1 ? ` (ì¬ì‹œë„ ${options.attempt-1})` : '';
        if (window.UI &amp;&amp; window.UI.showLoading) {
          window.UI.showLoading(`${loadingMessage}${retryText}`);
          loadingId = 'api-call';
        }
      }

      // iparamsì—ì„œ Freshdesk ì„¤ì •ê°’ ê°€ì ¸ì˜¤ê¸°
      const config = await getFreshdeskConfigFromIparams(client);

      if (!config || !config.domain || !config.apiKey) {
        console.warn("âš ï¸ iparamsì—ì„œ Freshdesk ì„¤ì •ê°’ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í™˜ê²½ë³€ìˆ˜ í´ë°± ì‹œë„...");
      }

      // ìš”ì²­ ì„¤ì •
      const requestOptions = {
        method: method,
        headers: {
          "Content-Type": "application/json",
          ...(config?.domain &amp;&amp; { "X-Freshdesk-Domain": config.domain }),
          ...(config?.apiKey &amp;&amp; { "X-Freshdesk-API-Key": config.apiKey })
        },
        ...(data &amp;&amp; { body: JSON.stringify(data) })
      };

      // ì„±ëŠ¥ ì¸¡ì •
      const performanceKey = `API-${method}-${endpoint}`;
      const startTime = performance.now();

      const response = await fetch(`http://localhost:8000/${endpoint}`, requestOptions);
      
      const endTime = performance.now();
      console.log(`[ì„±ëŠ¥] ${performanceKey}: ${(endTime - startTime).toFixed(2)}ms`);

      if (!response.ok) {
        const errorBody = await response.text();
        const error = new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
        error.status = response.status;
        error.body = errorBody;
        throw error;
      }

      const result = await response.json();
      
      return result;

    } catch (error) {
      if (window.GlobalState &amp;&amp; window.GlobalState.ErrorHandler) {
        window.GlobalState.ErrorHandler.handleError(error, {
          module: 'api',
          function: 'performAPICall',
          context: `${method} /${endpoint}`,
          severity: 'error',
          userMessage: 'ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'
        });
      }
      
      throw error;
      
    } finally {
      // ë¡œë”© ìƒíƒœ í•´ì œ
      if (loadingId &amp;&amp; options.showLoading !== false &amp;&amp; window.UI &amp;&amp; window.UI.hideLoading) {
        window.UI.hideLoading();
      }
    }
  },

  /**
   * ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ ë˜í¼ í•¨ìˆ˜
   */
  async callBackendAPI(client, endpoint, data = null, method = "GET") {
    return this.callBackendAPIWithCache(client, endpoint, data, method);
  },

  /**
   * ë°±ì—”ë“œì—ì„œ ì´ˆê¸° ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
   */
  async loadInitData(client, ticketId) {
    return this.callBackendAPIWithCache(
      client, 
      `init/${ticketId}`, 
      null, 
      "GET",
      { 
        cacheTTL: 600000, // 10ë¶„ ìºì‹œ
        loadingContext: "ì´ˆê¸° ë°ì´í„° ë¡œë“œ"
      }
    );
  },

  /**
   * ìì—°ì–´ ì¿¼ë¦¬ ì‹¤í–‰
   */
  async executeQuery(client, queryData) {
    return this.callBackendAPIWithCache(
      client,
      "query",
      queryData,
      "POST",
      {
        useCache: false, // POST ìš”ì²­ì€ ê¸°ë³¸ì ìœ¼ë¡œ ìºì‹œí•˜ì§€ ì•ŠìŒ
        loadingContext: "ì¿¼ë¦¬ ì‹¤í–‰"
      }
    );
  },

  /**
   * ëª¨ë“  í‹°ì¼“ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
   */
  async getAllTickets(client) {
    return this.callBackendAPIWithCache(
      client,
      "tickets/all",
      null,
      "GET",
      {
        cacheTTL: 900000, // 15ë¶„ ìºì‹œ
        loadingContext: "í‹°ì¼“ ëª©ë¡ ì¡°íšŒ"
      }
    );
  },

  /**
   * ìºì‹œ ê´€ë¦¬ í•¨ìˆ˜ë“¤
   */
  clearCache() {
    if (window.PerformanceOptimizer) {
      window.PerformanceOptimizer.resultCache.clear();
      console.log('[API] ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
  },

  getCacheStats() {
    return window.PerformanceOptimizer ? window.PerformanceOptimizer.getMemoryStats() : {};
  },

  /**
   * í”„ë¦¬í”Œë¼ì´íŠ¸ ì²´í¬ - API ì„œë²„ ìƒíƒœ í™•ì¸
   */
  async healthCheck() {
    try {
      const response = await fetch('http://localhost:8000/api/health', {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });
      
      return response.ok;
    } catch (error) {
      console.warn('[API] ì„œë²„ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error.message);
      return false;
    }
  }
};

// ì˜ì¡´ì„± í™•ì¸ í•¨ìˆ˜
API.isAvailable = function() {
  const dependencies = ['GlobalState'];
  const missing = dependencies.filter(dep => typeof window[dep] === 'undefined');
  
  if (missing.length > 0) {
    console.warn('[API] ëˆ„ë½ëœ ì˜ì¡´ì„±:', missing);
    return false;
  }
  
  return true;
};

console.log('ğŸ“¡ ìµœì í™”ëœ API ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ - í–¥ìƒëœ ì„±ëŠ¥ ë° ìºì‹± ì§€ì›');

// ëª¨ë“ˆ ì˜ì¡´ì„± ì‹œìŠ¤í…œì— ë“±ë¡
if (typeof window.ModuleDependencyManager !== 'undefined') {
  window.ModuleDependencyManager.registerModule('api', Object.keys(API).length);
}

// ì „ì—­ìœ¼ë¡œ export
window.API = API;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="global.html#API">API</a></li><li><a href="Data.html">Data</a></li><li><a href="DebugTools.html">DebugTools</a></li><li><a href="Events.html">Events</a></li><li><a href="GlobalState.html">GlobalState</a></li><li><a href="ModuleDependencyManager.html">ModuleDependencyManager</a></li><li><a href="UI.html">UI</a></li><li><a href="Utils.html">Utils</a></li></ul><h3>Global</h3><ul><li><a href="global.html#callBackendAPI">callBackendAPI</a></li><li><a href="global.html#client">client</a></li><li><a href="global.html#debugGlobalState">debugGlobalState</a></li><li><a href="global.html#extractCompanyIdFromDomain">extractCompanyIdFromDomain</a></li><li><a href="global.html#getFreshdeskConfigFromIparams">getFreshdeskConfigFromIparams</a></li><li><a href="global.html#getGlobalLoading">getGlobalLoading</a></li><li><a href="global.html#getGlobalTicketData">getGlobalTicketData</a></li><li><a href="global.html#getInitialized">getInitialized</a></li><li><a href="global.html#globalTicketData">globalTicketData</a></li><li><a href="global.html#initializeApp">initializeApp</a></li><li><a href="global.html#isGlobalDataValid">isGlobalDataValid</a></li><li><a href="global.html#isInitialized">isInitialized</a></li><li><a href="global.html#loadInitialDataFromBackend">loadInitialDataFromBackend</a></li><li><a href="global.html#loadSimilarTicketsFromBackend">loadSimilarTicketsFromBackend</a></li><li><a href="global.html#resetGlobalTicketCache">resetGlobalTicketCache</a></li><li><a href="global.html#setGlobalLoading">setGlobalLoading</a></li><li><a href="global.html#setInitialized">setInitialized</a></li><li><a href="global.html#showErrorInResults">showErrorInResults</a></li><li><a href="global.html#showLoadingInResults">showLoadingInResults</a></li><li><a href="global.html#smartDomainParsingFrontend">smartDomainParsingFrontend</a></li><li><a href="global.html#updateGlobalTicketData">updateGlobalTicketData</a></li><li><a href="global.html#validateAndInitializeApp">validateAndInitializeApp</a></li><li><a href="global.html#validateGlobalState">validateGlobalState</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Mon Jun 16 2025 23:16:45 GMT+0900 (ëŒ€í•œë¯¼êµ­ í‘œì¤€ì‹œ)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
