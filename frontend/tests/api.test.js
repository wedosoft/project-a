/**
 * api.js Î™®Îìà ÌÖåÏä§Ìä∏
 * 
 * ÏµúÏ†ÅÌôîÎêú API Ìò∏Ï∂ú, Ï∫êÏã±, Ïû¨ÏãúÎèÑ Î°úÏßÅ, Î∞∞Ïπò Ï≤òÎ¶¨ Îì±
 * API Î™®ÎìàÏùò ÌïµÏã¨ Í∏∞Îä•Îì§ÏùÑ ÌÖåÏä§Ìä∏Ìï©ÎãàÎã§.
 */

// ÌÖåÏä§Ìä∏ ÎåÄÏÉÅ Î™®Îìà Î°úÎìú
require('../app/scripts/globals.js');
require('../app/scripts/api.js');

describe('üöÄ API Î™®Îìà', () => {
  let api;

  beforeEach(() => {
    api = window.API;
    
    // Í∞Å ÌÖåÏä§Ìä∏ Ï†ÑÏóê Î™®ÌÇπ Ï¥àÍ∏∞Ìôî
    jest.clearAllMocks();
    
    // PerformanceOptimizer Î™®ÌÇπ
    if (!window.PerformanceOptimizer) {
      window.PerformanceOptimizer = {
        getCachedApiResult: jest.fn(),
        cacheApiResult: jest.fn(),
        clearAllCaches: jest.fn(),
        getMemoryStats: jest.fn(() => ({
          cacheStats: { hits: 0, misses: 0 }
        }))
      };
    }
  });

  test('Î™®Îìà Í∞ÄÏö©ÏÑ± ÌôïÏù∏Ïù¥ Ï†ïÏÉÅ ÎèôÏûëÌï¥Ïïº Ìï®', () => {
    expect(api.isAvailable()).toBe(true);
  });

  test('Ï∫êÏãú ÌÇ§ ÏÉùÏÑ±Ïù¥ Ïò¨Î∞îÎ•¥Í≤å ÎèôÏûëÌï¥Ïïº Ìï®', () => {
    const key1 = api.generateCacheKey('test-endpoint', null, 'GET');
    const key2 = api.generateCacheKey('test-endpoint', { param: 'value' }, 'POST');
    
    expect(key1).toContain('GET:test-endpoint');
    expect(key2).toContain('POST:test-endpoint');
    expect(key1).not.toBe(key2);
  });

  test('Í∞ùÏ≤¥ Ìï¥Ïãú ÏÉùÏÑ±Ïù¥ ÎèôÏùºÌïú Í∞ùÏ≤¥Ïóê ÎåÄÌï¥ ÎèôÏùºÌïú Ìï¥ÏãúÎ•º ÏÉùÏÑ±Ìï¥Ïïº Ìï®', () => {
    const obj1 = { a: 1, b: 2 };
    const obj2 = { a: 1, b: 2 };
    const obj3 = { a: 1, b: 3 };
    
    const hash1 = api.hashObject(obj1);
    const hash2 = api.hashObject(obj2);
    const hash3 = api.hashObject(obj3);
    
    expect(hash1).toBe(hash2);
    expect(hash1).not.toBe(hash3);
  });

  test('Ìó¨Ïä§Ï≤¥ÌÅ¨Í∞Ä Ï†ïÏÉÅ ÎèôÏûëÌï¥Ïïº Ìï®', async () => {
    // ÏÑ±Í≥µ ÏùëÎãµ Î™®ÌÇπ
    testUtils.mockFetchResponse({ status: 'healthy' }, 200);
    
    const result = await api.healthCheck();
    expect(result).toBe(true);
    expect(fetch).toHaveBeenCalledWith('http://localhost:8000/health', {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' }
    });
  });

  test('Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå® Ïãú falseÎ•º Î∞òÌôòÌï¥Ïïº Ìï®', async () => {
    // Ïã§Ìå® ÏùëÎãµ Î™®ÌÇπ
    testUtils.mockFetchError(new Error('Network error'));
    
    const result = await api.healthCheck();
    expect(result).toBe(false);
  });

  test('Ï∫êÏãúÎêú API Ìò∏Ï∂úÏù¥ Ï†ïÏÉÅ ÎèôÏûëÌï¥Ïïº Ìï®', async () => {
    const mockClient = global.app;
    const testData = { result: 'test' };
    
    // Ï∫êÏãú ÎØ∏Ïä§ ÏãúÎÇòÎ¶¨Ïò§
    window.PerformanceOptimizer.getCachedApiResult.mockReturnValue(null);
    testUtils.mockFetchResponse(testData);
    
    const result = await api.callBackendAPIWithCache(
      mockClient, 
      'test-endpoint', 
      null, 
      'GET'
    );
    
    expect(result).toEqual(testData);
    expect(window.PerformanceOptimizer.cacheApiResult).toHaveBeenCalled();
  });

  test('Ï∫êÏãú ÌûàÌä∏ Ïãú ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠ ÏóÜÏù¥ Í≤∞Í≥ºÎ•º Î∞òÌôòÌï¥Ïïº Ìï®', async () => {
    const mockClient = global.app;
    const cachedData = { result: 'cached' };
    
    // Ï∫êÏãú ÌûàÌä∏ ÏãúÎÇòÎ¶¨Ïò§
    window.PerformanceOptimizer.getCachedApiResult.mockReturnValue(cachedData);
    
    const result = await api.callBackendAPIWithCache(
      mockClient,
      'test-endpoint',
      null,
      'GET'
    );
    
    expect(result).toEqual(cachedData);
    expect(fetch).not.toHaveBeenCalled();
  });

  test('Ïû¨ÏãúÎèÑ Î°úÏßÅÏù¥ Ï†ïÏÉÅ ÎèôÏûëÌï¥Ïïº Ìï®', async () => {
    const mockClient = global.app;
    
    // Ï≤´ Î≤àÏß∏, Îëê Î≤àÏß∏ Ìò∏Ï∂úÏùÄ Ïã§Ìå®, ÏÑ∏ Î≤àÏß∏Îäî ÏÑ±Í≥µ
    fetch
      .mockRejectedValueOnce(new Error('Network error'))
      .mockRejectedValueOnce(new Error('Network error'))
      .mockResolvedValueOnce({
        ok: true,
        status: 200,
        json: jest.fn().mockResolvedValue({ success: true })
      });
    
    window.PerformanceOptimizer.getCachedApiResult.mockReturnValue(null);
    
    const result = await api.callBackendAPIWithCache(
      mockClient,
      'test-endpoint',
      null,
      'GET',
      { maxRetries: 2 }
    );
    
    expect(result).toEqual({ success: true });
    expect(fetch).toHaveBeenCalledTimes(3);
  });

  test('4xx ÏóêÎü¨Îäî Ïû¨ÏãúÎèÑÌïòÏßÄ ÏïäÏïÑÏïº Ìï®', async () => {
    const mockClient = global.app;
    const error = new Error('Bad Request');
    error.status = 400;
    
    window.PerformanceOptimizer.getCachedApiResult.mockReturnValue(null);
    
    await expect(
      api.callBackendAPIWithCache(
        mockClient,
        'test-endpoint',
        null,
        'GET',
        { maxRetries: 2 }
      )
    ).rejects.toThrow();
    
    // 4xx ÏóêÎü¨Îäî Ïû¨ÏãúÎèÑÌïòÏßÄ ÏïäÏúºÎØÄÎ°ú fetchÍ∞Ä 1Î≤àÎßå Ìò∏Ï∂úÎêòÏñ¥Ïïº Ìï®
    expect(fetch).toHaveBeenCalledTimes(1);
  });

  test('Î∞∞Ïπò API Ìò∏Ï∂úÏù¥ Ï†ïÏÉÅ ÎèôÏûëÌï¥Ïïº Ìï®', async () => {
    const mockClient = global.app;
    const requests = [
      { endpoint: 'endpoint1', data: null, method: 'GET' },
      { endpoint: 'endpoint2', data: null, method: 'GET' },
      { endpoint: 'endpoint3', data: null, method: 'GET' }
    ];
    
    // Î™®Îì† ÏöîÏ≤≠Ïù¥ ÏÑ±Í≥µÌïòÎèÑÎ°ù Î™®ÌÇπ
    window.PerformanceOptimizer.getCachedApiResult.mockReturnValue(null);
    testUtils.mockFetchResponse({ success: true });
    testUtils.mockFetchResponse({ success: true });
    testUtils.mockFetchResponse({ success: true });
    
    const results = await api.batchAPICall(mockClient, requests, {
      concurrency: 2,
      delay: 10
    });
    
    expect(results).toHaveLength(3);
    expect(results.every(r => r.success)).toBe(true);
  });

  test('Î∞∞Ïπò API Ìò∏Ï∂úÏóêÏÑú ÏùºÎ∂Ä Ïã§Ìå® Ïãú Ï†ÅÏ†àÌûà Ï≤òÎ¶¨Ìï¥Ïïº Ìï®', async () => {
    const mockClient = global.app;
    const requests = [
      { endpoint: 'endpoint1', data: null, method: 'GET' },
      { endpoint: 'endpoint2', data: null, method: 'GET' }
    ];
    
    window.PerformanceOptimizer.getCachedApiResult.mockReturnValue(null);
    
    // Ï≤´ Î≤àÏß∏Îäî ÏÑ±Í≥µ, Îëê Î≤àÏß∏Îäî Ïã§Ìå®
    testUtils.mockFetchResponse({ success: true });
    testUtils.mockFetchError(new Error('API Error'));
    
    const results = await api.batchAPICall(mockClient, requests);
    
    expect(results).toHaveLength(2);
    expect(results[0].success).toBe(true);
    expect(results[1].success).toBe(false);
  });

  test('Ï∫êÏãú ÌÜµÍ≥Ñ Ï°∞ÌöåÍ∞Ä Ï†ïÏÉÅ ÎèôÏûëÌï¥Ïïº Ìï®', () => {
    const mockStats = {
      cacheStats: { hits: 10, misses: 5 },
      memoryUsage: '10 MB'
    };
    
    window.PerformanceOptimizer.getMemoryStats.mockReturnValue(mockStats);
    
    const stats = api.getCacheStats();
    expect(stats).toEqual(mockStats);
  });

  test('Ï∫êÏãú Ï¥àÍ∏∞ÌôîÍ∞Ä Ï†ïÏÉÅ ÎèôÏûëÌï¥Ïïº Ìï®', () => {
    api.clearCache();
    expect(window.PerformanceOptimizer.clearAllCaches).toHaveBeenCalled();
  });
});

describe('üîÑ API ÌÜµÌï© ÌÖåÏä§Ìä∏', () => {
  beforeEach(() => {
    // Ïã§Ï†ú Î™®ÎìàÎì§ Î°úÎìú
    require('../app/scripts/globals.js');
    require('../app/scripts/api.js');
  });

  test('Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏõåÌÅ¨ÌîåÎ°úÏö∞', async () => {
    const mockClient = {
      iparams: {
        get: jest.fn().mockResolvedValue({
          freshdesk_domain: 'test.freshdesk.com',
          freshdesk_api_key: 'test-key'
        })
      }
    };
    
    const mockInitData = {
      ticket_summary: { problem: 'Test problem' },
      similar_tickets: [],
      kb_documents: []
    };
    
    testUtils.mockFetchResponse(mockInitData);
    
    const result = await window.API.loadInitData(mockClient, '12345');
    
    expect(result).toEqual(mockInitData);
    expect(fetch).toHaveBeenCalledWith(
      'http://localhost:8000/init/12345',
      expect.objectContaining({
        method: 'GET',
        headers: expect.objectContaining({
          'X-Freshdesk-Domain': 'test.freshdesk.com',
          'X-Freshdesk-API-Key': 'test-key'
        })
      })
    );
  });

  test('ÏøºÎ¶¨ Ïã§Ìñâ ÏõåÌÅ¨ÌîåÎ°úÏö∞', async () => {
    const mockClient = {
      iparams: {
        get: jest.fn().mockResolvedValue({
          freshdesk_domain: 'test.freshdesk.com',
          freshdesk_api_key: 'test-key'
        })
      }
    };
    
    const queryData = {
      query: 'Î°úÍ∑∏Ïù∏ Î¨∏Ï†ú Ìï¥Í≤∞',
      type: ['tickets', 'solutions']
    };
    
    const mockResponse = {
      results: [
        { type: 'ticket', title: 'Similar issue' }
      ]
    };
    
    testUtils.mockFetchResponse(mockResponse);
    
    const result = await window.API.executeQuery(mockClient, queryData);
    
    expect(result).toEqual(mockResponse);
    expect(fetch).toHaveBeenCalledWith(
      'http://localhost:8000/query',
      expect.objectContaining({
        method: 'POST',
        body: JSON.stringify(queryData)
      })
    );
  });
});
