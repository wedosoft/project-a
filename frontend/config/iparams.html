<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Canvas - 관리자 설정</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        
        .main-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #343a40;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
            display: block;
        }
        
        .form-control {
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 10px 12px;
            font-size: 14px;
            transition: border-color 0.15s ease-in-out;
            width: 100%;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            outline: none;
        }
        
        .form-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background-color: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #5a6fd8;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid transparent;
        }
        
        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        .info-box {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-box h6 {
            margin: 0 0 10px 0;
            color: #0066cc;
            font-weight: 600;
        }
        
        .info-box p {
            margin: 0;
            font-size: 14px;
            color: #004499;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>🎨 Copilot Canvas 설정</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">RAG 기반 Freshdesk AI 어시스턴트</p>
        </div>
        
        <div class="content">
            <!-- 알림 영역 -->
            <div id="alertArea"></div>
            
            <!-- 안내 메시지 -->
            <div class="info-box">
                <h6>📋 설정 안내</h6>
                <p>AI 어시스턴트가 Freshdesk 데이터에 접근하기 위해 도메인과 API 키가 필요합니다. 이 정보는 안전하게 암호화되어 저장됩니다.</p>
            </div>
            
            <!-- 기본 연결 설정 섹션 -->
            <div class="section">
                <div class="section-title">🔗 Freshdesk 연결 설정</div>
                
                <div class="form-group">
                    <label class="form-label" for="freshdesk_domain">Freshdesk 도메인 *</label>
                    <input type="text" class="form-control" id="freshdesk_domain" 
                           placeholder="예: yourcompany.freshdesk.com"
                           value="" required>
                    <small class="form-text">귀하의 Freshdesk 도메인을 입력하세요 (https:// 제외)</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="freshdesk_api_key">Freshdesk API 키 *</label>
                    <input type="password" class="form-control" id="freshdesk_api_key" 
                           placeholder="API 키를 입력하세요"
                           value="" required>
                    <small class="form-text">Freshdesk 관리자 → API 설정에서 확인할 수 있습니다</small>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="testConnection()">
                    🔗 연결 테스트
                </button>
            </div>
            
            <!-- 도움말 섹션 -->
            <div class="section">
                <div class="section-title">❓ 도움말</div>
                
                <div class="info-box">
                    <h6>API 키 찾는 방법</h6>
                    <p>1. Freshdesk 관리자 페이지 접속<br>
                       2. 설정(Settings) → API 메뉴 선택<br>
                       3. "Your API Key" 섹션에서 키 복사<br>
                       4. 위 입력 필드에 붙여넣기</p>
                </div>
                
                <div class="info-box">
                    <h6>보안 정보</h6>
                    <p>• API 키는 Freshworks 보안 표준에 따라 암호화되어 저장됩니다<br>
                       • 이 정보는 AI 어시스턴트가 티켓과 지식베이스에 접근할 때만 사용됩니다<br>
                       • 언제든지 설정을 변경할 수 있습니다</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * 알림 메시지 표시
         */
        function showAlert(message, type = 'info') {
            const alertArea = document.getElementById('alertArea');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            
            alertArea.innerHTML = '';
            alertArea.appendChild(alertDiv);
            
            // 5초 후 자동 제거 (성공/정보 메시지만)
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
        }
        
        /**
         * 연결 테스트 (간소화된 버전)
         */
        async function testConnection() {
            const domain = document.getElementById('freshdesk_domain').value.trim();
            const apiKey = document.getElementById('freshdesk_api_key').value.trim();
            
            if (!domain || !apiKey) {
                showAlert('도메인과 API 키를 모두 입력해주세요.', 'danger');
                return;
            }
            
            // 도메인 형식 검증
            const normalizedDomain = smartDomainParsing(domain);
            if (!normalizedDomain) {
                showAlert('올바른 도메인 형식을 입력해주세요.', 'danger');
                return;
            }
            
            showAlert('연결을 테스트하고 있습니다...', 'info');
            
            try {
                // 기본적인 도메인 및 API 키 형식 검증
                if (apiKey.length < 10) {
                    throw new Error('API 키가 너무 짧습니다. 올바른 API 키를 입력해주세요.');
                }
                
                // 도메인 업데이트 (정규화된 버전으로)
                document.getElementById('freshdesk_domain').value = normalizedDomain;
                
                showAlert('✅ 설정이 유효합니다! 저장하려면 "설정 저장" 버튼을 클릭하세요.', 'success');
            } catch (error) {
                console.error('Connection test failed:', error);
                showAlert(`❌ 설정 오류: ${error.message}`, 'danger');
            }
        }
        
        /**
         * 스마트 도메인 파싱 함수
         */
        function smartDomainParsing(inputDomain) {
            if (!inputDomain || !inputDomain.trim()) {
                return null;
            }
            
            let domain = inputDomain.trim().toLowerCase();
            
            // URL 형태인 경우 도메인 부분만 추출
            if (domain.startsWith('http://') || domain.startsWith('https://')) {
                try {
                    const url = new URL(domain);
                    domain = url.hostname;
                } catch (e) {
                    return null;
                }
            }
            
            // 이미 완전한 .freshdesk.com 도메인인 경우
            if (domain.endsWith('.freshdesk.com')) {
                const companyId = domain.replace('.freshdesk.com', '');
                if (!companyId || companyId.length < 2) {
                    return null;
                }
                return domain;
            }
            
            // company_id만 입력된 경우
            if (domain.length < 2) {
                return null;
            }
            
            // 특수문자 검증 (기본적인 체크)
            if (!/^[a-z0-9\-]+$/.test(domain)) {
                return null;
            }
            
            // 예시 도메인 차단
            const invalidIds = ['example', 'test', 'demo', 'sample', 'company', 'your-company', 'default'];
            if (invalidIds.includes(domain)) {
                return null;
            }
            
            return domain + '.freshdesk.com';
        }

        /**
         * FDK 필수 메서드: 설정값을 로드할 때 호출됩니다
         */
        function getConfigs() {
            return {
                freshdesk_domain: document.getElementById('freshdesk_domain').value.trim() || '',
                freshdesk_api_key: document.getElementById('freshdesk_api_key').value.trim() || ''
            };
        }

        /**
         * FDK 필수 메서드: 설정을 저장할 때 호출됩니다
         */
        function postConfigs() {
            const domain = document.getElementById('freshdesk_domain').value.trim();
            const apiKey = document.getElementById('freshdesk_api_key').value.trim();

            // 필수 필드 확인
            if (!domain) {
                throw new Error('Freshdesk 도메인을 입력해주세요.');
            }

            if (!apiKey) {
                throw new Error('Freshdesk API 키를 입력해주세요.');
            }

            // 도메인 정규화
            const normalizedDomain = smartDomainParsing(domain);
            if (!normalizedDomain) {
                throw new Error('올바른 도메인 형식을 입력해주세요. (예: yourcompany.freshdesk.com)');
            }

            // API 키 기본 검증
            if (apiKey.length < 10) {
                throw new Error('API 키가 너무 짧습니다. 올바른 API 키를 입력해주세요.');
            }

            return {
                __meta: {
                    secure: ["freshdesk_api_key"] // API 키는 안전하게 저장
                },
                freshdesk_domain: normalizedDomain,
                freshdesk_api_key: apiKey
            };
        }
        
        /**
         * 페이지 로드 시 초기화
         */
        document.addEventListener('DOMContentLoaded', function() {
            showAlert('Freshdesk 연결 설정을 입력해주세요. API 키는 안전하게 암호화되어 저장됩니다.', 'info');
        });
    </script>
</body>
</html>