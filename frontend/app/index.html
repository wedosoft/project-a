<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copilot Canvas - AI 상담사 지원</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding: 0 0 10px 0;
            color: #1f2937;
            display: flex;
            justify-content: flex-end;
            line-height: 1.5;
            height: 100%;
            width: 100%;
            overflow: auto;
        }

        /* === FDK 응답 컨테이너 (필수) === */
        #fdk-response-container {
            width: 100%;
            height: 100%;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 모달 컨테이너 (네이티브 스타일) */
        .modal-container {
            width: 480px;
            height: calc(100vh - 10px);
            background: white;
            border-radius: 12px;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-left: 1px solid #e5e7eb;
            margin-bottom: 10px;
            position: relative;
        }

        /* 스마트 헤더 (얇은 헤더) */
        .smart-header {
            background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%);
            color: white;
            padding: 8px 20px;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ticket-meta {
            display: flex;
            gap: 10px;
            font-size: 12px;
        }

        .meta-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 메인 콘텐츠 */
        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-top: 60px; /* 헤더 높이만큼 패딩 추가 */
        }

        /* AI 요약 영역 (FDK 스타일) - 접기/펴기 처리 */
        .ai-summary-section {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            padding: 0;
            flex-shrink: 0;
            overflow: visible;
            transition: all 0.3s ease;
        }

        .ai-summary-section.collapsed {
            max-height: 0;
            border-bottom: none;
            opacity: 0;
        }

        .ai-summary-section.expanded {
            max-height: 500px;
            opacity: 1;
        }

        .summary-header {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-title i {
            color: #8B5CF6;
        }

        .summary-toggle-icon {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            min-width: 40px;
        }

        .summary-toggle-icon:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .summary-actions {
            display: flex;
            gap: 8px;
        }

        .summary-action-btn {
            background: white;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            color: #374151;
        }

        .summary-action-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .summary-content {
            padding: 16px 20px;
            transition: all 0.3s ease;
            /* 고정 높이 제거 - 콘텐츠 길이에 따라 자연스럽게 확장 */
        }

        .ai-summary-section.collapsed .summary-content {
            padding: 0 20px;
        }

        .main-summary .summary-text {
            font-size: 14px;
            line-height: 1.6;
            color: #374151;
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        /* 탭 네비게이션 (FDK 스타일) */
        .tab-navigation {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            padding: 0;
            flex-shrink: 0;
        }

        .tab-list {
            display: flex;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 13px;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            position: relative;
            white-space: nowrap;
            font-weight: 500;
            flex: 1;
            text-align: center;
        }

        .tab-button:hover {
            color: #374151;
            background-color: #f9fafb;
        }

        .tab-button.active {
            color: #8B5CF6;
            border-bottom-color: #8B5CF6;
            background-color: #faf5ff;
        }

        .tab-count {
            background-color: #e5e7eb;
            color: #6b7280;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }

        .tab-button.active .tab-count {
            background-color: #8B5CF6;
            color: white;
        }

        /* 카드 리스트 영역 */
        .card-list {
            padding: 16px 20px;
            /* flex와 overflow 제거 - 자연스러운 콘텐츠 흐름 */
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.2s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 인사이트 패널 (FDK 스타일) */
        .insight-panel {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }

        .insight-title {
            font-size: 12px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .insight-content {
            font-size: 11px;
            color: #92400e;
            line-height: 1.4;
        }

        /* 콘텐츠 카드 (FDK 스타일) */
        .content-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .content-card:hover {
            border-color: #8B5CF6;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
            transform: translateY(-1px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
        }

        .card-id {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
        }

        .similarity-score {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
        }

        .score-high { background: #10b981; }
        .score-medium { background: #f59e0b; }
        .score-low { background: #ef4444; }

        .card-body {
            padding: 12px 16px;
        }

        .card-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            line-height: 1.4;
            font-size: 14px;
        }

        .card-excerpt {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .meta-left {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .status-indicator {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }

        .status-resolved { background: #d1fae5; color: #065f46; }
        .status-progress { background: #dbeafe; color: #1e40af; }
        .status-pending { background: #fef3c7; color: #92400e; }

        .priority-indicator {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .card-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: #6b7280;
        }

        .card-btn.primary {
            background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%);
            color: white;
            border-color: #8B5CF6;
        }

        .card-btn:hover {
            background: #f3f4f6;
            border-color: #8B5CF6;
            color: #8B5CF6;
        }

        .card-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
        }

        /* Copilot 채팅 인터페이스 */
        .chat-mode-toggle {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 20px;
        }

        .mode-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .mode-toggle-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mode-label {
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            transition: color 0.2s;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .mode-label.active {
            color: #8B5CF6;
            font-weight: 600;
        }

        /* iOS 스타일 토글 스위치 - 더 작게 */
        .ios-toggle {
            position: relative;
            width: 42px;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            flex-shrink: 0;
        }

        .ios-toggle.active {
            background: #8B5CF6;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .ios-toggle.active .toggle-slider {
            transform: translateX(18px);
        }

        .mode-description {
            font-size: 11px;
            color: #9ca3af;
            font-style: italic;
            text-align: right;
            flex-shrink: 0;
        }

        /* 채팅 컨테이너 */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
            background: white;
        }

        /* 채팅 메시지 영역 */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-message {
            display: flex;
            gap: 12px;
            animation: messageSlideIn 0.3s ease-out;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            background: #f3f4f6;
        }

        .chat-message.user .message-avatar {
            background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%);
            color: white;
        }

        .message-content {
            flex: 1;
            max-width: 80%;
        }

        .message-text {
            background: #f9fafb;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            color: #374151;
            word-wrap: break-word;
        }

        .chat-message.user .message-text {
            background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
        }

        .chat-message.assistant .message-text {
            border-radius: 18px 18px 18px 4px;
        }

        .message-time {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
            text-align: right;
        }

        .chat-message.assistant .message-time {
            text-align: left;
        }

        /* 채팅 입력 영역 */
        .chat-input-container {
            border-top: 1px solid #e5e7eb;
            padding: 16px 20px;
            background: #fafbfc;
        }

        .chat-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            padding: 8px 16px;
            transition: all 0.2s;
        }

        .chat-input-wrapper:focus-within {
            border-color: #8B5CF6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        #chatInput {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-size: 14px;
            line-height: 1.5;
            color: #374151;
            background: transparent;
            padding: 8px 0;
            max-height: 100px;
            font-family: inherit;
        }

        #chatInput::placeholder {
            color: #9ca3af;
        }

        .send-button {
            background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            flex-shrink: 0;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .send-button:disabled {
            background: #e5e7eb;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 타이핑 인디케이터 */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #8B5CF6;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingDot {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* 채팅 스크롤바 */
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* 스트리밍 메시지 애니메이션 */
        .chat-message.streaming .message-text::after {
            content: '▋';
            animation: blink 1s infinite;
            color: #8B5CF6;
            font-weight: normal;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* 마크다운 렌더링 스타일 */
        .message-text h1, .message-text h2, .message-text h3 {
            margin: 8px 0;
            font-weight: 600;
        }
        
        .message-text h1 { font-size: 16px; }
        .message-text h2 { font-size: 15px; }
        .message-text h3 { font-size: 14px; }
        
        .message-text p {
            margin: 6px 0;
        }
        
        .message-text ul, .message-text ol {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .message-text li {
            margin: 4px 0;
        }
        
        .message-text code {
            background: #f3f4f6;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .message-text pre {
            background: #f3f4f6;
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
        }
        
        .message-text pre code {
            background: none;
            padding: 0;
        }
        
        .message-text strong {
            font-weight: 600;
        }
        
        .message-text em {
            font-style: italic;
        }
        
        .message-text a {
            color: #8B5CF6;
            text-decoration: none;
        }
        
        .message-text a:hover {
            text-decoration: underline;
        }

        /* 통합 하단 영역 */
        .combined-footer {
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
            flex-shrink: 0;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        
        /* 피드백 영역 */
        .feedback-section {
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
        }

        .feedback-question {
            font-size: 12px;
            color: #6b7280;
        }

        .feedback-actions {
            display: flex;
            gap: 8px;
        }

        .feedback-btn {
            background: white;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            color: #6b7280;
        }

        .feedback-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .feedback-btn.thumbs-up:hover {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        .feedback-btn.thumbs-down:hover {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        /* 성능 지표 */
        .performance-footer {
            padding: 8px 20px;
            background: #f1f5f9;
            font-size: 10px;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .perf-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* 스크롤바 스타일링 - 메인 콘텐츠 영역에 적용 */
        .main-content::-webkit-scrollbar {
            width: 4px;
        }

        .main-content::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        .main-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* 마크다운 스타일 */
        .summary-text h2 {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
            margin: 12px 0 6px 0;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 4px;
        }

        .summary-text h3 {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin: 10px 0 4px 0;
        }

        .summary-text p {
            margin: 6px 0;
            line-height: 1.5;
        }

        .summary-text ul,
        .summary-text ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .summary-text li {
            margin: 3px 0;
            line-height: 1.4;
        }

        .summary-text strong,
        .summary-text b {
            color: #1f2937;
            font-weight: 700;
        }

        /* 로딩 진행률 UI 스타일 */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 40px;
        }

        .loading-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            max-width: 480px;
            width: 100%;
            text-align: center;
        }

        .loading-icon {
            font-size: 48px;
            animation: pulse 2s infinite;
            margin-bottom: 16px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .loading-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .loading-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 24px;
        }

        .progress-bar-container {
            background: #f3f4f6;
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            position: relative;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #8B5CF6 0%, #3B82F6 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 24px;
        }

        .progress-percentage {
            font-weight: 600;
            color: #8B5CF6;
        }

        .progress-time {
            font-size: 12px;
        }

        .progress-stages {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .stage-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            font-size: 13px;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
        }

        .stage-item:last-child {
            border-bottom: none;
        }

        .stage-icon {
            font-size: 16px;
            width: 24px;
            text-align: center;
        }

        .stage-name {
            flex: 1;
        }

        .stage-status {
            font-size: 16px;
        }

        .stage-item.completed {
            color: #10b981;
        }

        .stage-item.in-progress {
            color: #3b82f6;
        }

        .stage-item.in-progress .stage-name {
            font-weight: 600;
        }

        .partial-data-notice {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 16px;
            text-align: left;
        }

        .partial-data-notice strong {
            display: block;
            margin-bottom: 4px;
        }

        /* 반응형 */
        @media (max-width: 500px) {
            .modal-container {
                width: 100%;
                border-left: none;
            }
            
            .header-content {
                flex-direction: column;
                gap: 8px;
            }
            
            .tab-list {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- FDK 응답 컨테이너 (필수) -->
    <div id="fdk-response-container">
        <div class="modal-container">
        <!-- 얇은 헤더 (메타 정보와 액션 버튼) -->
        <header class="smart-header">
            <div class="header-content">
                <div class="ticket-meta">
                    <span class="meta-item">😐 보통</span>
                    <span class="meta-item">해결완료</span>
                    <span class="meta-item">김상담 (CS팀)</span>
                </div>
                <div class="header-actions">
                    <button class="action-btn" onclick="toggleSummary()" id="summaryToggleBtn" title="요약 접기/펼기">
                        <span style="font-size: 16px;">⌃</span>
                    </button>
                    <button class="action-btn" onclick="refreshData()" title="새로고침">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- 에러 표시 영역 (초기에는 숨김) -->
        <div id="error-display" style="display: none;">
            <!-- 에러 메시지가 여기에 동적으로 표시됩니다 -->
        </div>

        <!-- 로딩 진행률 오버레이 -->
        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <div class="loading-content">
                <div class="loading-icon">🤖</div>
                <h2 class="loading-title">AI 분석 진행 중...</h2>
                <p class="loading-subtitle">티켓 데이터를 분석하고 있습니다</p>
                
                <!-- 진행률 바 -->
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progress-bar"></div>
                </div>
                
                <!-- 진행 정보 -->
                <div class="progress-info">
                    <span class="progress-percentage" id="progress-percentage">0%</span>
                    <span class="progress-time" id="progress-time">예상 시간: 20초</span>
                </div>
                
                <!-- 단계별 진행 상황 -->
                <div class="progress-stages">
                    <div class="stage-item" data-stage="ticket_fetch">
                        <span class="stage-icon">📋</span>
                        <span class="stage-name">티켓 정보 로드</span>
                        <span class="stage-status">⏳</span>
                    </div>
                    <div class="stage-item" data-stage="summary">
                        <span class="stage-icon">🎯</span>
                        <span class="stage-name">AI 요약 생성</span>
                        <span class="stage-status">⏳</span>
                    </div>
                    <div class="stage-item" data-stage="similar_tickets">
                        <span class="stage-icon">🔍</span>
                        <span class="stage-name">유사 티켓 검색</span>
                        <span class="stage-status">⏳</span>
                    </div>
                    <div class="stage-item" data-stage="kb_documents">
                        <span class="stage-icon">📚</span>
                        <span class="stage-name">지식베이스 검색</span>
                        <span class="stage-status">⏳</span>
                    </div>
                </div>
                
                <!-- 부분 데이터 알림 (필요시 표시) -->
                <div class="partial-data-notice" id="partial-data-notice" style="display: none;">
                    <strong>💡 일부 데이터 사용 가능</strong>
                    완료된 분석 결과부터 확인하실 수 있습니다. 채팅 기능도 사용 가능합니다.
                </div>
            </div>
        </div>

        <!-- 메인 콘텐츠 -->
        <main class="main-content" id="main-content">
            <!-- AI 요약 영역 -->
            <section class="ai-summary-section" id="summarySection">
                <div class="summary-header">
                    <div class="summary-title">
                        <i class="fas fa-brain"></i>
                        AI 요약 분석
                    </div>
                    <div class="summary-actions">
                        <button class="summary-action-btn" onclick="copySummary()">
                            📋 복사
                        </button>
                        <button class="summary-action-btn" onclick="regenerateSummary()">
                            ⚡ 재생성
                        </button>
                    </div>
                </div>
                <div class="summary-content" id="summaryContent">
                    <div class="main-summary">
                        <div class="summary-text">
                            🔍 <strong>문제 현황</strong><br>
                            - 핵심 문제와 증상: 아세아홀딩스 라이선스 1명 추가 요청<br>
                            - 고객 배경 정보: 아세아지주사 세금계산서 담당자로부터 요청<br>
                            - 비즈니스 임팩트: 라이선스 추가로 인한 업무 효율성 향상<br>
                            - 감정 상태: 요청은 협조적이며 긍정적으로 보임<br><br>
                            
                            💡 <strong>원인 분석</strong><br>
                            - 파악된 근본 원인: 아세아홀딩스 라이선스 추가 요청<br>
                            - 기여 요인들: 고객의 업무 확장 또는 새로운 사용자 추가<br>
                            - 기술적 세부사항: 라이선스 관련 정보 전달 필요<br>
                            - 원인 확실성 수준: 확정<br><br>
                            
                            ⚡ <strong>해결 진행상황</strong><br>
                            - 현재 상태: 라이선스 추가 작업 진행 중<br>
                            - 수행된 조치들: We Do Soft에서 추가 작업 진행 중<br>
                            - 시도한 해결책과 결과: 라이선스 추가 작업 진행 중<br>
                            - 다음 단계 계획: 아세아홀딩스 재무 담당자 정보 전달 예정<br>
                            - 예상 해결 시간: 미정<br><br>
                            
                            🎯 <strong>중요 인사이트</strong><br>
                            - 향후 처리 방향: 라이선스 추가 작업 완료 후 고객 확인 요청<br>
                            - 에스컬레이션 필요성: 현재 단계에서는 필요 없음<br>
                            - 예방 조치 권장사항: 고객 요청에 따라 신속하게 처리<br>
                            - 고객 관리 방안: 고객 요청 사항에 대한 신속한 응대<br>
                            - 학습 포인트: 유사한 요청 시 빠른 대응 필요
                        </div>
                    </div>
                </div>
            </section>

            <!-- 탭 네비게이션 -->
            <nav class="tab-navigation">
                <div class="tab-list">
                    <button class="tab-button active" data-tab="tickets">
                        📱 유사 티켓
                        <span class="tab-count">3</span>
                    </button>
                    <button class="tab-button" data-tab="kb">
                        📚 KB 문서
                        <span class="tab-count">2</span>
                    </button>
                    <button class="tab-button" data-tab="copilot">
                        🤖 Copilot
                    </button>
                </div>
            </nav>

            <!-- 카드 리스트 영역 -->
            <div class="card-list">
                <!-- 유사 티켓 탭 콘텐츠 -->
                <div class="tab-content active" data-tab="tickets">
                    <div class="insight-panel">
                        <div class="insight-title">💡 자동 분석 결과</div>
                        <div class="insight-content">
                            🎯 평균 유사도: 78% (3건 중 2건이 80% 이상)<br>
                            📊 상태 분포: 해결완료 2건, 진행중 1건<br>
                            🏷️ 공통 키워드: "라이선스", "추가", "메일시스템"
                        </div>
                    </div>

                    <div class="content-card">
                        <div class="card-header">
                            <span class="card-id">#104</span>
                            <span class="similarity-score score-high">🟢 85%</span>
                        </div>
                        <div class="card-body">
                            <div class="card-title">
                                전자결재 결재 완료시 PDF 파일 수신 오류의 건
                            </div>
                            <div class="card-excerpt">
                                아시아홀딩스의 메일 시스템 라이선스가 현재 7명까지 있어서, 1명을 추가하고 싶습니다.
                            </div>
                            <div class="card-meta">
                                <div class="meta-left">
                                    <span>📅 2015-04-10</span>
                                    <span class="status-indicator status-resolved">해결완료</span>
                                    <span class="priority-indicator">🔥 긴급</span>
                                </div>
                                <span>2일 전</span>
                            </div>
                            <div class="card-actions">
                                <button class="card-btn primary" onclick="viewSummary('#104')">
                                    👁️ 요약보기
                                </button>
                                <button class="card-btn" onclick="viewOriginal('#104')">
                                    📄 원본보기
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="content-card">
                        <div class="card-header">
                            <span class="card-id">#105</span>
                            <span class="similarity-score score-medium">🟡 78%</span>
                        </div>
                        <div class="card-body">
                            <div class="card-title">
                                라이선스 관련 업무 처리 요청
                            </div>
                            <div class="card-excerpt">
                                기업 내 데이터 분석을 위한 최적의 도구 선택과 비용 대비 효과 분석을 위한 문의입니다.
                            </div>
                            <div class="card-meta">
                                <div class="meta-left">
                                    <span>📅 2015-03-15</span>
                                    <span class="status-indicator status-progress">진행중</span>
                                    <span class="priority-indicator">🔵 보통</span>
                                </div>
                                <span>1주일 전</span>
                            </div>
                            <div class="card-actions">
                                <button class="card-btn primary" onclick="viewSummary('#105')">
                                    👁️ 요약보기
                                </button>
                                <button class="card-btn" onclick="viewOriginal('#105')">
                                    📄 원본보기
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="content-card">
                        <div class="card-header">
                            <span class="card-id">#106</span>
                            <span class="similarity-score score-medium">🟡 72%</span>
                        </div>
                        <div class="card-body">
                            <div class="card-title">
                                메일 시스템 확장 관련 문의
                            </div>
                            <div class="card-excerpt">
                                AI 도구 도입 시 비용을 최적화하고 효율적인 예산 계획을 수립하는 방법에 대한 문의입니다.
                            </div>
                            <div class="card-meta">
                                <div class="meta-left">
                                    <span>📅 2015-02-20</span>
                                    <span class="status-indicator status-resolved">해결완료</span>
                                    <span class="priority-indicator">🟠 높음</span>
                                </div>
                                <span>2주일 전</span>
                            </div>
                            <div class="card-actions">
                                <button class="card-btn primary" onclick="viewSummary('#106')">
                                    👁️ 요약보기
                                </button>
                                <button class="card-btn" onclick="viewOriginal('#106')">
                                    📄 원본보기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KB 문서 탭 콘텐츠 -->
                <div class="tab-content" data-tab="kb">
                    <div class="insight-panel">
                        <div class="insight-title">📚 지식베이스 검색 결과</div>
                        <div class="insight-content">
                            🎯 관련도 높은 문서: 2건<br>
                            📊 평균 관련성: 85%<br>
                            🏷️ 주제: 라이선스 관리, 시스템 확장
                        </div>
                    </div>

                    <div class="content-card">
                        <div class="card-header">
                            <span class="card-id">KB-001</span>
                            <span class="similarity-score score-high">🟢 89%</span>
                        </div>
                        <div class="card-body">
                            <div class="card-title">
                                라이선스 추가 신청 및 승인 프로세스
                            </div>
                            <div class="card-excerpt">
                                기업 라이선스 추가 신청 시 필요한 서류와 승인 프로세스에 대한 상세 가이드입니다.
                            </div>
                            <div class="card-meta">
                                <div class="meta-left">
                                    <span>📅 2024-01-15</span>
                                    <span class="status-indicator status-resolved">최신</span>
                                    <span>📂 시스템관리</span>
                                </div>
                                <span>업데이트: 1개월 전</span>
                            </div>
                            <div class="card-actions">
                                <button class="card-btn primary" onclick="viewKBSummary('KB-001')">
                                    👁️ 요약보기
                                </button>
                                <button class="card-btn" onclick="viewKBOriginal('KB-001')">
                                    📄 원본보기
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="content-card">
                        <div class="card-header">
                            <span class="card-id">KB-002</span>
                            <span class="similarity-score score-high">🟢 82%</span>
                        </div>
                        <div class="card-body">
                            <div class="card-title">
                                메일 시스템 용량 및 사용자 확장 가이드
                            </div>
                            <div class="card-excerpt">
                                메일 시스템의 사용자 수 확장과 관련된 기술적 요구사항 및 절차를 설명합니다.
                            </div>
                            <div class="card-meta">
                                <div class="meta-left">
                                    <span>📅 2024-02-10</span>
                                    <span class="status-indicator status-resolved">최신</span>
                                    <span>📂 기술지원</span>
                                </div>
                                <span>업데이트: 3주 전</span>
                            </div>
                            <div class="card-actions">
                                <button class="card-btn primary" onclick="viewKBSummary('KB-002')">
                                    👁️ 요약보기
                                </button>
                                <button class="card-btn" onclick="viewKBOriginal('KB-002')">
                                    📄 원본보기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Copilot 탭 콘텐츠 -->
                <div class="tab-content" data-tab="copilot">
                    <!-- 대화 모드 토글 -->
                    <div class="chat-mode-toggle">
                        <div class="mode-toggle-container">
                            <div class="mode-toggle-section">
                                <span class="mode-label active" data-mode="smart">🎯 스마트 모드</span>
                                <div class="ios-toggle" onclick="toggleChatMode()">
                                    <div class="toggle-slider"></div>
                                </div>
                                <span class="mode-label" data-mode="free">💭 자유 모드</span>
                            </div>
                            <div class="mode-description">
                                <span id="mode-desc">티켓 정보와 관련 문서를 기반으로 답변합니다</span>
                            </div>
                        </div>
                    </div>

                    <!-- 채팅 컨테이너 -->
                    <div class="chat-container">
                        <!-- 채팅 메시지 영역 -->
                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-message assistant">
                                <div class="message-avatar">🤖</div>
                                <div class="message-content">
                                    <div class="message-text">
                                        안녕하세요! AI 어시스턴트입니다. 현재 티켓에 대해 궁금한 점이나 도움이 필요한 사항을 말씀해 주세요.
                                    </div>
                                    <div class="message-time">방금 전</div>
                                </div>
                            </div>
                        </div>

                        <!-- 입력 영역 -->
                        <div class="chat-input-container">
                            <div class="chat-input-wrapper">
                                <textarea 
                                    id="chatInput" 
                                    placeholder="메시지를 입력하세요..." 
                                    rows="1"
                                    onkeydown="handleChatKeydown(event)"
                                    oninput="adjustTextareaHeight(this)"
                                ></textarea>
                                <button class="send-button" onclick="sendMessage()" id="sendButton">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="m22 2-7 20-4-9-9-4Z"/>
                                        <path d="M22 2 11 13"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 통합 하단 영역 -->
        <div class="combined-footer">
            <!-- 피드백 섹션 -->
            <div class="feedback-section">
                <div class="feedback-question">이 AI 분석이 도움이 되었나요?</div>
                <div class="feedback-actions">
                    <button class="feedback-btn thumbs-up" onclick="submitFeedback('positive')">
                        👍 도움됨
                    </button>
                    <button class="feedback-btn thumbs-down" onclick="submitFeedback('negative')">
                        👎 개선필요
                    </button>
                </div>
            </div>

            <!-- 성능 지표 푸터 -->
            <div class="performance-footer">
                <div class="perf-item">
                    🕒 처리시간: 3.2초
                </div>
                <div class="perf-item">
                    📊 품질점수: 82%
                </div>
                <div class="perf-item">
                    🔍 검색결과: 5건
                </div>
            </div>
        </div>
    </div>
    <!-- FDK 응답 컨테이너 종료 -->

    <!-- FDK 스크립트 로드 -->
    <script src="https://static.freshdev.io/fdk/2.0/assets/fresh_client.js"></script>
    
    <!-- 마크다운 파서 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    
    <!-- 앱 모듈들 (의존성 순서에 따라 로드) -->
    <script src="scripts/globals.js"></script>
    <script src="scripts/utils.js"></script>
    <script src="scripts/api.js"></script>
    <script src="scripts/data.js"></script>
    <script src="scripts/ui.js"></script>
    <script src="scripts/events.js"></script>
    <script src="scripts/app.js"></script>

    <script>
        // FDK 환경 감지 및 최적화
        (function() {
            'use strict';

            // 안전한 DOM 조작을 위한 헬퍼 함수
            function safeQuerySelector(selector) {
                try {
                    return document.querySelector(selector);
                } catch (e) {
                    console.warn('Safe query selector failed:', e);
                    return null;
                }
            }

            function safeQuerySelectorAll(selector) {
                try {
                    return document.querySelectorAll(selector);
                } catch (e) {
                    console.warn('Safe query selector all failed:', e);
                    return [];
                }
            }

            // FDK 환경 감지 및 UI 표시
            function detectEnvironment() {
                const body = document.body;
                const modalContainer = document.querySelector('.modal-container');
                
                // iframe 환경 감지
                if (window.self !== window.top) {
                    console.log('🎭 iframe 환경 감지 (width:', window.innerWidth, ', height:', window.innerHeight, ')');
                    
                    // 부모 창 크기로 모달/사이드바 구분
                    if (window.innerWidth > 500 || window.innerHeight > 500) {
                        console.log('📱 모달 모드 적용 - 전체 UI 표시');
                        body.classList.add('modal-mode');
                        body.classList.remove('sidebar-mode');
                        
                        // 모달에서 컨테이너 최대 활용
                        if (modalContainer) {
                            modalContainer.style.width = '100%';
                            modalContainer.style.maxWidth = '100%';
                        }
                    } else {
                        console.log('📱 사이드바 모드 적용');
                        body.classList.add('sidebar-mode');
                        body.classList.remove('modal-mode');
                    }
                } else {
                    console.log('🖥️ 일반 환경 감지 - 모달 UI 표시');
                    // 직접 접근 (개발/테스트) - 모달 UI 표시
                    body.classList.add('standalone-mode');
                }

                // 오류 모드 처리
                checkErrorMode();

                // 컨테이너 크기 조정
                adjustContainerSize();
            }

            // 오류 모드 확인 및 처리
            function checkErrorMode() {
                try {
                    // URL 파라미터나 전역 변수로 오류 모드 확인
                    const urlParams = new URLSearchParams(window.location.search);
                    const isErrorMode = urlParams.get('errorMode') === 'true' || window.errorMode === true;
                    
                    if (isErrorMode) {
                        console.log('🚨 오류 모드 감지 - UI에 오류 메시지 표시');
                        showErrorMessage('벡터 DB 연결 오류가 발생했지만 기본 기능은 사용할 수 있습니다.');
                    }
                } catch (error) {
                    console.warn('오류 모드 확인 중 문제 발생:', error);
                }
            }

            // 오류 메시지 표시 함수
            function showErrorMessage(message) {
                try {
                    const errorDisplay = document.getElementById('error-display');
                    if (errorDisplay) {
                        errorDisplay.innerHTML = `
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin: 16px 20px; color: #92400e;">
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600;">
                                    ⚠️ 시스템 알림
                                </div>
                                <div style="font-size: 13px; margin-top: 4px;">
                                    ${message}
                                </div>
                            </div>
                        `;
                        errorDisplay.style.display = 'block';
                    }
                } catch (error) {
                    console.error('오류 메시지 표시 실패:', error);
                }
            }

            // 컨테이너 크기 조정
            function adjustContainerSize() {
                const modalContainer = document.querySelector('.modal-container');
                
                if (!modalContainer) return;

                if (document.body.classList.contains('modal-mode')) {
                    console.log('📐 모달 모드 - 컨테이너 최대 활용');
                    modalContainer.style.width = '100%';
                    modalContainer.style.maxWidth = '100%';
                } else if (document.body.classList.contains('sidebar-mode')) {
                    console.log('📐 사이드바 모드 - 제한된 폭');
                    modalContainer.style.maxWidth = '400px';
                } else {
                    console.log('📐 일반 모드 - 기본 설정');
                    modalContainer.style.width = '100%';
                    modalContainer.style.maxWidth = '100%';
                }
            }

            // 즉시 환경 감지 실행
            detectEnvironment();

            // 창 크기 변경 시 재조정
            window.addEventListener('resize', function() {
                try {
                    adjustContainerSize();
                } catch (error) {
                    console.warn('Resize handler error:', error);
                }
            });

            // 에러 핸들링
            window.addEventListener('error', function(event) {
                console.warn('Runtime error caught:', event.error);
                // 에러가 발생해도 앱이 계속 동작하도록 함
            });

        })();

        // 탭 전환 기능
        function switchTab(tabName) {
            // 모든 탭 버튼 비활성화
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 모든 탭 콘텐츠 숨기기
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 선택된 탭 버튼 활성화
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // 선택된 탭 콘텐츠 보이기
            const activeContent = document.querySelector(`.tab-content[data-tab="${tabName}"]`);
            if (activeContent) {
                activeContent.classList.add('active');
            }
        }
        
        // 탭 버튼에 이벤트 리스너 추가
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        });

        // 요약 접기/펴기 기능 + 스크롤 디버깅
        function toggleSummary() {
            const section = document.getElementById('summarySection');
            const toggleBtn = document.getElementById('summaryToggleBtn');
            
            if (section.classList.contains('collapsed')) {
                // 펴기
                section.classList.remove('collapsed');
                toggleBtn.innerHTML = '<span style="font-size: 16px;">⌃</span>';
                console.log('펼치기 실행');
            } else {
                // 접기
                section.classList.add('collapsed');
                toggleBtn.innerHTML = '<span style="font-size: 16px;">⌄</span>';
                console.log('접기 실행');
            }
        }

        // 간단한 스크롤 이벤트 관리 - 부모 창으로의 전파만 차단
        document.addEventListener('DOMContentLoaded', function() {
            const fdkContainer = document.getElementById('fdk-response-container');
            const mainContent = document.querySelector('.main-content');
            
            // FDK 컨테이너에서 부모 창으로의 스크롤 전파 차단
            if (fdkContainer) {
                fdkContainer.addEventListener('wheel', function(e) {
                    e.stopPropagation(); // 부모로의 전파만 차단
                }, { passive: false });
            }
            
            // 메인 콘텐츠 영역에서 부모 창으로의 스크롤 전파 차단
            if (mainContent) {
                mainContent.addEventListener('wheel', function(e) {
                    e.stopPropagation(); // 부모로의 전파만 차단
                }, { passive: false });
            }
        });

        // 액션 버튼 기능들
        function copySummary() {
            const summaryText = document.querySelector('.summary-text').textContent;
            navigator.clipboard.writeText(summaryText).then(() => {
                alert('요약이 클립보드에 복사되었습니다.');
            });
        }

        function regenerateSummary() {
            alert('AI 요약을 재생성합니다.');
        }

        function closeModal() {
            alert('모달을 닫습니다.');
        }

        function refreshData() {
            const refreshBtn = document.querySelector('[title="새로고침"] i');
            if (refreshBtn) {
                refreshBtn.classList.add('fa-spin');
                setTimeout(() => {
                    refreshBtn.classList.remove('fa-spin');
                }, 2000);
            }
            alert('데이터를 새로고침합니다.');
        }

        function viewSummary(ticketId) {
            alert(`${ticketId} 티켓의 요약을 표시합니다.`);
        }

        function viewOriginal(ticketId) {
            alert(`${ticketId} 티켓의 원본을 표시합니다.`);
        }

        function viewKBSummary(kbId) {
            alert(`${kbId} 문서의 요약을 표시합니다.`);
        }

        function viewKBOriginal(kbId) {
            alert(`${kbId} 문서의 원본을 표시합니다.`);
        }

        // 채팅 관련 전역 변수
        let currentChatMode = 'smart'; // 'smart' 또는 'free'
        let isTyping = false;

        // 대화 모드 토글
        function toggleChatMode() {
            const toggle = document.querySelector('.ios-toggle');
            const smartLabel = document.querySelector('[data-mode="smart"]');
            const freeLabel = document.querySelector('[data-mode="free"]');
            const modeDesc = document.getElementById('mode-desc');
            
            if (currentChatMode === 'smart') {
                currentChatMode = 'free';
                toggle.classList.add('active');
                smartLabel.classList.remove('active');
                freeLabel.classList.add('active');
                modeDesc.textContent = 'AI와 자유롭게 대화할 수 있습니다';
            } else {
                currentChatMode = 'smart';
                toggle.classList.remove('active');
                smartLabel.classList.add('active');
                freeLabel.classList.remove('active');
                modeDesc.textContent = '티켓 정보와 관련 문서를 기반으로 답변합니다';
            }
            
            console.log('채팅 모드 변경:', currentChatMode);
        }

        // 메시지 전송
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            console.log('sendMessage 호출됨:', { message, isTyping });
            
            if (!message || isTyping) {
                console.log('메시지 전송 취소:', { noMessage: !message, isTyping });
                return;
            }
            
            // Events 모듈의 채팅 시스템 사용
            if (window.Events && window.Events.performCopilotSearch) {
                try {
                    // 기본 검색 타입 설정 (사용자가 선택하지 않은 경우)
                    const selectedTypes = getSelectedContentTypes() || ['tickets', 'solutions'];
                    
                    // 버튼 비활성화
                    sendButton.disabled = true;
                    
                    // Events 모듈을 통한 채팅 처리
                    const client = window.GlobalState?.getClient();
                    if (client) {
                        await window.Events.performCopilotSearch(client, message, selectedTypes);
                        input.value = '';
                        adjustTextareaHeight(input);
                    } else {
                        throw new Error('FDK 클라이언트가 초기화되지 않았습니다.');
                    }
                } catch (error) {
                    console.error('채팅 전송 실패:', error);
                    // 🚫 중복 메시지 렌더링 제거: Events 모듈에서 이미 처리됨
                } finally {
                    sendButton.disabled = false;
                    isTyping = false;
                }
            } else {
                // 🚫 폴백 로직 제거: Events 모듈만 사용
                console.error('❌ Events 모듈이 로드되지 않았습니다.');
                addMessage('assistant', '채팅 시스템을 초기화할 수 없습니다. 페이지를 새로고침해 주세요.');
                sendButton.disabled = false;
                isTyping = false;
            }
        }
        
        // 선택된 컨텐츠 타입 가져오기
        function getSelectedContentTypes() {
            const types = [];
            if (document.getElementById('search-tickets')?.checked) types.push('tickets');
            if (document.getElementById('search-solutions')?.checked) types.push('solutions');
            if (document.getElementById('search-images')?.checked) types.push('images');
            if (document.getElementById('search-attachments')?.checked) types.push('attachments');
            return types.length > 0 ? types : null;
        }
        
        // 백엔드로 채팅 메시지 전송
        async function sendChatToBackend(message) {
            isTyping = true;
            showTypingIndicator();
            
            try {
                // FDK 클라이언트 가져오기
                const client = await app.initialized();
                
                // 현재 티켓 ID 가져오기
                let ticketId = null;
                try {
                    const ticketData = await client.data.get('ticket');
                    ticketId = ticketData?.ticket?.id;
                } catch (error) {
                    console.warn('티켓 ID를 가져올 수 없습니다:', error);
                }
                
                // API 호출 데이터 준비
                const queryData = {
                    query: message,
                    agent_mode: currentChatMode === 'smart',
                    stream_response: true,
                    ticket_id: ticketId
                };
                
                // 스트리밍 응답 처리
                let fullResponse = '';
                const streamHandler = (eventData) => {
                    if (eventData.type === 'token' && eventData.content) {
                        fullResponse += eventData.content;
                        // 실시간으로 메시지 업데이트
                        updateStreamingMessage(fullResponse);
                    } else if (eventData.type === 'complete') {
                        hideTypingIndicator();
                        if (!fullResponse) {
                            fullResponse = eventData.data?.answer || generateDefaultResponse(message);
                        }
                        finalizeStreamingMessage(fullResponse);
                        isTyping = false;
                    } else if (eventData.type === 'error') {
                        throw new Error(eventData.error || 'Stream error');
                    }
                };
                
                // API 호출
                if (window.API && window.API.sendChatQuery) {
                    await window.API.sendChatQuery(client, queryData, {
                        onStream: streamHandler,
                        fallbackToNormal: true
                    });
                } else {
                    // API 모듈이 없으면 폴백
                    console.warn('API 모듈을 찾을 수 없습니다. 시뮬레이션 모드로 전환합니다.');
                    simulateAIResponse(message);
                }
                
            } catch (error) {
                console.error('백엔드 API 호출 실패:', error);
                hideTypingIndicator();
                
                // 에러 시 폴백 응답
                const errorMessage = '죄송합니다. 서버 연결에 문제가 있습니다. 잠시 후 다시 시도해 주세요.';
                addMessage('assistant', errorMessage);
                isTyping = false;
            }
        }
        
        // 스트리밍 메시지 업데이트
        let currentStreamingMessage = null;
        function updateStreamingMessage(content) {
            if (!currentStreamingMessage) {
                hideTypingIndicator();
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message assistant streaming';
                messageDiv.id = 'streaming-message';
                
                const now = new Date();
                const timeString = now.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">🤖</div>
                    <div class="message-content">
                        <div class="message-text">${escapeHtml(content)}</div>
                        <div class="message-time">${timeString}</div>
                    </div>
                `;
                
                chatMessages.appendChild(messageDiv);
                currentStreamingMessage = messageDiv;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                const textElement = currentStreamingMessage.querySelector('.message-text');
                if (textElement) {
                    textElement.textContent = content;
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
        }
        
        // 스트리밍 메시지 완료
        function finalizeStreamingMessage(content) {
            if (currentStreamingMessage) {
                currentStreamingMessage.classList.remove('streaming');
                const textElement = currentStreamingMessage.querySelector('.message-text');
                if (textElement) {
                    // 마크다운 렌더링
                    const renderedContent = renderMarkdown(content);
                    textElement.innerHTML = renderedContent;
                }
                currentStreamingMessage = null;
            } else {
                addMessage('assistant', content);
            }
        }
        
        // HTML 이스케이프 함수
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 마크다운 렌더링 함수
        function renderMarkdown(text) {
            // marked 라이브러리가 로드되어 있으면 사용
            if (typeof marked !== 'undefined') {
                // 기본 설정
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    sanitize: false
                });
                
                // 마크다운 파싱 후 렌더링
                return marked.parse(text);
            } else {
                // marked가 없으면 기본 텍스트로 표시
                return escapeHtml(text);
            }
        }
        
        // 기본 응답 생성 (폴백용)
        function generateDefaultResponse(message) {
            if (currentChatMode === 'smart') {
                return '현재 티켓 정보를 분석 중입니다. 관련 정보를 찾는 동안 잠시만 기다려 주세요.';
            } else {
                return '네, 말씀하신 내용을 이해했습니다. 어떤 도움이 필요하신가요?';
            }
        }

        // 메시지 추가
        function addMessage(sender, text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const avatar = sender === 'user' ? '👤' : '🤖';
            
            // 사용자 메시지는 이스케이프, AI 메시지는 마크다운 렌더링
            const displayText = sender === 'user' ? escapeHtml(text) : renderMarkdown(text);
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-text">${displayText}</div>
                    <div class="message-time">${timeString}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // AI 응답 시뮬레이션
        function simulateAIResponse(userMessage) {
            isTyping = true;
            showTypingIndicator();
            
            // 모드별 응답 생성
            let response;
            if (currentChatMode === 'smart') {
                response = generateSmartResponse(userMessage);
            } else {
                response = generateFreeResponse(userMessage);
            }
            
            // 타이핑 시뮬레이션 (1-3초)
            const typingTime = Math.random() * 2000 + 1000;
            setTimeout(() => {
                hideTypingIndicator();
                addMessage('assistant', response);
                isTyping = false;
            }, typingTime);
        }

        // 스마트 모드 응답 생성
        function generateSmartResponse(message) {
            const smartResponses = [
                "현재 티켓 정보를 바탕으로 분석해보면, 라이선스 추가 요청은 일반적으로 영업팀을 통해 처리됩니다. 관련 문서를 확인하시겠어요?",
                "유사한 티켓들을 살펴보니, 이런 경우 보통 2-3일 정도 소요됩니다. 더 자세한 진행 상황을 확인해드릴까요?",
                "KB 문서에 따르면, 라이선스 관련 업무는 승인 프로세스가 필요합니다. 현재 단계를 확인해보겠습니다.",
                "티켓 내용을 분석한 결과, 고객의 요구사항이 명확해 보입니다. 다음 단계는 무엇인지 안내해드릴게요."
            ];
            return smartResponses[Math.floor(Math.random() * smartResponses.length)];
        }

        // 자유 모드 응답 생성
        function generateFreeResponse(message) {
            const freeResponses = [
                "네, 말씀하신 내용에 대해 도움을 드릴 수 있습니다. 더 구체적으로 어떤 부분이 궁금하신가요?",
                "좋은 질문이네요! 이런 상황에서는 여러 가지 접근 방법이 있습니다. 어떤 방식을 선호하시나요?",
                "이해했습니다. 비슷한 경험을 바탕으로 말씀드리면, 이런 경우에는 단계적으로 접근하는 것이 좋습니다.",
                "네, 도움이 되는 정보를 제공해드릴게요. 먼저 현재 상황을 정확히 파악해보겠습니다."
            ];
            return freeResponses[Math.floor(Math.random() * freeResponses.length)];
        }

        // 타이핑 인디케이터 표시
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant typing-indicator';
            typingDiv.id = 'typing-indicator';
            
            typingDiv.innerHTML = `
                <div class="message-avatar">🤖</div>
                <div class="message-content">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 타이핑 인디케이터 숨기기
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // 텍스트 영역 높이 자동 조정
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // 엔터키 처리
        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function submitFeedback(type) {
            const btn = event.target;
            if (type === 'positive') {
                btn.style.background = '#d1fae5';
                btn.style.borderColor = '#10b981';
                btn.style.color = '#065f46';
                alert('긍정적 피드백이 전송되었습니다. 감사합니다!');
            } else {
                btn.style.background = '#fee2e2';
                btn.style.borderColor = '#ef4444';
                btn.style.color = '#991b1b';
                alert('개선 피드백이 전송되었습니다. 더 나은 서비스를 위해 노력하겠습니다.');
            }
        }

        // 🔄 모달 데이터 새로고침 함수
        async function refreshData() {
            console.log('🔄 새로고침 버튼 클릭됨');
            
            try {
                // FDK 클라이언트 가져오기
                const client = await app.initialized();
                
                // Data 모듈의 refreshModalData 함수 호출
                if (window.Data && window.Data.refreshModalData) {
                    await window.Data.refreshModalData(client);
                } else {
                    console.error('❌ Data.refreshModalData 함수를 찾을 수 없음');
                    
                    // 토스트 알림
                    if (window.UI && window.UI.showToast) {
                        window.UI.showToast('새로고침 기능을 사용할 수 없습니다.', 'error');
                    } else {
                        console.warn('⚠️ UI 토스트를 사용할 수 없음 - 새로고침 기능 없음');
                    }
                }
            } catch (error) {
                console.error('❌ 새로고침 처리 중 오류:', error);
                
                // 오류 알림
                if (window.UI && window.UI.showToast) {
                    window.UI.showToast('새로고침 중 오류가 발생했습니다.', 'error');
                } else {
                    console.warn('⚠️ UI 토스트를 사용할 수 없음 - 새로고침 오류');
                }
            }
        }


        // 채팅 입력창 초기화 및 디버깅
        function initializeChatInput() {
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            
            if (chatInput) {
                chatInput.disabled = false;
                chatInput.readOnly = false;
                chatInput.style.pointerEvents = 'auto';
                chatInput.style.opacity = '1';
                console.log('채팅 입력창 활성화 완료');
            } else {
                console.error('채팅 입력창을 찾을 수 없습니다');
            }
            
            if (sendButton) {
                sendButton.disabled = false;
                sendButton.style.pointerEvents = 'auto';
                sendButton.style.opacity = '1';
                console.log('전송 버튼 활성화 완료');
            } else {
                console.error('전송 버튼을 찾을 수 없습니다');
            }
            
            // isTyping 상태 확인
            console.log('현재 isTyping 상태:', isTyping);
            isTyping = false; // 확실히 false로 설정
        }

        // 🎯 모달 로딩 상태 체크 및 UI 업데이트
        async function checkLoadingStateAndUpdateUI() {
            console.log('🔍 모달 로딩 상태 체크 시작');
            
            try {
                // FDK 클라이언트 초기화
                const client = await app.initialized();
                const context = await client.instance.context();
                const modalData = context.data || {};
                
                console.log('📊 모달 데이터 확인:', {
                    isLoading: modalData.isLoading,
                    isReady: modalData.isReady,
                    hasError: modalData.hasError,
                    loadingStatus: modalData.loadingStatus,
                    streamingStatus: modalData.streamingStatus
                });
                
                // 로딩 중인 경우 (최우선 체크)
                if (modalData.isLoading) {
                    console.log('🔄 로딩 상태 감지됨 - 진행률 표시');
                    showLoadingOverlay();
                    startProgressMonitoring();
                } 
                // 준비 완료
                else if (modalData.isReady) {
                    console.log('✅ 데이터 준비 완료');
                    hideLoadingOverlay();
                    updateUIWithData(modalData.globalData);
                }
                // 부분 로드 상태
                else if (modalData.isPartiallyLoaded) {
                    console.log('📊 부분 데이터 사용 가능');
                    hideLoadingOverlay();
                    updateUIWithPartialData(modalData.globalData);
                    showPartialDataNotice();
                }
                // 에러 상태 (로딩 중이 아닐 때만)
                else if (modalData.hasError) {
                    console.log('❌ 에러 상태 감지됨');
                    hideLoadingOverlay();
                    showErrorState(modalData.errorMessage);
                }
                // 초기 상태 (로딩도 시작 안됨)
                else {
                    console.log('⏳ 초기 상태 - 로딩 시작 대기 중');
                    // 잠시 후 다시 체크
                    setTimeout(() => {
                        checkLoadingStateAndUpdateUI();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('❌ 로딩 상태 체크 실패:', error);
                showErrorState('초기화 중 오류가 발생했습니다.');
            }
        }
        
        // 🔄 로딩 오버레이 표시
        function showLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = 'flex';
                console.log('🎯 로딩 오버레이 표시됨');
            }
        }
        
        // 🔄 로딩 오버레이 숨기기
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
                console.log('✅ 로딩 오버레이 숨김');
            }
        }
        
        // 📊 진행률 모니터링 시작
        function startProgressMonitoring() {
            console.log('📊 진행률 모니터링 시작');
            
            const progressInterval = setInterval(async () => {
                try {
                    if (!window.GlobalState) return;
                    
                    const loadingStatus = window.GlobalState.getLoadingStatus();
                    const streamingStatus = window.GlobalState.getStreamingStatus();
                    
                    // 전체 진행률 계산
                    const progress = streamingStatus.overall_progress || 
                                   (loadingStatus.elapsedTime / loadingStatus.estimatedTime * 100);
                    
                    // UI 업데이트
                    updateProgressUI(Math.min(progress, 100), loadingStatus.remainingTime);
                    updateStagesUI(streamingStatus.stages);
                    
                    // 완료 또는 에러 시 모니터링 중지
                    if (loadingStatus.status === 'ready' || loadingStatus.status === 'error') {
                        clearInterval(progressInterval);
                        
                        if (loadingStatus.status === 'ready') {
                            // 데이터로 UI 업데이트
                            const globalData = window.GlobalState.getGlobalTicketData();
                            updateUIWithData(globalData);
                        }
                        
                        hideLoadingOverlay();
                    }
                    
                } catch (error) {
                    console.error('❌ 진행률 모니터링 오류:', error);
                }
            }, 500); // 0.5초마다 업데이트
        }
        
        // 📊 진행률 UI 업데이트
        function updateProgressUI(percentage, remainingTime) {
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            const progressTime = document.getElementById('progress-time');
            
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
            
            if (progressPercentage) {
                progressPercentage.textContent = `${Math.round(percentage)}%`;
            }
            
            if (progressTime && remainingTime !== null) {
                const seconds = Math.ceil(remainingTime / 1000);
                progressTime.textContent = seconds > 0 ? `예상 시간: ${seconds}초` : '곧 완료됩니다';
            }
        }
        
        // 📊 단계별 UI 업데이트
        function updateStagesUI(stages) {
            if (!stages) return;
            
            Object.entries(stages).forEach(([stageKey, stageData]) => {
                const stageElement = document.querySelector(`[data-stage="${stageKey}"]`);
                if (!stageElement) return;
                
                const statusElement = stageElement.querySelector('.stage-status');
                
                if (stageData.completed) {
                    stageElement.classList.add('completed');
                    stageElement.classList.remove('in-progress');
                    if (statusElement) statusElement.textContent = '✅';
                } else if (stageData.progress > 0) {
                    stageElement.classList.add('in-progress');
                    if (statusElement) statusElement.textContent = '⟳';
                }
            });
        }
        
        // 🚨 에러 상태 표시
        function showErrorState(errorMessage) {
            const errorDisplay = document.getElementById('error-display');
            if (errorDisplay) {
                errorDisplay.innerHTML = `
                    <div style="background: #fee2e2; border: 1px solid #f87171; padding: 16px; border-radius: 8px; margin: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20px;">⚠️</span>
                            <div>
                                <strong>서버 연결 오류</strong><br>
                                ${errorMessage || 'AI 서비스에 연결할 수 없습니다.'}
                            </div>
                        </div>
                        <button onclick="refreshData()" style="margin-top: 12px; background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            새로고침
                        </button>
                    </div>
                `;
                errorDisplay.style.display = 'block';
            }
        }
        
        // 📊 데이터로 UI 업데이트
        function updateUIWithData(data) {
            if (!data) return;
            
            // 요약 업데이트
            if (data.summary) {
                const summaryContent = document.getElementById('summaryContent');
                if (summaryContent) {
                    // 요약 내용 업데이트 로직
                    console.log('✅ 요약 데이터 업데이트됨');
                }
            }
            
            // 채팅 활성화
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.disabled = false;
                chatInput.placeholder = '메시지를 입력하세요...';
            }
        }
        
        // 💡 부분 데이터 알림 표시
        function showPartialDataNotice() {
            const notice = document.getElementById('partial-data-notice');
            if (notice) {
                notice.style.display = 'block';
            }
        }

        // DOM 로드 완료 후 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM 로드 완료, 모달 초기화 시작');
            
            // 🎯 로딩 상태 체크 및 UI 업데이트 (최우선)
            checkLoadingStateAndUpdateUI();
            
            // 채팅 입력창 초기화
            initializeChatInput();
            
            // 카드 호버 효과
            document.querySelectorAll('.content-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
            
            // 입력창 클릭 테스트
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('click', function() {
                    console.log('채팅 입력창 클릭됨');
                });
                
                chatInput.addEventListener('focus', function() {
                    console.log('채팅 입력창 포커스됨');
                });
                
                chatInput.addEventListener('input', function() {
                    console.log('채팅 입력창 입력됨:', this.value);
                });
            }
        });
    </script>
</body>
</html>