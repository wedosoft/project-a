<!DOCTYPE html>
<html>
<head>
  <title>Ticket Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="styles/sidebar.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      font-size: 14px;
    }
    
    /* FDK 응답 컨테이너 스타일 */
    #fdk-response-container {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* 모달 스타일 */
    .modal {
        max-width: none !important;
        max-height: none !important;
        margin: 0 !important;
      }
      
      .modal-content {
        width: 100% !important;
        height: 100% !important;
        max-height: none !important;
        border-radius: 8px !important;
        display: flex !important;
        flex-direction: column !important;
      }
      
      .modal-body {
        flex: 1 !important;
        overflow-y: auto !important;
        padding: 20px !important;
      }
      
      .modal-backdrop {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        min-width: 800px !important;
        min-height: 600px !important;
      }
    
    /* 모달 강제 표시 스타일 - 디버깅 및 fallback용 */
    .modal.show {
      display: block !important;
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    .modal-backdrop.show {
      opacity: 0.5 !important;
      visibility: visible !important;
    }
    
    /* 기존 스타일들 */
    .ticket-info {
      background-color: #f8f9fa;
      border-radius: 5px;
      padding: 12px;
      margin-bottom: 15px;
    }
    .ticket-info h5 {
      margin-top: 0;
      color: #2c3e50;
    }
    .info-row {
      display: flex;
      margin-bottom: 8px;
    }
    .info-label {
      font-weight: bold;
      width: 80px;
      color: #7f8c8d;
    }
    .info-value {
      flex: 1;
    }
    .tab-container {
      margin-top: 15px;
    }
    .nav-tabs .nav-link {
      font-size: 14px;
      padding: 8px 12px;
    }
    .tab-content {
      padding: 15px;
      border: 1px solid #dee2e6;
      border-top: none;
      border-radius: 0 0 5px 5px;
      min-height: 200px;
    }
    .placeholder-text {
      color: #95a5a6;
      font-style: italic;
      text-align: center;
      margin-top: 70px;
    }
    .search-container {
      margin-top: 15px;
      margin-bottom: 15px;
    }
    .search-options {
      margin-top: 10px;
    }
    .search-results {
      margin-top: 15px;
    }
    .ticket-card {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .ticket-card:hover {
      background-color: #f8f9fa;
    }
    .ticket-card-header {
      display: flex;
      justify-content: space-between;
    }
    .ticket-card-id {
      color: #7f8c8d;
      font-size: 12px;
    }
    .ticket-card-status {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
    .status-open {
      background-color: #3498db;
      color: white;
    }
    .status-pending {
      background-color: #f39c12;
      color: white;
    }
    .status-resolved {
      background-color: #2ecc71;
      color: white;
    }
    .status-closed {
      background-color: #95a5a6;
      color: white;
    }
    .solution-card {
      border-left: 4px solid #3498db;
    }
    .solution-excerpt {
      color: #7f8c8d;
      font-size: 12px;
      line-height: 1.4;
      max-height: 50px;
      overflow: hidden;
    }
    
    /* Chat interface styles */
    .chat-interface {
      height: 100%;
    }
    .chat-messages {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      background-color: #fafafa;
    }
    .chat-message {
      margin-bottom: 15px;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 85%;
    }
    .chat-message.user {
      background-color: #007bff;
      color: white;
      margin-left: auto;
      text-align: right;
    }
    .chat-message.assistant {
      background-color: white;
      border: 1px solid #ddd;
      margin-right: auto;
    }
    .chat-input-container {
      margin-top: 10px;
    }
    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Detail view styles */
    .detail-content {
      background-color: #f8f9fa;
      border-radius: 5px;
      padding: 15px;
    }
    .detail-section {
      margin-bottom: 20px;
    }
    .detail-section h6 {
      color: #2c3e50;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
      margin-bottom: 10px;
    }
    .detail-meta {
      background-color: white;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 15px;
    }
    .badge-custom {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-right: 5px;
    }
    
    /* List item styles */
    .list-item {
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: white;
    }
    .list-item:hover {
      border-color: #007bff;
      box-shadow: 0 2px 4px rgba(0,123,255,0.1);
      transform: translateY(-1px);
    }
    .list-item-header {
      display: flex;
      justify-content: between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .list-item-title {
      font-weight: 600;
      color: #2c3e50;
      flex: 1;
      margin-right: 10px;
    }
    .list-item-meta {
      font-size: 12px;
      color: #6c757d;
      margin-top: 5px;
    }
    .list-item-excerpt {
      color: #6c757d;
      font-size: 13px;
      line-height: 1.4;
      margin-top: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .score-badge {
      background-color: #28a745;
      color: white;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container-fluid p-0">
    <!-- FDK Response Container - 모달 대신 사용할 인라인 응답 영역 -->
    <div id="fdk-response-container" style="display: none;">
      <div class="alert alert-info">
        <div id="fdk-response-content">
          <!-- 응답 내용이 여기에 표시됩니다 -->
        </div>
        <button type="button" class="btn-close" onclick="window.hideModal()" aria-label="Close"></button>
      </div>
    </div>

    <!-- Top section - Ticket Information -->
    <div class="ticket-info">
      <h5>Ticket Information</h5>
      <div class="info-row">
        <div class="info-label">Subject:</div>
        <div class="info-value" id="ticket-subject">Loading...</div>
      </div>
      <div class="info-row">
        <div class="info-label">Status:</div>
        <div class="info-value" id="ticket-status">Loading...</div>
      </div>
      <div class="info-row">
        <div class="info-label">Priority:</div>
        <div class="info-value" id="ticket-priority">Loading...</div>
      </div>
      <div class="info-row">
        <div class="info-label">Type:</div>
        <div class="info-value" id="ticket-type">Loading...</div>
      </div>
    </div>
    
    <!-- Bottom section - Tabbed Interface -->
    <div class="tab-container">
      <ul class="nav nav-tabs" id="ticketTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="similar-tickets-tab" data-bs-toggle="tab" data-bs-target="#similar-tickets" 
          type="button" role="tab" aria-controls="similar-tickets" aria-selected="true">Similar Tickets</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="suggested-solutions-tab" data-bs-toggle="tab" data-bs-target="#suggested-solutions" 
          type="button" role="tab" aria-controls="suggested-solutions" aria-selected="false">Suggested Solutions</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="copilot-tab" data-bs-toggle="tab" data-bs-target="#copilot" 
          type="button" role="tab" aria-controls="copilot" aria-selected="false">Copilot</button>
      </li>
    </ul>
    <div class="tab-content" id="ticketTabsContent">
      <div class="tab-pane fade show active" id="similar-tickets" role="tabpanel" aria-labelledby="similar-tickets-tab">
        <!-- Similar Tickets List/Detail View -->
        <div id="similar-tickets-list-view">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6>Similar Tickets</h6>
            <button class="btn btn-sm btn-outline-primary" id="refresh-similar-tickets">Refresh</button>
          </div>
          <div id="similar-tickets-list">
            <div class="placeholder-text">Loading similar tickets...</div>
          </div>
        </div>
        <div id="similar-tickets-detail-view" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-sm btn-outline-secondary" id="back-to-similar-list">← Back to List</button>
            <button class="btn btn-sm btn-outline-primary" id="open-ticket-link">Open in Freshdesk</button>
          </div>
          <div id="similar-ticket-detail-content">
            <!-- Detail content will be loaded here -->
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="suggested-solutions" role="tabpanel" aria-labelledby="suggested-solutions-tab">
        <!-- Suggested Solutions List/Detail View -->
        <div id="solutions-list-view">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6>Suggested Solutions</h6>
            <button class="btn btn-sm btn-outline-primary" id="refresh-solutions">Refresh</button>
          </div>
          <div id="suggested-solutions-list">
            <div class="placeholder-text">Loading suggested solutions...</div>
          </div>
        </div>
        <div id="solutions-detail-view" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-sm btn-outline-secondary" id="back-to-solutions-list">← Back to List</button>
            <button class="btn btn-sm btn-outline-success" id="use-solution">Use This Solution</button>
          </div>
          <div id="solution-detail-content">
            <!-- Detail content will be loaded here -->
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="copilot" role="tabpanel" aria-labelledby="copilot-tab">
        <!-- AI Chat Interface -->
        <div class="chat-interface">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6>AI Assistant</h6>
            <button class="btn btn-sm btn-outline-danger" id="clear-chat">Clear Chat</button>
          </div>
          <div id="chat-messages" class="chat-messages mb-3">
            <div class="chat-message assistant">
              <strong>AI:</strong> 안녕하세요! 이 티켓에 대해 어떤 도움이 필요하신가요?
            </div>
          </div>
          <div class="chat-input-container">
            <div class="input-group mb-2">
              <input type="text" class="form-control" id="chat-input" placeholder="질문을 입력하세요...">
              <button class="btn btn-primary" id="chat-search-button">Send</button>
            </div>
            <div class="search-options">
              <small class="text-muted">검색 범위:</small>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="search-tickets" value="tickets" checked>
                <label class="form-check-label" for="search-tickets">Tickets</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="search-solutions" value="solutions" checked>
                <label class="form-check-label" for="search-solutions">Solutions</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="search-images" value="images">
                <label class="form-check-label" for="search-images">Images</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="search-attachments" value="attachments">
                <label class="form-check-label" for="search-attachments">Attachments</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div> <!-- tab-container 닫는 태그 -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{{appclient}}}"></script>
  <script src="scripts/globals.js"></script>
  <script src="scripts/utils.js"></script>
  <script src="scripts/api.js"></script>
  <script src="scripts/sidebar-progress.js"></script>
  <script src="scripts/data.js"></script>
  <script src="scripts/ui.js"></script>
  <script src="scripts/events.js"></script>
  <script src="scripts/app.js"></script>

  <!-- 🎯 FDK 컨텍스트 감지 스크립트 -->
  <script>
    // FDK 컨텍스트 감지 (사이드바 vs 모달 구분)
    window.isFDKModal = (
      window.location.search.includes('modal=true') ||
      window.location.search.includes('isModal=true') ||
      window.location.pathname.includes('iframe/agent') ||  // FDK 모달 URL 패턴
      (typeof window.modalData !== 'undefined' && window.modalData)
    );
    
    // 사이드바 컨텍스트 감지
    window.isSidebar = (
      window.location.search.includes('sidebar=true') ||
      (window.parent !== window && !window.isFDKModal) // iframe이지만 모달이 아닌 경우
    );
    
    // 컨텍스트별 초기화 로직
    document.addEventListener('DOMContentLoaded', function() {
      if (window.location.hostname === 'localhost') {
        console.log('🔍 FDK 컨텍스트 분석:');
        console.log('   - isFDKModal:', window.isFDKModal);
        console.log('   - isSidebar:', window.isSidebar);
        console.log('   - URL:', window.location.href);
      }
      
      // 실제 사이드바 컨텍스트인지 더 정확히 판단
      const isActualSidebar = (
        window.isSidebar && 
        !window.isFDKModal && 
        !window.location.search.includes('modal=true') &&
        window.parent !== window && 
        !window.location.search.includes('isModal=true')
      );
      
      // 실제 사이드바 컨텍스트에서만 로딩 UI 표시
      if (isActualSidebar) {
        console.log('📊 실제 사이드바 컨텍스트 - 로딩 UI만 표시');
        
        // 메인 콘텐츠 숨기고 로딩만 표시
        const mainContent = document.querySelector('.container-fluid');
        if (mainContent) {
          mainContent.style.display = 'none';
        }
        
        // 사이드바 전용 로딩 UI 생성 (예쁘게 데코레이션)
        const loadingDiv = document.createElement('div');
        loadingDiv.innerHTML = `
          <div id="sidebar-loading-only" style="padding: 16px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; margin: 8px; color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
            <div style="font-size: 22px; margin-bottom: 10px; animation: bounce 2s infinite;">🤖</div>
            <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">AI 분석 진행 중</div>
            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 16px;">티켓을 분석하여 인사이트를 생성하고 있습니다</div>
            <div style="display: flex; justify-content: center; gap: 4px; margin-bottom: 8px;">
              <div style="width: 6px; height: 6px; background-color: rgba(255,255,255,0.7); border-radius: 50%; animation: pulse 1.5s infinite 0s;"></div>
              <div style="width: 6px; height: 6px; background-color: rgba(255,255,255,0.7); border-radius: 50%; animation: pulse 1.5s infinite 0.3s;"></div>
              <div style="width: 6px; height: 6px; background-color: rgba(255,255,255,0.7); border-radius: 50%; animation: pulse 1.5s infinite 0.6s;"></div>
            </div>
            <div style="font-size: 10px; opacity: 0.7;">잠시만 기다려 주세요...</div>
          </div>
          <style>
            @keyframes bounce {
              0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
              40% { transform: translateY(-8px); }
              60% { transform: translateY(-4px); }
            }
            @keyframes pulse {
              0%, 100% { opacity: 0.3; transform: scale(0.8); }
              50% { opacity: 1; transform: scale(1.2); }
            }
          </style>
        `;
        document.body.appendChild(loadingDiv);
        
        return; // 사이드바에서는 여기서 종료
      }
      
      if (window.isFDKModal) {
        if (window.location.hostname === 'localhost') {
          console.log('🎯 FDK 모달 모드 - 데이터 로드 및 렌더링 시작');
        }
        handleFDKModalMode();
      } else {
        if (window.location.hostname === 'localhost') {
          console.log('📋 표준 앱 모드 - 전체 앱 초기화 실행');
        }
        initializeFullApp();
      }
    });
    
    // FDK 모달 모드 처리 (캐시된 데이터로 렌더링)
    function handleFDKModalMode() {
      console.log('🎯 FDK 모달 모드: 안전한 렌더링 시작');
      
      // 즉시 기본 UI 표시 (로딩 상태 방지)
      const container = document.querySelector('.container-fluid');
      if (container) {
        container.style.display = 'block';
        container.style.visibility = 'visible';
      }
      
      // EventAPI 오류를 피하기 위해 안전한 초기화 방식 사용
      setTimeout(() => {
        // 모든 필수 모듈 확인
        if (window.GlobalState && window.API && window.Data && window.UI && window.Events) {
          // EventAPI 오류를 방지하는 안전한 초기화
          initializeModalSafely();
        } else {
          // 모듈 로드 대기 후 재시도 (로그 최소화)
          let retryCount = 0;
          const retryInterval = setInterval(() => {
            retryCount++;
            if (window.GlobalState && window.API && window.Data && window.UI && window.Events) {
              clearInterval(retryInterval);
              initializeModalSafely();
            } else if (retryCount > 10) {
              clearInterval(retryInterval);
              console.error('❌ 필수 모듈 로드 실패 - 폴백 표시');
              displayFallbackModalContent();
            }
          }, 200);
        }
      }, 50);
    }
    
    // 모달에서 안전한 초기화 (EventAPI 오류 방지)
    function initializeModalSafely() {
      try {
        console.log('🎯 모달 안전 초기화 시작');
        
        // GlobalState 초기화 (EventAPI 호출 없음)
        if (window.GlobalState && !window.GlobalState.getInitialized()) {
          window.GlobalState.init();
        }
        
        // 백엔드에서 받은 캐시된 데이터 확인
        if (window.GlobalState) {
          const globalData = window.GlobalState.getGlobalTicketData();
          
          console.log('📊 모달에서 전역 데이터 상태:', {
            hasSummary: !!globalData.summary,
            hasTicketInfo: !!globalData.ticket_info,
            similarTicketsCount: globalData.similar_tickets?.length || 0,
            kbDocumentsCount: globalData.kb_documents?.length || 0,
            cachedTicketId: globalData.cached_ticket_id,
            lastLoadTime: globalData.lastLoadTime,
            fullData: globalData // 전체 데이터 확인용
          });
          
          // 데이터가 있으면 즉시 UI 업데이트 (EventAPI 호출 없음)
          if (globalData.summary || globalData.ticket_info || globalData.similar_tickets?.length > 0) {
            console.log('📋 캐시된 데이터로 모달 UI 업데이트 시작');
            updateModalUIWithData(globalData);
          } else {
            console.log('ℹ️ 캐시된 데이터 없음 - 스트리밍 상태 확인 후 처리');
            
            // 스트리밍 중인지 확인
            const streamingStatus = window.GlobalState.getStreamingStatus();
            if (streamingStatus.is_streaming) {
              console.log('🌊 현재 스트리밍 진행 중 - 진행률 기반 UI 표시');
              showStreamingProgressInModal(streamingStatus);
              
              // 스트리밍 완료 시까지 대기
              waitForStreamingCompletion();
            } else {
              console.log('💤 스트리밍 없음 - AI 로딩 메시지 표시 후 데이터 로딩');
              showAILoadingMessage();
              tryLoadDataSafely();
            }
          }
        }
        
        console.log('✅ 모달 초기화 완료');
      } catch (error) {
        console.error('❌ 모달 초기화 중 오류:', error);
        displayFallbackModalContent();
      }
    }
    
    // 안전한 데이터 로딩 시도 (타임아웃 적용)
    function tryLoadDataSafely() {
      if (window.Data && window.Data.preloadTicketDataOnPageLoad) {
        console.log('🔄 모달에서 안전한 데이터 로딩 시도 (10초 타임아웃)');
        
        // 안전한 클라이언트 객체 생성 (EventAPI 우회)
        const safeClient = createSafeClient();
        
        // 타임아웃 적용된 Promise
        const loadPromise = window.Data.preloadTicketDataOnPageLoad(safeClient);
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('데이터 로딩 타임아웃 (10초)')), 10000);
        });
        
        Promise.race([loadPromise, timeoutPromise]).then((result) => {
          if (result) {
            const newGlobalData = window.GlobalState.getGlobalTicketData();
            updateModalUIWithData(newGlobalData);
            console.log('✅ 모달에서 데이터 로딩 성공');
          } else {
            console.warn('⚠️ 데이터 로딩 결과 없음 - 기본 콘텐츠 표시');
            showDefaultModalContent();
          }
        }).catch((error) => {
          console.error('❌ 모달에서 데이터 로딩 실패:', error);
          showDefaultModalContent();
        });
      } else {
        console.warn('⚠️ Data 모듈 또는 preloadTicketDataOnPageLoad 함수 없음');
        showDefaultModalContent();
      }
    }
    
    // 안전한 클라이언트 객체 생성 (EventAPI 우회)
    function createSafeClient() {
      return {
        // 최소한의 인터페이스만 제공
        data: {
          get: () => Promise.reject('EventAPI not available in modal')
        },
        interface: {
          trigger: () => Promise.reject('EventAPI not available in modal')
        },
        instance: {
          context: () => Promise.resolve({ location: 'modal' })
        }
      };
    }
    
    // 모달 UI 업데이트 (EventAPI 호출 없음)
    function updateModalUIWithData(globalData) {
      try {
        console.log('🔄 모달 UI 업데이트 시작:', globalData);
        
        let updatedCount = 0;
        
        // 더 강력한 데이터 체크 및 폴백
        const hasAnyData = globalData.summary || globalData.ticket_info || 
                          (globalData.similar_tickets && globalData.similar_tickets.length > 0) ||
                          (globalData.kb_documents && globalData.kb_documents.length > 0) ||
                          (globalData.recommended_solutions && globalData.recommended_solutions.length > 0);
        
        if (!hasAnyData) {
          console.warn('⚠️ 모달 업데이트할 데이터가 없음 - 기본 메시지 유지');
          return;
        }
        
        // 티켓 정보 업데이트 (최우선)
        if (globalData.ticket_info) {
          console.log('📋 티켓 정보 업데이트:', globalData.ticket_info);
          updateTicketInfoInModal(globalData.ticket_info);
          updatedCount++;
        } else {
          // 티켓 정보가 없으면 기본 정보라도 표시
          console.log('📋 티켓 정보 없음 - 기본 정보 표시');
          updateTicketInfoInModal({
            subject: globalData.cached_ticket_id ? `티켓 #${globalData.cached_ticket_id}` : '티켓 정보',
            status: 'Unknown',
            priority: 'Unknown',
            type: 'General'
          });
          updatedCount++;
        }
        
        // 요약 정보 업데이트
        if (globalData.summary) {
          console.log('📄 요약 정보 업데이트:', globalData.summary.substring(0, 100) + '...');
          updateSummaryInModal(globalData.summary);
          updatedCount++;
        }
        
        // 유사 티켓 업데이트
        if (globalData.similar_tickets && globalData.similar_tickets.length > 0) {
          console.log('🔍 유사 티켓 업데이트:', globalData.similar_tickets.length + '개');
          updateSimilarTicketsInModal(globalData.similar_tickets);
          updatedCount++;
        }
        
        // KB 문서 업데이트
        if (globalData.kb_documents && globalData.kb_documents.length > 0) {
          console.log('📚 KB 문서 업데이트:', globalData.kb_documents.length + '개');
          updateKbDocumentsInModal(globalData.kb_documents);
          updatedCount++;
        }
        
        // recommended_solutions도 KB 문서로 처리
        if (globalData.recommended_solutions && globalData.recommended_solutions.length > 0) {
          console.log('💡 추천 솔루션 업데이트:', globalData.recommended_solutions.length + '개');
          updateKbDocumentsInModal(globalData.recommended_solutions);
          updatedCount++;
        }
        
        console.log(`✅ 모달 UI 업데이트 완료 (${updatedCount}개 섹션)`);
        
        // Loading 텍스트를 모두 제거
        removeLoadingTexts();
        
        // 업데이트 성공 표시
        setTimeout(() => {
          console.log('🎉 모달 데이터 렌더링 완료! 사용자가 내용을 확인할 수 있습니다.');
        }, 500);
        
      } catch (error) {
        console.error('❌ 모달 UI 업데이트 중 오류:', error);
        console.error('Stack:', error.stack);
      }
    }
    
    // Loading 텍스트 제거
    function removeLoadingTexts() {
      const loadingElements = document.querySelectorAll('.placeholder-text');
      loadingElements.forEach(el => {
        if (el.textContent.includes('Loading') || el.textContent.includes('로딩')) {
          el.style.display = 'none';
        }
      });
    }
    
    // 기본 모달 콘텐츠 표시
    function showDefaultModalContent() {
      const container = document.querySelector('.container-fluid');
      if (container) {
        // 기본 UI는 그대로 두고 로딩 메시지만 제거
        const loadingElements = container.querySelectorAll('.placeholder-text');
        loadingElements.forEach(el => {
          if (el.textContent.includes('Loading') || el.textContent.includes('로딩')) {
            el.textContent = '데이터를 준비 중입니다...';
          }
        });
      }
    }
    
    // 기본 모달 콘텐츠 표시 (업그레이드된 버전)
    function showBasicModalContent() {
      console.log('🔄 기본 모달 콘텐츠 표시');
      
      // 티켓 정보 섹션에 기본값 설정
      const subjectEl = document.getElementById('ticket-subject');
      if (subjectEl && subjectEl.textContent === 'Loading...') {
        subjectEl.textContent = '티켓 정보를 불러오는 중...';
      }
      
      const statusEl = document.getElementById('ticket-status');
      if (statusEl && statusEl.textContent === 'Loading...') {
        statusEl.textContent = '상태 확인 중...';
      }
      
      const priorityEl = document.getElementById('ticket-priority');
      if (priorityEl && priorityEl.textContent === 'Loading...') {
        priorityEl.textContent = '우선순위 확인 중...';
      }
      
      const typeEl = document.getElementById('ticket-type');
      if (typeEl && typeEl.textContent === 'Loading...') {
        typeEl.textContent = '유형 확인 중...';
      }
      
      // placeholder-text 요소들도 업데이트
      const placeholderElements = document.querySelectorAll('.placeholder-text');
      placeholderElements.forEach(el => {
        if (el.textContent.includes('Loading')) {
          el.textContent = 'AI 분석 데이터를 준비하고 있습니다...';
        }
      });
    }
    
    // AI 데이터 준비 중 메시지 (이쁘게 데코레이션)
    function showAILoadingMessage() {
      console.log('🤖 AI 데이터 준비 중 메시지 표시');
      
      // 티켓 정보 섹션을 더 친근하게
      const subjectEl = document.getElementById('ticket-subject');
      if (subjectEl) {
        subjectEl.innerHTML = '🎯 AI가 티켓을 분석하고 있습니다...';
      }
      
      const statusEl = document.getElementById('ticket-status');
      if (statusEl) {
        statusEl.innerHTML = '⚡ 상태 분석 중...';
      }
      
      const priorityEl = document.getElementById('ticket-priority');
      if (priorityEl) {
        priorityEl.innerHTML = '🔍 우선순위 평가 중...';
      }
      
      const typeEl = document.getElementById('ticket-type');
      if (typeEl) {
        typeEl.innerHTML = '📋 카테고리 분류 중...';
      }
      
      // 탭 콘텐츠에도 로딩 메시지
      const summaryContainer = document.getElementById('ticket-summary-content');
      if (summaryContainer) {
        summaryContainer.innerHTML = `
          <div class="alert alert-info text-center" style="border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px;">
            <div style="font-size: 24px; margin-bottom: 12px;">🤖</div>
            <h6 style="margin-bottom: 8px; color: white;">AI 분석 진행 중</h6>
            <div style="font-size: 14px; opacity: 0.9;">티켓 내용을 분석하여 요약과 추천을 생성하고 있습니다...</div>
            <div style="margin-top: 12px;">
              <div class="spinner-border spinner-border-sm" role="status" style="width: 1.5rem; height: 1.5rem; border-width: 2px;">
                <span class="visually-hidden">로딩 중...</span>
              </div>
            </div>
          </div>
        `;
      }
      
      // placeholder-text 요소들 업데이트
      const placeholderElements = document.querySelectorAll('.placeholder-text');
      placeholderElements.forEach(el => {
        el.innerHTML = `
          <div class="text-center py-4">
            <div style="font-size: 20px; margin-bottom: 8px;">🔍</div>
            <div style="color: #6c757d;">AI가 관련 정보를 찾고 있습니다...</div>
          </div>
        `;
      });
    }
    
    // 스트리밍 진행률을 모달에 표시
    function showStreamingProgressInModal(streamingStatus) {
      console.log('🌊 모달에서 스트리밍 진행률 표시:', streamingStatus);
      
      const summaryContainer = document.getElementById('ticket-summary-content');
      if (summaryContainer) {
        summaryContainer.innerHTML = `
          <div class="alert alert-info text-center" style="border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px;">
            <div style="font-size: 24px; margin-bottom: 12px;">🌊</div>
            <h6 style="margin-bottom: 8px; color: white;">실시간 AI 분석 중</h6>
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 16px;">진행률: ${streamingStatus.overall_progress}%</div>
            
            <div style="background: rgba(255,255,255,0.2); border-radius: 8px; padding: 12px; margin: 16px 0;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 12px;">전체 진행률</span>
                <span style="font-size: 12px; font-weight: bold;">${streamingStatus.overall_progress}%</span>
              </div>
              <div style="width: 100%; background: rgba(255,255,255,0.3); border-radius: 4px; height: 6px; overflow: hidden;">
                <div style="width: ${streamingStatus.overall_progress}%; background: white; height: 100%; transition: width 0.3s ease;"></div>
              </div>
            </div>
            
            <div style="font-size: 11px; opacity: 0.8;">
              ${Object.entries(streamingStatus.stages).map(([stage, data]) => 
                `${data.completed ? '✅' : '⏳'} ${stage}`
              ).join(' • ')}
            </div>
          </div>
        `;
      }
      
      // 티켓 정보도 진행률 기반으로 업데이트
      const stages = Object.keys(streamingStatus.stages);
      stages.forEach((stage, index) => {
        const stageData = streamingStatus.stages[stage];
        if (stageData.completed) {
          // 완료된 단계에 따라 UI 업데이트
          updateTicketInfoBasedOnStage(stage, index + 1, stages.length);
        }
      });
    }
    
    // 스트리밍 완료 대기
    function waitForStreamingCompletion() {
      const checkInterval = setInterval(() => {
        if (window.GlobalState) {
          const streamingStatus = window.GlobalState.getStreamingStatus();
          
          // 진행률 업데이트
          showStreamingProgressInModal(streamingStatus);
          
          // 스트리밍 완료 시
          if (!streamingStatus.is_streaming && streamingStatus.overall_progress === 100) {
            clearInterval(checkInterval);
            console.log('🎉 스트리밍 완료 - 최종 데이터로 모달 업데이트');
            
            // 최종 데이터로 UI 업데이트
            const finalData = window.GlobalState.getGlobalTicketData();
            updateModalUIWithData(finalData);
          }
          
          // 에러 발생 시
          if (streamingStatus.error) {
            clearInterval(checkInterval);
            console.error('❌ 스트리밍 에러 발생:', streamingStatus.error);
            showAILoadingMessage(); // 폴백으로 기본 로딩 메시지
            tryLoadDataSafely(); // 안전한 방식으로 재시도
          }
        }
      }, 500);
      
      // 10초 후 타임아웃 (무한 대기 방지)
      setTimeout(() => {
        clearInterval(checkInterval);
        console.warn('⏰ 스트리밍 대기 타임아웃 - 폴백 처리');
        tryLoadDataSafely();
      }, 10000);
    }
    
    // 스트리밍 단계별 티켓 정보 업데이트
    function updateTicketInfoBasedOnStage(stage, completed, total) {
      const progress = Math.round((completed / total) * 100);
      
      const subjectEl = document.getElementById('ticket-subject');
      const statusEl = document.getElementById('ticket-status');
      const priorityEl = document.getElementById('ticket-priority');
      const typeEl = document.getElementById('ticket-type');
      
      if (stage === 'ticket_fetch' && subjectEl) {
        subjectEl.innerHTML = '📋 티켓 정보 수집 완료';
      }
      if (stage === 'summary' && statusEl) {
        statusEl.innerHTML = '🎯 AI 요약 생성 완료';
      }
      if (stage === 'similar_tickets' && priorityEl) {
        priorityEl.innerHTML = '🔍 유사 티켓 검색 완료';
      }
      if (stage === 'kb_documents' && typeEl) {
        typeEl.innerHTML = '📚 지식베이스 검색 완료';
      }
    }
    
    // 티켓 정보 업데이트 (모달용)
    function updateTicketInfoInModal(ticketInfo) {
      try {
        console.log('🔄 티켓 정보 업데이트 시작:', ticketInfo);
        
        // 기본 정보를 먼저 Loading... 텍스트에서 변경
        const subjectEl = document.getElementById('ticket-subject');
        if (subjectEl) {
          subjectEl.textContent = ticketInfo.subject || ticketInfo.title || 'No Subject';
          console.log('✅ Subject 업데이트:', subjectEl.textContent);
        }
        
        const statusEl = document.getElementById('ticket-status');
        if (statusEl) {
          statusEl.textContent = ticketInfo.status || 'Unknown';
          console.log('✅ Status 업데이트:', statusEl.textContent);
        }
        
        const priorityEl = document.getElementById('ticket-priority');
        if (priorityEl) {
          priorityEl.textContent = ticketInfo.priority || 'Medium';
          console.log('✅ Priority 업데이트:', priorityEl.textContent);
        }
        
        const typeEl = document.getElementById('ticket-type');
        if (typeEl) {
          typeEl.textContent = ticketInfo.type || 'General';
          console.log('✅ Type 업데이트:', typeEl.textContent);
        }
        
        console.log('✅ 티켓 정보 업데이트 완료');
      } catch (error) {
        console.error('❌ 티켓 정보 업데이트 실패:', error);
      }
    }
    
    // 요약 정보 업데이트 (모달용)
    function updateSummaryInModal(summary) {
      try {
        console.log('🔄 요약 정보 업데이트 시작:', summary);
        
        // 첫 번째 탭의 콘텐츠를 요약으로 업데이트
        const summaryContainer = document.getElementById('ticket-summary-content');
        if (summaryContainer && summary) {
          summaryContainer.innerHTML = `
            <div class="alert alert-primary">
              <h6>📋 AI 티켓 요약</h6>
              <div style="white-space: pre-wrap; line-height: 1.5;">${summary}</div>
              <small class="text-muted mt-2 d-block">생성 시간: ${new Date().toLocaleString()}</small>
            </div>
          `;
          console.log('✅ 요약 정보 업데이트 완료');
        }
        
        // placeholder-text 요소도 함께 처리
        const placeholderElements = document.querySelectorAll('.placeholder-text');
        placeholderElements.forEach(el => {
          if (el.textContent.includes('Loading') || el.textContent.includes('로딩')) {
            el.innerHTML = `<div class="alert alert-info">${summary}</div>`;
          }
        });
      } catch (error) {
        console.error('❌ 요약 정보 업데이트 실패:', error);
      }
    }
    
    // 유사 티켓 업데이트 (모달용)
    function updateSimilarTicketsInModal(similarTickets) {
      try {
        const container = document.getElementById('similar-tickets-list');
        if (container && similarTickets.length > 0) {
          container.innerHTML = similarTickets.map(ticket => `
            <div class="list-item">
              <div class="list-item-header">
                <div class="list-item-title">${ticket.subject || ticket.title || 'No Subject'}</div>
                <span class="score-badge">${Math.round((ticket.score || 0) * 100)}%</span>
              </div>
              <div class="list-item-meta">
                ID: ${ticket.id} | Status: ${ticket.status || 'Unknown'}
              </div>
              <div class="list-item-excerpt">
                ${ticket.description || ticket.excerpt || '내용 없음'}
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('❌ 유사 티켓 업데이트 실패:', error);
      }
    }
    
    // KB 문서 업데이트 (모달용)
    function updateKbDocumentsInModal(kbDocuments) {
      try {
        const container = document.getElementById('suggested-solutions-list');
        if (container && kbDocuments.length > 0) {
          container.innerHTML = kbDocuments.map(doc => `
            <div class="list-item solution-card">
              <div class="list-item-header">
                <div class="list-item-title">${doc.title || doc.subject || 'No Title'}</div>
                <span class="score-badge">${Math.round((doc.score || 0) * 100)}%</span>
              </div>
              <div class="list-item-meta">
                Type: ${doc.type || 'KB Article'}
              </div>
              <div class="list-item-excerpt solution-excerpt">
                ${doc.description || doc.content || doc.excerpt || '내용 없음'}
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('❌ KB 문서 업데이트 실패:', error);
      }
    }
    
    // 기본 모달 콘텐츠 표시 (데이터 로딩 실패 시)
    function showDefaultModalContent() {
      console.log('📄 기본 모달 콘텐츠 표시');
      
      const subjectEl = document.getElementById('ticket-subject');
      if (subjectEl) {
        subjectEl.textContent = '티켓 정보를 불러오는 중...';
      }
      
      const statusEl = document.getElementById('ticket-status');
      if (statusEl) {
        statusEl.textContent = '상태 확인 중...';
      }
      
      const priorityEl = document.getElementById('ticket-priority');
      if (priorityEl) {
        priorityEl.textContent = '우선순위 확인 중...';
      }
      
      const typeEl = document.getElementById('ticket-type');
      if (typeEl) {
        typeEl.textContent = '유형 확인 중...';
      }
      
      // 탭 콘텐츠도 기본 메시지로
      const summaryContainer = document.getElementById('ticket-summary-content');
      if (summaryContainer) {
        summaryContainer.innerHTML = `
          <div class="alert alert-secondary text-center">
            <h6>📋 티켓 분석</h6>
            <p>AI 분석 결과를 준비하고 있습니다.</p>
            <small class="text-muted">데이터 로딩 중...</small>
          </div>
        `;
      }
      
      const placeholderElements = document.querySelectorAll('.placeholder-text');
      placeholderElements.forEach(el => {
        el.innerHTML = `
          <div class="text-center py-3">
            <div class="text-muted">데이터를 불러오는 중...</div>
          </div>
        `;
      });
    }
    
    // 폴백 모달 컨텐츠 표시 (에러 발생 시)
    function displayFallbackModalContent() {
      console.warn('⚠️ 폴백 모달 콘텐츠 표시');
      
      const container = document.querySelector('.container-fluid');
      if (container) {
        container.innerHTML = `
          <div class="alert alert-warning text-center">
            <h5>⚠️ 일시적인 문제</h5>
            <p>AI 분석 서비스에 일시적인 문제가 발생했습니다.</p>
            <p>페이지를 새로고침하거나 잠시 후 다시 시도해 주세요.</p>
            <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
              🔄 새로고침
            </button>
          </div>
        `;
      }
    }
    
    // 모달 컨텐츠 표시
    function displayModalContent(title, content) {
      const container = document.getElementById('ticket-summary-content');
      if (container) {
        container.innerHTML = `
          <div class="alert alert-info">
            <h5>${title}</h5>
            <div>${content || '내용 없음'}</div>
            <small class="text-muted">시간: ${new Date().toLocaleString()}</small>
          </div>
        `;
      }
    }
    
    // 전체 앱 초기화 (모달에서도 동작)
    function initializeFullApp() {
      console.log('🚀 전체 앱 초기화 시작');
      
      // GlobalState 초기화
      if (window.GlobalState && !window.GlobalState.getInitialized()) {
        window.GlobalState.init();
        console.log('✅ GlobalState 초기화 완료');
      }
      
      // 백엔드에서 받은 데이터가 있는지 확인
      if (window.GlobalState) {
        const globalData = window.GlobalState.getGlobalTicketData();
        console.log('📊 현재 전역 데이터 상태:', {
          hasSummary: !!globalData.summary,
          hasTicketInfo: !!globalData.ticket_info,
          similarTicketsCount: globalData.similar_tickets?.length || 0,
          kbDocumentsCount: globalData.kb_documents?.length || 0
        });
        
        // 캐시된 데이터가 있으면 즉시 UI 업데이트
        if (globalData.summary || globalData.ticket_info) {
          console.log('📋 캐시된 데이터로 UI 업데이트 시작');
          
          if (window.UI && window.UI.updateUIWithCachedData) {
            window.UI.updateUIWithCachedData(globalData);
          } else if (window.UI && window.UI.updateTicketSummaryCard) {
            // 개별 UI 업데이트 함수들 호출
            if (globalData.ticket_info) {
              window.UI.updateTicketInfo(globalData.ticket_info);
            }
            if (globalData.summary) {
              window.UI.updateTicketSummaryCard(globalData.summary);
            }
            if (globalData.similar_tickets && globalData.similar_tickets.length > 0) {
              window.UI.displaySimilarTicketsList(globalData.similar_tickets);
            }
            if (globalData.kb_documents && globalData.kb_documents.length > 0) {
              window.UI.displayRecommendedSolutions(globalData.kb_documents);
            }
          } else {
            console.warn('⚠️ UI 모듈의 데이터 업데이트 함수를 찾을 수 없음');
          }
        } else {
          console.log('ℹ️ 캐시된 데이터 없음 - 기본 UI 표시');
        }
      }
      
      // App 객체가 있으면 초기화
      if (typeof window.App !== 'undefined' && window.App.initialize) {
        window.App.initialize();
      }
      
      console.log('✅ 전체 앱 초기화 완료');
    }
  </script>
</body>
</html>