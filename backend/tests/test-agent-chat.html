<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÉÅÎã¥Ïõê Ï±ÑÌåÖ Î™®Îìú ÌÖåÏä§Ìä∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .chat-header p {
            margin: 8px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fafafa;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }

        .message.user .message-avatar {
            background: #667eea;
        }

        .message.assistant .message-avatar {
            background: #764ba2;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .message.system .message-content {
            background: #e3f2fd;
            color: #1976d2;
            font-style: italic;
            max-width: 100%;
            text-align: center;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-config {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .config-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .config-group label {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
        }

        .config-group input, .config-group select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .config-group input[type="checkbox"] {
            margin: 0;
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }

        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .send-button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .send-button:hover:not(:disabled) {
            background: #5a6fd8;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 10px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .typing-indicator {
            display: inline-block;
        }

        .typing-indicator span {
            display: inline-block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: #667eea;
            margin: 0 1px;
            animation: typing 1.4s ease-in-out infinite both;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #d32f2f;
        }

        .streaming-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .metadata {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }

        .search-results {
            margin-top: 15px;
        }

        .result-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px 15px;
            margin-bottom: 12px;
            transition: all 0.15s ease;
            cursor: pointer;
        }

        .result-card:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .result-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            flex: 1;
            margin-right: 10px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .result-relevance {
            color: #28a745;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            min-width: 45px;
        }

        .result-meta {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-type {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .result-type.ticket {
            background: #28a745;
        }

        .result-type.article {
            background: #17a2b8;
        }

        .result-link {
            color: #667eea;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
        }

        .result-link:hover {
            text-decoration: underline;
        }

        .ai-summary {
            background: #e8f4f8;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }

        .ai-summary-title {
            font-weight: 600;
            color: #17a2b8;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .progress-step {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 0 8px 8px 0;
            animation: fadeInSlide 0.3s ease-out;
        }

        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>ü§ñ ÏÉÅÎã¥Ïõê Ï±ÑÌåÖ Î™®Îìú ÌÖåÏä§Ìä∏</h1>
            <p>POST /query with agent_mode=true</p>
        </div>

        <div class="chat-messages" id="messages">
            <div class="message system">
                <div class="message-content">
                    ÏÉÅÎã¥Ïõê Ï±ÑÌåÖ Î™®ÎìúÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§. Constitutional AIÍ∞Ä Ï†ÅÏö©Îêú ÏïàÏ†ÑÌïòÍ≥† Ïú†Ïö©Ìïú Í≤ÄÏÉâ Í≤∞Í≥ºÎ•º Ï†úÍ≥µÌï©ÎãàÎã§.
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-config">
                <div class="config-group">
                    <label>
                        <input type="checkbox" id="agentMode" checked> ÏÉÅÎã¥Ïõê Î™®Îìú
                    </label>
                </div>
                <div class="config-group">
                    <label>
                        <input type="checkbox" id="streamResponse" checked> Ïä§Ìä∏Î¶¨Î∞ç
                    </label>
                </div>
                <div class="config-group">
                    <label>
                        <input type="checkbox" id="constitutionalAI" checked> Constitutional AI
                    </label>
                </div>
                <div class="config-group">
                    <label>ÏùòÎèÑ:</label>
                    <select id="forceIntent">
                        <option value="">ÏûêÎèô</option>
                        <option value="problem_solving">Î¨∏Ï†ú Ìï¥Í≤∞</option>
                        <option value="info_gathering">Ï†ïÎ≥¥ ÏàòÏßë</option>
                        <option value="learning">ÌïôÏäµ</option>
                        <option value="analysis">Î∂ÑÏÑù</option>
                    </select>
                </div>
                <div class="config-group">
                    <label>Ïö∞ÏÑ†ÏàúÏúÑ:</label>
                    <select id="urgencyOverride">
                        <option value="">ÏûêÎèô</option>
                        <option value="immediate">Ï¶âÏãú</option>
                        <option value="today">Ïò§Îäò</option>
                        <option value="general">ÏùºÎ∞ò</option>
                        <option value="reference">Ï∞∏Í≥†</option>
                    </select>
                </div>
                <div class="config-group">
                    <label>API URL:</label>
                    <input type="text" id="apiUrl" value="http://localhost:8000/query" style="width: 200px;">
                </div>
            </div>
            
            <div class="chat-config">
                <div class="config-group">
                    <label>Tenant ID:</label>
                    <input type="text" id="tenantId" value="wedosoft" style="width: 100px;">
                </div>
                <div class="config-group">
                    <label>Platform:</label>
                    <input type="text" id="platform" value="freshdesk" style="width: 80px;">
                </div>
                <div class="config-group">
                    <label>API Key:</label>
                    <input type="text" id="apiKey" value="Ug9H1cKCZZtZ4haamBy" style="width: 150px;">
                </div>
                <div class="config-group">
                    <label>Domain:</label>
                    <input type="text" id="domain" value="wedosoft" style="width: 100px;">
                </div>
            </div>

            <div class="chat-input-form">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="messageInput" 
                    placeholder="ÏÉÅÎã¥Ïõê ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî... (Ïòà: 'API Ïò§Î•ò Ìã∞Ïºì Ï∞æÏïÑÏ§ò', 'Í≤∞Ï†ú Î¨∏Ï†ú Ìï¥Í≤∞ Î∞©Î≤ï')"
                    maxlength="500"
                >
                <button class="send-button" id="sendButton" onclick="sendMessage()">Ï†ÑÏÜ°</button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <span id="loadingText">AIÍ∞Ä ÏùëÎãµÏùÑ ÏÉùÏÑ±Ï§ëÏûÖÎãàÎã§...</span>
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let messageId = 0;

        // ÏÉÅÎã¥Ïõê ÏπúÌôîÏ†Å ÏùëÎãµ Ìè¨Îß∑ÌåÖ - Ï†ÑÎ¨∏Ï†ÅÏù¥Í≥† Ïã§Ïö©Ï†ÅÏù∏ ÌÜ§
        function formatAgentFriendlyResponse(aiResponse, responseData) {
            const context = responseData.search_context || {};
            const totalResults = responseData.total_results || 0;
            const qualityScore = responseData.quality_score || 0;
            
            let formattedResponse = '';
            
            if (totalResults > 0) {
                // ÏÉÅÌô© Î∂ÑÏÑù Î∞è Ïö∞ÏÑ†ÏàúÏúÑ ÌëúÏãú
                const urgency = context.urgency || 'general';
                const intent = context.intent || 'unknown';
                
                formattedResponse += `<div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2196f3;">`;
                formattedResponse += `<strong>üìä ÏÉÅÌô© Î∂ÑÏÑù</strong><br><br>`;
                
                // Ïö∞ÏÑ†ÏàúÏúÑÎ≥Ñ ÎåÄÏùë Í∞ÄÏù¥Îìú
                if (urgency === 'immediate') {
                    formattedResponse += `üî¥ <strong>Í∏¥Í∏â ÎåÄÏùë ÌïÑÏöî</strong> - Ï¶âÏãú Ï≤òÎ¶¨ÌïòÏãúÍ≥† Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î≥¥Í≥†Ìï¥Ï£ºÏÑ∏Ïöî<br>`;
                } else if (urgency === 'today') {
                    formattedResponse += `üü° <strong>ÎãπÏùº Ï≤òÎ¶¨ Í∂åÏû•</strong> - Ïò§Îäò Ï§ëÏúºÎ°ú ÏôÑÎ£åÌïòÏãúÎ©¥ Îê©ÎãàÎã§<br>`;
                } else {
                    formattedResponse += `üü¢ <strong>ÏùºÎ∞ò Ï≤òÎ¶¨</strong> - ÌëúÏ§Ä ÏùëÎãµ ÏãúÍ∞Ñ ÎÇ¥ Ï≤òÎ¶¨ÌïòÏãúÎ©¥ Îê©ÎãàÎã§<br>`;
                }
                
                // ÏùòÎèÑÎ≥Ñ Ï†ëÍ∑º Î∞©Ïãù
                if (intent === 'problem_solving') {
                    formattedResponse += `üîß <strong>Î¨∏Ï†ú Ìï¥Í≤∞ Î¨∏Ïùò</strong> - Îã®Í≥ÑÎ≥Ñ Ìï¥Í≤∞Ï±Ö Ï†úÏãúÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§<br>`;
                } else if (intent === 'info_gathering') {
                    formattedResponse += `üìö <strong>Ï†ïÎ≥¥ ÏöîÏ≤≠</strong> - Ï†ïÌôïÌïú Ï†ïÎ≥¥ Ï†ÑÎã¨Ïóê ÏßëÏ§ëÌï¥Ï£ºÏÑ∏Ïöî<br>`;
                } else {
                    formattedResponse += `üí¨ <strong>ÏùºÎ∞ò Î¨∏Ïùò</strong> - Í≥†Í∞ù ÎãàÏ¶à ÌååÏïÖ ÌõÑ Ï†ÅÏ†àÌïú ÏïàÎÇ¥Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§<br>`;
                }
                
                formattedResponse += `üìà <strong>Ïã†Î¢∞ÎèÑ ${Math.round(qualityScore * 100)}%</strong> - Í≤ÄÏÉâÎêú ${totalResults}Í∞ú Î¨∏ÏÑú Í∏∞Î∞ò<br>`;
                formattedResponse += `</div>`;
                
                // AI ÏöîÏïΩÏùÑ Îçî Í∞ÑÍ≤∞ÌïòÍ≥† Ïã§Ïö©Ï†ÅÏúºÎ°ú
                formattedResponse += `<div style="background: #ffffff; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">`;
                formattedResponse += `<strong>üéØ ÌïµÏã¨ ÎÇ¥Ïö©</strong><br><br>`;
                
                // AI ÏùëÎãµÏùÑ Îçî Í∞ÑÍ≤∞ÌïòÍ≤å Ìè¨Îß∑
                let cleanedResponse = aiResponse
                    .replace(/<search_analysis>[\s\S]*?<\/search_analysis>/g, '')
                    .replace(/<search_strategy>[\s\S]*?<\/search_strategy>/g, '')
                    .replace(/<primary_results>/g, '')
                    .replace(/<\/primary_results>/g, '')
                    .trim();
                
                formattedResponse += cleanedResponse;
                formattedResponse += `</div>`;
                
                // Ïã§Î¨¥ Í∞ÄÏù¥Îìú
                formattedResponse += `<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">`;
                formattedResponse += `<strong>üíº ÏÉÅÎã¥ ÏßÑÌñâ Í∞ÄÏù¥Îìú</strong><br><br>`;
                
                if (intent === 'problem_solving') {
                    formattedResponse += `<strong>1Ô∏è‚É£ Î¨∏Ï†ú ÏÉÅÌô© ÌôïÏù∏</strong><br>`;
                    formattedResponse += `‚Ä¢ Ïñ∏Ï†úÎ∂ÄÌÑ∞ Î∞úÏÉùÌñàÎäîÏßÄ, Ïñ¥Îñ§ ÏÉÅÌô©ÏóêÏÑú Î∞úÏÉùÌïòÎäîÏßÄ Ï†ïÌôïÌûà ÌååÏïÖÌïòÏÑ∏Ïöî<br><br>`;
                    formattedResponse += `<strong>2Ô∏è‚É£ Ìï¥Í≤∞Ï±Ö Ï†úÏãú</strong><br>`;
                    formattedResponse += `‚Ä¢ ÏïÑÎûò Í¥ÄÎ†® Î¨∏ÏÑúÎ•º Ï∞∏Í≥†ÌïòÏó¨ Îã®Í≥ÑÎ≥ÑÎ°ú ÏïàÎÇ¥Ìï¥Ï£ºÏÑ∏Ïöî<br>`;
                    formattedResponse += `‚Ä¢ Í≥†Í∞ùÏù¥ Îî∞ÎùºÌï† Ïàò ÏûàÎèÑÎ°ù ÏâΩÍ≤å ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî<br><br>`;
                    formattedResponse += `<strong>3Ô∏è‚É£ ÌõÑÏÜç Ï°∞Ïπò</strong><br>`;
                    formattedResponse += `‚Ä¢ Ìï¥Í≤∞ÎêòÏßÄ ÏïäÏúºÎ©¥ Í∏∞Ïà†ÌåÄ Ìã∞Ïºì ÏÉùÏÑ±ÏùÑ Í≥†Î†§ÌïòÏÑ∏Ïöî<br>`;
                } else if (intent === 'info_gathering') {
                    formattedResponse += `<strong>1Ô∏è‚É£ Ï†ïÎ≥¥ Ï†úÍ≥µ</strong><br>`;
                    formattedResponse += `‚Ä¢ ÏïÑÎûò ÏûêÎ£åÎ•º Î∞îÌÉïÏúºÎ°ú Ï†ïÌôïÌïòÍ≥† ÏµúÏã† Ï†ïÎ≥¥Î•º Ï†ÑÎã¨ÌïòÏÑ∏Ïöî<br><br>`;
                    formattedResponse += `<strong>2Ô∏è‚É£ Ï∂îÍ∞Ä ÏïàÎÇ¥</strong><br>`;
                    formattedResponse += `‚Ä¢ Í¥ÄÎ†®Îêú Îã§Î•∏ Ï†ïÎ≥¥ÎÇò Ï£ºÏùòÏÇ¨Ìï≠ÎèÑ Ìï®Íªò ÏïàÎÇ¥Ìï¥Ï£ºÏÑ∏Ïöî<br><br>`;
                    formattedResponse += `<strong>3Ô∏è‚É£ ÌôïÏù∏</strong><br>`;
                    formattedResponse += `‚Ä¢ Í≥†Í∞ùÏù¥ ÏõêÌïòÎäî Ï†ïÎ≥¥Î•º Ï∂©Î∂ÑÌûà Î∞õÏïòÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî<br>`;
                } else {
                    formattedResponse += `<strong>1Ô∏è‚É£ ÎãàÏ¶à ÌååÏïÖ</strong><br>`;
                    formattedResponse += `‚Ä¢ Í≥†Í∞ùÏù¥ Ï†ïÌôïÌûà Î¨¥ÏóáÏùÑ ÏõêÌïòÎäîÏßÄ Î®ºÏ†Ä ÌôïÏù∏ÌïòÏÑ∏Ïöî<br><br>`;
                    formattedResponse += `<strong>2Ô∏è‚É£ ÎßûÏ∂§ ÏïàÎÇ¥</strong><br>`;
                    formattedResponse += `‚Ä¢ ÌååÏïÖÎêú ÎãàÏ¶àÏóê Îî∞Îùº ÏïÑÎûò ÏûêÎ£åÎ•º ÌôúÏö©Ìï¥ ÏïàÎÇ¥ÌïòÏÑ∏Ïöî<br><br>`;
                    formattedResponse += `<strong>3Ô∏è‚É£ ÎßåÏ°±ÎèÑ ÌôïÏù∏</strong><br>`;
                    formattedResponse += `‚Ä¢ ÏïàÎÇ¥Í∞Ä ÎèÑÏõÄÏù¥ ÎêòÏóàÎäîÏßÄ ÎßàÏßÄÎßâÏóê ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî<br>`;
                }
                
                formattedResponse += `</div>`;
                
            } else {
                formattedResponse += `<div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">`;
                formattedResponse += `<strong>‚ö†Ô∏è Í¥ÄÎ†® ÏûêÎ£åÎ•º Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§</strong><br><br>`;
                formattedResponse += `<strong>Îã§Ïùå Îã®Í≥ÑÎ°ú ÏßÑÌñâÌï¥Ï£ºÏÑ∏Ïöî:</strong><br><br>`;
                formattedResponse += `<strong>1Ô∏è‚É£ Ï∂îÍ∞Ä Ï†ïÎ≥¥ ÏàòÏßë</strong><br>`;
                formattedResponse += `‚Ä¢ Í≥†Í∞ùÏóêÍ≤å Îçî Íµ¨Ï≤¥Ï†ÅÏù∏ Ï†ïÎ≥¥Î•º ÏöîÏ≤≠ÌïòÏÑ∏Ïöî<br>`;
                formattedResponse += `‚Ä¢ Îã§Î•∏ ÌÇ§ÏõåÎìúÎÇò Í¥ÄÎ†® Ïö©Ïñ¥Î°ú Ïû¨Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî<br><br>`;
                formattedResponse += `<strong>2Ô∏è‚É£ ÏóêÏä§Ïª¨Î†àÏù¥ÏÖò</strong><br>`;
                formattedResponse += `‚Ä¢ Ï†ÑÎ¨∏ÌåÄÏù¥ÎÇò ÏÉÅÍ∏âÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî<br>`;
                formattedResponse += `‚Ä¢ Ïú†ÏÇ¨Ìïú Ïù¥Ï†Ñ ÏºÄÏù¥Ïä§Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî<br><br>`;
                formattedResponse += `<strong>3Ô∏è‚É£ Í≥†Í∞ù ÏïàÎÇ¥</strong><br>`;
                formattedResponse += `‚Ä¢ Ï°∞ÏÇ¨Í∞Ä ÌïÑÏöîÌïòÎã§Í≥† ÏÜîÏßÅÌïòÍ≤å ÏïàÎÇ¥ÌïòÏÑ∏Ïöî<br>`;
                formattedResponse += `‚Ä¢ ÎãµÎ≥Ä ÏòàÏÉÅ ÏãúÍ∞ÑÏùÑ ÏïåÎ†§Ï£ºÏÑ∏Ïöî<br>`;
                formattedResponse += `</div>`;
            }
            
            return formattedResponse;
        }

        // ÏóîÌÑ∞ÌÇ§Î°ú Î©îÏãúÏßÄ Ï†ÑÏÜ°
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Î©îÏãúÏßÄ Ï∂îÍ∞Ä Ìï®Ïàò
        function addMessage(role, content, metadata = null) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.id = `msg-${++messageId}`;

            if (role === 'system') {
                messageDiv.innerHTML = `
                    <div class="message-content">${content}</div>
                `;
            } else {
                const avatar = role === 'user' ? 'üë§' : 'ü§ñ';
                messageDiv.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        <div class="streaming-content">${content}</div>
                        ${metadata ? `<div class="metadata">${metadata}</div>` : ''}
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return messageDiv;
        }

        // Í≤ÄÏÉâ Í≤∞Í≥ºÎ•º Ïπ¥Îìú ÌòïÌÉúÎ°ú Î†åÎçîÎßÅ (ÎπÑÏä§Ìä∏Î¶¨Î∞çÏö©)
        function renderSearchResults(searchResults, context) {
            const documents = searchResults.documents || [];
            const metadatas = searchResults.metadatas || [];
            const distances = searchResults.distances || [];
            
            if (documents.length === 0) {
                return '<div class="search-results"><p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</p></div>';
            }
            
            let html = '<div class="search-results"><h4>üìã Í¥ÄÎ†® Î¨∏ÏÑú Î∞è Ìã∞Ïºì</h4><div class="results-container">';
            
            for (let i = 0; i < documents.length; i++) {
                const doc = documents[i];
                const meta = metadatas[i] || {};
                const distance = distances[i] || 1;
                
                const title = meta.title || meta.subject || `Î¨∏ÏÑú ${i + 1}`;
                const docType = meta.doc_type || 'unknown';
                const sourceUrl = meta.source_url || '#';
                const displayUrl = meta.display_url || 'ÏõêÎ≥∏ Î≥¥Í∏∞';
                const relevance = Math.round((1 - distance/2) * 100);
                
                // Î¨∏ÏÑú ÌÉÄÏûÖÏóê Îî∞Î•∏ ÏïÑÏù¥ÏΩò
                const typeIcon = docType === 'ticket' ? 'üé´' : 
                                docType === 'article' ? 'üìñ' : 'üìÑ';
                
                html += `
                    <div class="result-card" onclick="window.open('${sourceUrl}', '_blank')">
                        <div class="result-header">
                            <div class="result-title">${typeIcon} ${title}</div>
                            <span class="result-relevance">${relevance}%</span>
                        </div>
                        <div class="result-meta">
                            <span class="result-type ${docType}">${docType}</span>
                            <a href="${sourceUrl}" target="_blank" class="result-link" onclick="event.stopPropagation()">
                                ${displayUrl}
                            </a>
                        </div>
                    </div>
                `;
            }
            
            html += '</div></div>';
            return html;
        }

        // Ïä§Ìä∏Î¶¨Î∞ç Î©îÏãúÏßÄ ÏóÖÎç∞Ïù¥Ìä∏ (ÏôÑÏ†ÑÌûà ÏÉàÎ°úÏö¥ ÏïàÏ†ÑÌïú Î∞©Ïãù)
        function updateStreamingMessage(messageDiv, content, metadata = null) {
            console.log('üîÑ [CRITICAL] updateStreamingMessage Ìò∏Ï∂ú ÏãúÏûë');
            
            if (!messageDiv) {
                console.error('‚ùå messageDivÍ∞Ä nullÏûÖÎãàÎã§');
                return;
            }
            
            // ÌòÑÏû¨ DOM Íµ¨Ï°∞ ÏôÑÏ†Ñ Î∂ÑÏÑù
            console.log('üìã DOM Î∂ÑÏÑù ÏãúÏûë:');
            console.log('- messageDiv ID:', messageDiv.id);
            console.log('- messageDiv className:', messageDiv.className);
            console.log('- messageDiv children count:', messageDiv.children.length);
            
            // Î™®Îì† ÏûêÏãù ÏöîÏÜå Ï∂úÎ†•
            for (let i = 0; i < messageDiv.children.length; i++) {
                const child = messageDiv.children[i];
                console.log(`  - Child ${i}:`, child.className, child.tagName);
            }
            
            // .message-content Ï∞æÍ∏∞
            let messageContent = messageDiv.querySelector('.message-content');
            console.log('üîç .message-content Ï∞æÍ∏∞:', messageContent ? 'FOUND' : 'NOT FOUND');
            
            if (!messageContent) {
                console.error('‚ùå .message-contentÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                console.log('Ï†ÑÏ≤¥ messageDiv Íµ¨Ï°∞:', messageDiv.outerHTML);
                return;
            }
            
            // .streaming-content Ï∞æÍ∏∞/ÏÉùÏÑ±
            let streamingContent = messageContent.querySelector('.streaming-content');
            console.log('üîç .streaming-content Ï∞æÍ∏∞:', streamingContent ? 'FOUND' : 'NOT FOUND');
            
            if (!streamingContent) {
                console.log('üö® .streaming-content ÏÉùÏÑ± ÌïÑÏöî');
                // ÏÉàÎ°ú ÏÉùÏÑ±
                streamingContent = document.createElement('div');
                streamingContent.className = 'streaming-content';
                
                // Í∏∞Ï°¥ ÎÇ¥Ïö©Ïù¥ ÏûàÏúºÎ©¥ Î≥¥Ï°¥
                if (messageContent.innerHTML.trim()) {
                    streamingContent.innerHTML = messageContent.innerHTML;
                }
                
                // Í∏∞Ï°¥ ÎÇ¥Ïö© ÏßÄÏö∞Í≥† ÏÉà div Ï∂îÍ∞Ä
                messageContent.innerHTML = '';
                messageContent.appendChild(streamingContent);
                
                console.log('‚úÖ .streaming-content ÏÉùÏÑ± ÏôÑÎ£å');
            }
            
            // Ïª®ÌÖêÏ∏† ÏóÖÎç∞Ïù¥Ìä∏
            if (content) {
                console.log('üéØ Ïª®ÌÖêÏ∏† ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë');
                console.log('- ÏóÖÎç∞Ïù¥Ìä∏Ìï† Ïª®ÌÖêÏ∏† Í∏∏Ïù¥:', content.length);
                
                try {
                    streamingContent.innerHTML = content;
                    
                    // ÏóÖÎç∞Ïù¥Ìä∏ Í≤ÄÏ¶ù
                    const updatedLength = streamingContent.innerHTML.length;
                    console.log('‚úÖ Ïª®ÌÖêÏ∏† ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ:', updatedLength, 'Í∏ÄÏûê');
                    
                    // Ïã§Ï†ú ÌôîÎ©¥ Î∞òÏòÅ Í∞ïÏ†ú
                    streamingContent.style.display = 'block';
                    streamingContent.offsetHeight; // reflow Í∞ïÏ†ú Î∞úÏÉù
                    
                } catch (e) {
                    console.error('‚ùå Ïª®ÌÖêÏ∏† ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', e);
                    // ÏïàÏ†ÑÌïú fallback
                    streamingContent.textContent = 'Content update failed';
                }
            }
            
            // Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
            if (metadata) {
                console.log('üìù Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏');
                let metadataDiv = messageContent.querySelector('.metadata');
                
                if (!metadataDiv) {
                    metadataDiv = document.createElement('div');
                    metadataDiv.className = 'metadata';
                    messageContent.appendChild(metadataDiv);
                }
                
                metadataDiv.innerHTML = metadata;
                console.log('‚úÖ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
            }

            // ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏ Í∞ïÏ†ú Î∞è Ïä§ÌÅ¨Î°§
            requestAnimationFrame(() => {
                const messagesContainer = document.getElementById('messages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
                console.log('üìú Î†åÎçîÎßÅ Î∞è Ïä§ÌÅ¨Î°§ ÏôÑÎ£å');
            });
            
            console.log('üèÅ updateStreamingMessage ÏôÑÎ£å');
        }

        // Î©îÏãúÏßÄ Ï†ÑÏÜ°
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const loading = document.getElementById('loading');
            
            const message = input.value.trim();
            if (!message) return;

            // UI ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            input.value = '';
            sendButton.disabled = true;
            loading.classList.add('show');
            document.getElementById('loadingText').textContent = 'ÏöîÏ≤≠ÏùÑ Ï≤òÎ¶¨ Ï§ëÏûÖÎãàÎã§...';

            // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ Ï∂îÍ∞Ä
            addMessage('user', message);

            // ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±
            const requestData = {
                query: message.substring(0, 1000), // Î©îÏãúÏßÄ Í∏∏Ïù¥ Ï†úÌïú
                tenant_id: document.getElementById('tenantId').value,
                platform: document.getElementById('platform').value,
                agent_mode: document.getElementById('agentMode').checked,
                enable_constitutional_ai: document.getElementById('constitutionalAI').checked,
                stream_response: document.getElementById('streamResponse').checked,
                use_hybrid_search: false,
                top_k: 5
            };

            // JSON ÏßÅÎ†¨Ìôî ÌÖåÏä§Ìä∏
            try {
                const testJson = JSON.stringify(requestData);
                console.log('‚úÖ JSON ÏßÅÎ†¨Ìôî ÏÑ±Í≥µ, ÌÅ¨Í∏∞:', testJson.length);
            } catch (e) {
                console.error('‚ùå JSON ÏßÅÎ†¨Ìôî Ïã§Ìå®:', e);
                addMessage('system', `‚ùå ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ Ïò§Î•ò: ${e.message}`);
                return;
            }

            // ÏÑ†ÌÉùÏ†Å ÌïÑÎìú Ï∂îÍ∞Ä
            const forceIntent = document.getElementById('forceIntent').value;
            if (forceIntent) requestData.force_intent = forceIntent;

            const urgencyOverride = document.getElementById('urgencyOverride').value;
            if (urgencyOverride) requestData.urgency_override = urgencyOverride;

            const apiUrl = document.getElementById('apiUrl').value;

            try {
                if (requestData.stream_response) {
                    await handleStreamingResponse(apiUrl, requestData);
                } else {
                    await handleNormalResponse(apiUrl, requestData);
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('system', `‚ùå Ïò§Î•ò Î∞úÏÉù: ${error.message}`);
            } finally {
                sendButton.disabled = false;
                loading.classList.remove('show');
            }
        }

        // Ïä§Ìä∏Î¶¨Î∞ç ÏùëÎãµ Ï≤òÎ¶¨
        async function handleStreamingResponse(apiUrl, requestData) {
            console.log('üöÄ Ïä§Ìä∏Î¶¨Î∞ç ÏöîÏ≤≠ ÏãúÏûë:', {
                apiUrl,
                requestData,
                timestamp: new Date().toISOString()
            });
            
            const headers = {
                'Content-Type': 'application/json',
                'X-Tenant-ID': document.getElementById('tenantId').value,
                'X-Platform': document.getElementById('platform').value
            };
            
            // API KeyÍ∞Ä ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
            const apiKey = document.getElementById('apiKey').value;
            if (apiKey) {
                headers['X-API-Key'] = apiKey;
            }
            
            // DomainÏù¥ ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
            const domain = document.getElementById('domain').value;
            if (domain) {
                headers['X-Domain'] = domain;
            }
            
            console.log('üìù ÏöîÏ≤≠ Ìó§Îçî:', headers);
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestData)
            });
            
            console.log('üìû ÏùëÎãµ ÏÉÅÌÉú:', {
                status: response.status,
                statusText: response.statusText,
                headers: Object.fromEntries(response.headers.entries())
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Ïò§Î•ò ÏùëÎãµ:', errorText);
                throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            let assistantMessage = addMessage('assistant', '‚è≥ ÏùëÎãµ Ï§ÄÎπÑÏ§ë...');
            let currentContent = '';
            let finalMetadata = '';

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            console.log('üìØ ÏàòÏã†Îêú Îç∞Ïù¥ÌÑ∞ Î¨∏ÏûêÏó¥:', dataStr);
                            
                            if (dataStr === '[DONE]') {
                                console.log('‚úÖ Ïä§Ìä∏Î¶¨Î∞ç ÏôÑÎ£å Ïã†Ìò∏ ÏàòÏã†');
                                return;
                            }

                            try {
                                const data = JSON.parse(dataStr);
                                console.log('üì¶ ÌååÏã±Îêú Ïä§Ìä∏Î¶¨Î∞ç Îç∞Ïù¥ÌÑ∞:', data);
                                console.log('üîé Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖ Ï≤¥ÌÅ¨:', data.type);
                                
                                // Ïä§Ìä∏Î¶¨Î∞ç Îã®Í≥ÑÎ≥Ñ Ï≤òÎ¶¨ - Î∞±ÏóîÎìú Ïù¥Î≤§Ìä∏ ÌÉÄÏûÖÏóê ÎßûÏ∂∞ ÏàòÏ†ï
                                if (data.type === 'analysis' || data.type === 'analysis_complete') {
                                    currentContent = `<div class="progress-step">üîç <strong>ÏùòÎèÑ Î∂ÑÏÑù ÏôÑÎ£å</strong><br><span style="color: #666;">${data.content || 'Í≥†Í∞ù Î¨∏Ïùò ÏùòÎèÑÎ•º ÌååÏïÖÌñàÏäµÎãàÎã§.'}</span></div>`;
                                    document.getElementById('loadingText').textContent = 'Í≤ÄÏÉâÏùÑ ÏãúÏûëÌï©ÎãàÎã§...';
                                } else if (data.type === 'search' || data.type === 'search_start') {
                                    currentContent += `<div class="progress-step">üîé <strong>Í¥ÄÎ†® Î¨∏ÏÑú Í≤ÄÏÉâ Ï§ë...</strong><br><span style="color: #666;">${data.content || 'Í¥ÄÎ†® Î¨∏ÏÑúÎ•º Ï∞æÍ≥† ÏûàÏäµÎãàÎã§.'}</span></div>`;
                                    document.getElementById('loadingText').textContent = 'Í∞ÄÏû• Í¥ÄÎ†®ÏÑ± ÎÜíÏùÄ Î¨∏ÏÑúÎì§ÏùÑ Ï∞æÍ≥† ÏûàÏäµÎãàÎã§...';
                                } else if (data.type === 'processing') {
                                    currentContent += `<div class="progress-step">‚öôÔ∏è <strong>Í≤ÄÏÉâ Í≤∞Í≥º Î∂ÑÏÑù Ï§ë...</strong><br><span style="color: #666;">${data.content}</span></div>`;
                                    document.getElementById('loadingText').textContent = 'Í≤ÄÏÉâÎêú ÏûêÎ£åÎì§ÏùÑ Ï†ïÎ¶¨ÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                                } else if (data.type === 'generating') {
                                    currentContent += `<div class="progress-step">ü§ñ <strong>ÏÉÅÎã¥ Í∞ÄÏù¥Îìú ÏÉùÏÑ± Ï§ë...</strong><br><span style="color: #666;">${data.content}</span></div>`;
                                    document.getElementById('loadingText').textContent = 'ÏÉÅÎã¥ÏõêÏùÑ ÏúÑÌïú ÎßûÏ∂§ Í∞ÄÏù¥ÎìúÎ•º ÏûëÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                                } else if (data.type === 'response') {
                                    currentContent += `<div class="progress-step">‚úÖ <strong>Ï§ÄÎπÑ ÏôÑÎ£å</strong><br><span style="color: #666;">${data.content || 'ÏÉÅÎã¥ ÏûêÎ£å Ï§ÄÎπÑÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.'}</span></div>`;
                                    document.getElementById('loadingText').textContent = 'ÏÉÅÎã¥ ÏûêÎ£å Ï§ÄÎπÑ ÏôÑÎ£å';
                                } else if (data.type === 'search_result_item') {
                                    // Í∞úÎ≥Ñ Í≤ÄÏÉâ Í≤∞Í≥º ÏïÑÏù¥ÌÖú Ïä§Ìä∏Î¶¨Î∞ç
                                    console.log('üîç [CRITICAL] Í≤ÄÏÉâ Í≤∞Í≥º ÏïÑÏù¥ÌÖú ÏàòÏã†!!! üîç', data);
                                    const resultData = data.result_data || {};
                                    console.log('üìã Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞:', resultData);
                                    
                                    const streamingContentDiv = assistantMessage.querySelector('.streaming-content');
                                    const existingContent = streamingContentDiv ? streamingContentDiv.innerHTML : '';
                                    
                                    // Í∏∞Ï°¥ Í≤ÄÏÉâ Í≤∞Í≥º ÏòÅÏó≠Ïù¥ ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
                                    if (!existingContent.includes('search-results')) {
                                        console.log('üèóÔ∏è Í≤ÄÏÉâ Í≤∞Í≥º ÏòÅÏó≠ ÏÉùÏÑ±');
                                        const newContent = `
                                            <div class="progress-step">‚úÖ <strong>Í≤ÄÏÉâ ÏôÑÎ£å</strong><br><span style="color: #666;">Í¥ÄÎ†® Î¨∏ÏÑúÎ•º Ï∞æÏïòÏäµÎãàÎã§.</span></div>
                                            <div class="search-results">
                                                <h4>üìã Í¥ÄÎ†® Î¨∏ÏÑú Î∞è Ìã∞Ïºì</h4>
                                                <div class="results-container"></div>
                                            </div>
                                        `;
                                        updateStreamingMessage(assistantMessage, newContent);
                                        console.log('üèóÔ∏è Í≤ÄÏÉâ Í≤∞Í≥º ÏòÅÏó≠ ÏÉùÏÑ± ÏôÑÎ£å');
                                    }
                                    
                                    // ÏÉàÎ°úÏö¥ Í≤∞Í≥º Ïπ¥Îìú Ï∂îÍ∞Ä
                                    const doc = resultData.document;
                                    const meta = resultData.metadata || {};
                                    const distance = resultData.distance || 1;
                                    const index = resultData.index || 0;
                                    
                                    console.log('üì¶ Î¶¨Ïñº Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞:', {
                                        document_length: doc ? doc.length : 0,
                                        metadata_keys: Object.keys(meta),
                                        distance: distance,
                                        index: index
                                    });
                                    
                                    console.log('üìã Ïπ¥Îìú ÏÉùÏÑ± Îç∞Ïù¥ÌÑ∞:', {
                                        document: doc ? doc.substring(0, 100) + '...' : 'null',
                                        metadata: meta,
                                        distance: distance,
                                        index: index
                                    });
                                    
                                    const title = meta.title || meta.subject || `Î¨∏ÏÑú ${index + 1}`;
                                    const docType = meta.doc_type || 'unknown';
                                    const sourceUrl = meta.source_url || '#';
                                    const displayUrl = meta.display_url || 'ÏõêÎ≥∏ Î≥¥Í∏∞';
                                    const relevance = Math.round((1 - distance/2) * 100);
                                    
                                    console.log('üè∑Ô∏è Ïπ¥Îìú Î©îÌÉÄÎç∞Ïù¥ÌÑ∞:', {
                                        title, docType, sourceUrl, displayUrl, relevance
                                    });
                                    
                                    const typeIcon = docType === 'ticket' ? 'üé´' : 
                                                    docType === 'article' ? 'üìñ' : 'üìÑ';
                                    
                                    const cardHtml = `
                                        <div class="result-card" onclick="window.open('${sourceUrl}', '_blank')">
                                            <div class="result-header">
                                                <div class="result-title">${typeIcon} ${title}</div>
                                                <span class="result-relevance">${relevance}%</span>
                                            </div>
                                            <div class="result-meta">
                                                <span class="result-type ${docType}">${docType}</span>
                                                <a href="${sourceUrl}" target="_blank" class="result-link" onclick="event.stopPropagation()">
                                                    ${displayUrl}
                                                </a>
                                            </div>
                                        </div>
                                    `;
                                    
                                    console.log('üè∑Ô∏è ÏÉùÏÑ±Îêú Ïπ¥Îìú HTML:', cardHtml);
                                    
                                    // Í≤∞Í≥º Ïª®ÌÖåÏù¥ÎÑàÏóê Ïπ¥Îìú Ï∂îÍ∞Ä - Îçî ÏïàÏ†ÑÌïú Î∞©Ïãù
                                    let resultsContainer = assistantMessage.querySelector('.results-container');
                                    console.log('üìÅ Í≤∞Í≥º Ïª®ÌÖåÏù¥ÎÑà Ï∞æÍ∏∞:', resultsContainer);
                                    
                                    if (!resultsContainer) {
                                        console.log('üö® Í≤∞Í≥º Ïª®ÌÖåÏù¥ÎÑà ÏóÜÏùå - Í∞ïÏ†ú ÏÉùÏÑ±');
                                        // Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä ÏóÜÏúºÎ©¥ Í∞ïÏ†úÎ°ú ÏÉùÏÑ±
                                        const streamingContent = assistantMessage.querySelector('.streaming-content');
                                        if (streamingContent) {
                                            const searchResultsHtml = `
                                                <div class="progress-step">‚úÖ <strong>Í≤ÄÏÉâ ÏôÑÎ£å</strong><br><span style="color: #666;">Í¥ÄÎ†® Î¨∏ÏÑúÎ•º Ï∞æÏïòÏäµÎãàÎã§.</span></div>
                                                <div class="search-results">
                                                    <h4>üìã Í¥ÄÎ†® Î¨∏ÏÑú Î∞è Ìã∞Ïºì</h4>
                                                    <div class="results-container"></div>
                                                </div>
                                            `;
                                            streamingContent.innerHTML = searchResultsHtml;
                                            resultsContainer = streamingContent.querySelector('.results-container');
                                            console.log('‚úÖ Ïª®ÌÖåÏù¥ÎÑà Í∞ïÏ†ú ÏÉùÏÑ± ÏôÑÎ£å');
                                        }
                                    }
                                    
                                    if (resultsContainer) {
                                        console.log('üìÅ Ïπ¥Îìú Ï∂îÍ∞Ä ÏãúÎèÑ:', {
                                            existing_cards: resultsContainer.children.length,
                                            card_html_length: cardHtml.length
                                        });
                                        
                                        // Ïπ¥Îìú HTMLÏùÑ DOM ÏöîÏÜåÎ°ú ÏÉùÏÑ±
                                        const cardElement = document.createElement('div');
                                        cardElement.innerHTML = cardHtml;
                                        const cardDiv = cardElement.firstElementChild;
                                        
                                        // Ïª®ÌÖåÏù¥ÎÑàÏóê Ï∂îÍ∞Ä
                                        resultsContainer.appendChild(cardDiv);
                                        
                                        console.log('‚úÖ Ïπ¥Îìú Ï∂îÍ∞Ä ÏôÑÎ£å:', {
                                            total_cards: resultsContainer.children.length,
                                            card_title: title
                                        });
                                        
                                        // Ïä§ÌÅ¨Î°§ ÏóÖÎç∞Ïù¥Ìä∏
                                        setTimeout(() => {
                                            const messages = document.getElementById('messages');
                                            messages.scrollTop = messages.scrollHeight;
                                        }, 50);
                                    } else {
                                        console.error('‚ùå Í≤∞Í≥º Ïª®ÌÖåÏù¥ÎÑà ÏÉùÏÑ± Ïã§Ìå®');
                                        console.log('assistantMessage Ï†ÑÏ≤¥ Íµ¨Ï°∞:', assistantMessage.outerHTML);
                                    }
                                    
                                    console.log(`‚ú® Í≤ÄÏÉâ Í≤∞Í≥º ${index + 1} Ïä§Ìä∏Î¶¨Î∞ç ÏôÑÎ£å`);
                                } else if (data.type === 'search_complete') {
                                    // Í≤ÄÏÉâ ÏôÑÎ£å Ïãú Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏
                                    console.log('üèÅ Í≤ÄÏÉâ ÏôÑÎ£å Ïù¥Î≤§Ìä∏:', data);
                                    const headerElement = assistantMessage.querySelector('.search-results h4');
                                    if (headerElement && data.total_results > 0) {
                                        headerElement.textContent = `üìã Í¥ÄÎ†® Î¨∏ÏÑú Î∞è Ìã∞Ïºì (${data.total_results}Í∞ú)`;
                                        console.log('üè∑Ô∏è Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                                    } else {
                                        console.log('üî¥ Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: headerElement=', headerElement, ', total_results=', data.total_results);
                                    }
                                    console.log('‚úÖ Í≤ÄÏÉâ Ïä§Ìä∏Î¶¨Î∞ç ÏôÑÎ£å');
                                } else if (data.type === 'final') {
                                    const context = data.search_context || {};
                                    
                                    // AI ÏöîÏïΩ ÏùëÎãµ - ÏÉÅÎã¥Ïõê ÏπúÌôîÏ†Å ÌÜ§ÏúºÎ°ú Í∞úÏÑ†
                                    let aiSummary = data.ai_summary || data.structured_response || 'Í≤ÄÏÉâÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.';
                                    
                                    // ÏÉÅÎã¥ÏõêÏùÑ ÏúÑÌïú ÏπúÏ†àÌïú ÏÑ§Î™ÖÏúºÎ°ú Î≥ÄÌôò
                                    aiSummary = formatAgentFriendlyResponse(aiSummary, data);
                                    console.log('AI Summary:', aiSummary);
                                    
                                    // Í∏∞Ï°¥ Í≤ÄÏÉâ Í≤∞Í≥º Ïú†ÏßÄÌïòÍ≥† AI ÏöîÏïΩÎßå Ï∂îÍ∞Ä
                                    const existingContent = assistantMessage.querySelector('.streaming-content').innerHTML;
                                    
                                    // ÏßÑÌñâ Îã®Í≥Ñ Î©îÏãúÏßÄÎì§ÏùÑ Ï†úÍ±∞ÌïòÍ≥† AI ÏöîÏïΩÎßå ÌëúÏãú
                                    const hasSearchResults = existingContent.includes('search-results');
                                    
                                    if (hasSearchResults) {
                                        // Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏûàÏúºÎ©¥ Í∏∞Ï°¥ Í≤ÄÏÉâ Í≤∞Í≥º ÏúÑÏóê AI ÏöîÏïΩ Ï∂îÍ∞Ä
                                        const searchResultsMatch = existingContent.match(/<div class="search-results">.*<\/div><\/div>/s);
                                        const searchResultsHtml = searchResultsMatch ? searchResultsMatch[0] : '';
                                        
                                        currentContent = `
                                            <div class="ai-summary">
                                                <div class="ai-summary-title">ü§ñ ÏÉÅÎã¥ Í∞ÄÏù¥Îìú</div>
                                                ${aiSummary}
                                            </div>
                                            ${searchResultsHtml}
                                        `;
                                    } else {
                                        // Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏúºÎ©¥ AI ÏöîÏïΩÎßå ÌëúÏãú
                                        currentContent = `
                                            <div class="ai-summary">
                                                <div class="ai-summary-title">ü§ñ ÏÉÅÎã¥ Í∞ÄÏù¥Îìú</div>
                                                ${aiSummary}
                                            </div>
                                        `;
                                    }
                                    
                                    // Í∏∞Î≥∏ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞
                                    finalMetadata = `
                                        <strong>Í≤ÄÏÉâ Ï†ïÎ≥¥:</strong><br>
                                        ‚Ä¢ ÏùòÎèÑ: ${context.intent || 'unknown'}<br>
                                        ‚Ä¢ Ïö∞ÏÑ†ÏàúÏúÑ: ${context.urgency || 'unknown'}<br>
                                        ‚Ä¢ ÌÇ§ÏõåÎìú: ${context.keywords ? context.keywords.join(', ') : 'none'}<br>
                                        ‚Ä¢ Í≤ÄÏÉâ Í≤∞Í≥º: ${data.total_results || 0}Í∞ú<br>
                                        ‚Ä¢ ÌíàÏßà Ï†êÏàò: ${data.quality_score ? (data.quality_score * 100).toFixed(1) : 0}%
                                    `;
                                    
                                    document.getElementById('loadingText').textContent = 'ÏôÑÎ£å';
                                    // Ïä§Ìä∏Î¶¨Î∞ç ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏
                                    updateStreamingMessage(assistantMessage, currentContent, finalMetadata);
                                    // ÏµúÏ¢Ö Í≤∞Í≥ºÏù¥ÎØÄÎ°ú Ïä§Ìä∏Î¶º Ï¢ÖÎ£å
                                    return;
                                } else if (data.type === 'error') {
                                    currentContent = `‚ùå Ïò§Î•ò: ${data.content}`;
                                    updateStreamingMessage(assistantMessage, currentContent, finalMetadata);
                                }

                                // search_result_itemÍ≥º finalÏùÑ Ï†úÏô∏Ìïú Î™®Îì† Ïù¥Î≤§Ìä∏ÏóêÏÑú ÏóÖÎç∞Ïù¥Ìä∏
                                if (data.type !== 'search_result_item' && data.type !== 'search_complete' && data.type !== 'final') {
                                    updateStreamingMessage(assistantMessage, currentContent, finalMetadata);
                                }

                            } catch (e) {
                                console.error('‚ùå JSON ÌååÏã± Ïò§Î•ò:', e);
                                console.error('ÌååÏã± Ïã§Ìå® Îç∞Ïù¥ÌÑ∞:', dataStr);
                                console.error('Îç∞Ïù¥ÌÑ∞ Í∏∏Ïù¥:', dataStr.length);
                                console.error('Ï≤´ 100Í∏ÄÏûê:', dataStr.substring(0, 100));
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Ïä§Ìä∏Î¶¨Î∞ç Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
                console.error('Ïò§Î•ò Ïä§ÌÉù:', error.stack);
                updateStreamingMessage(assistantMessage, `‚ùå Ïä§Ìä∏Î¶¨Î∞ç Ïò§Î•ò: ${error.message}`);
            }
        }

        // ÏùºÎ∞ò ÏùëÎãµ Ï≤òÎ¶¨
        async function handleNormalResponse(apiUrl, requestData) {
            console.log('üöÄ Sending request:', requestData);
            console.log('üìç Current tenant_id:', document.getElementById('tenantId').value);
            console.log('üìç Current platform:', document.getElementById('platform').value);
            
            const headers = {
                'Content-Type': 'application/json',
                'X-Tenant-ID': document.getElementById('tenantId').value,
                'X-Platform': document.getElementById('platform').value
            };
            
            // API KeyÍ∞Ä ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
            const apiKey = document.getElementById('apiKey').value;
            if (apiKey) {
                headers['X-API-Key'] = apiKey;
            }
            
            // DomainÏù¥ ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
            const domain = document.getElementById('domain').value;
            if (domain) {
                headers['X-Domain'] = domain;
            }
            
            console.log('Request headers:', headers);
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestData)
            });

            console.log('Response status:', response.status);
            console.log('Response headers:', [...response.headers.entries()]);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
            }

            const data = await response.json();
            console.log('Received response data:', data);
            
            // ÏÉÅÎã¥Ïõê Î™®Îìú ÏùëÎãµ Ï≤òÎ¶¨
            let content = '';
            let metadata = '';
            
            // ÎîîÎ≤ÑÍπÖÏùÑ ÏúÑÌïú Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖ ÌôïÏù∏
            console.log('Response data type:', data.type);
            console.log('Response keys:', Object.keys(data));
            
            if (data.type === 'final') {
                // final ÌÉÄÏûÖ ÏùëÎãµ Ï≤òÎ¶¨
                content = data.structured_response || data.content || 'ÏùëÎãµÏùÑ Î∞õÏïòÏäµÎãàÎã§.';
                console.log('Final response content:', content);
                
                if (data.total_results > 0) {
                    const context = data.search_context || {};
                    metadata = `
                        <strong>Í≤ÄÏÉâ Ï†ïÎ≥¥:</strong><br>
                        ‚Ä¢ ÏùòÎèÑ: ${context.intent || 'unknown'}<br>
                        ‚Ä¢ Ïö∞ÏÑ†ÏàúÏúÑ: ${context.urgency || 'unknown'}<br>
                        ‚Ä¢ ÌÇ§ÏõåÎìú: ${context.keywords ? context.keywords.join(', ') : 'none'}<br>
                        ‚Ä¢ Í≤ÄÏÉâ Í≤∞Í≥º: ${data.total_results || 0}Í∞ú<br>
                        ‚Ä¢ ÌíàÏßà Ï†êÏàò: ${data.quality_score ? (data.quality_score * 100).toFixed(1) : 0}%
                    `;
                }
            } else if (data.answer) {
                // ÏùºÎ∞ò QueryResponse Ï≤òÎ¶¨
                content = data.answer || 'ÏùëÎãµÏùÑ Î∞õÏïòÏäµÎãàÎã§.';
                console.log('QueryResponse answer:', content);
                
                if (data.metadata) {
                    const meta = data.metadata;
                    
                    // ÏÉÅÎã¥Ïõê Î™®ÎìúÏù∏ÏßÄ ÌôïÏù∏
                    if (meta.agent_mode) {
                        const context = meta.search_context || {};
                        metadata = `
                            <strong>ÏÉÅÎã¥Ïõê Í≤ÄÏÉâ Ï†ïÎ≥¥:</strong><br>
                            ‚Ä¢ ÏùòÎèÑ: ${context.intent || 'unknown'}<br>
                            ‚Ä¢ Ïö∞ÏÑ†ÏàúÏúÑ: ${context.urgency || 'unknown'}<br>
                            ‚Ä¢ ÌÇ§ÏõåÎìú: ${context.keywords ? context.keywords.join(', ') : 'none'}<br>
                            ‚Ä¢ Í≤ÄÏÉâÎêú Î¨∏ÏÑú: ${data.context_docs ? data.context_docs.length : 0}Í∞ú<br>
                            ‚Ä¢ ÌíàÏßà Ï†êÏàò: ${meta.quality_score ? (meta.quality_score * 100).toFixed(1) : 0}%<br>
                            ‚Ä¢ ÏùëÎãµ ÏãúÍ∞Ñ: ${meta.response_time_ms ? meta.response_time_ms.toFixed(1) : 0}ms
                        `;
                    } else {
                        metadata = `
                            <strong>ÏùëÎãµ Ï†ïÎ≥¥:</strong><br>
                            ‚Ä¢ Í≤ÄÏÉâÎêú Î¨∏ÏÑú: ${data.context_docs ? data.context_docs.length : 0}Í∞ú<br>
                            ‚Ä¢ ÏùëÎãµ ÏãúÍ∞Ñ: ${meta.response_time_ms ? meta.response_time_ms.toFixed(1) : 0}ms<br>
                            ‚Ä¢ ÌíàÏßà Ï†êÏàò: ${meta.quality_score ? (meta.quality_score * 100).toFixed(1) : 0}%
                        `;
                    }
                }
            } else {
                // ÏòàÏÉÅÏπò Î™ªÌïú ÏùëÎãµ ÌòïÌÉú
                content = `ÏõêÏãú ÏùëÎãµ: ${JSON.stringify(data, null, 2)}`;
                console.warn('Unexpected response format:', data);
            }

            console.log('Final content to display:', content);
            addMessage('assistant', content, metadata);
        }

        // ÏÉòÌîå Î©îÏãúÏßÄÎì§
        const sampleMessages = [
            "API Ïó∞Îèô Ïò§Î•ò Ìã∞Ïºì Ï∞æÏïÑÏ§ò",
            "Ïù¥Î≤à Ï£º Ìï¥Í≤∞Îêú VIP Í≥†Í∞ù ÏºÄÏù¥Ïä§",
            "Î°úÍ∑∏Ïù∏ Î¨∏Ï†ú Ìï¥Í≤∞ Í∞ÄÏù¥Îìú",
            "Í∏¥Í∏âÌïú Í≤∞Ï†ú Î¨∏Ï†ú Ìï¥Í≤∞ Î∞©Î≤ï",
            "Ïò§Îäò ÏÉùÏÑ±Îêú Ìã∞ÏºìÎì§ Î≥¥Ïó¨Ï§ò"
        ];

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÉòÌîå Î©îÏãúÏßÄ ÌëúÏãú
        window.addEventListener('load', function() {
            const placeholder = document.getElementById('messageInput');
            let currentIndex = 0;
            
            setInterval(() => {
                placeholder.placeholder = `Ïòà: ${sampleMessages[currentIndex]}`;
                currentIndex = (currentIndex + 1) % sampleMessages.length;
            }, 3000);
        });
    </script>
</body>
</html>