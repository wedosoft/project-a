# Feature Spec: 티켓 분석 속도 개선 + 필드 제안 UX 정리

## 배경/문제
- Freshdesk 앱에서 **티켓 분석(analysis)** 기능이 너무 느려 상담원 사용성이 떨어짐.
- 상담원이 실제로 필요한 핵심은 다음 2가지:
  1) **티켓 필드 제안/적용**: 에이전트가 스마트한 필드값을 제안하고, 특히 `nested_field`는 **3단계(leaf) 검색**으로 충분.
  2) **티켓 맥락 분석 요약**: 긴 스레드(대화 50개 이상)에서도 상담원이 빠르게 원인/해결책/히스토리를 파악하도록 **2~3개 섹션 타이틀로 핵심 요약**(형식적인 요약 불필요).
- 현재는 **대화 전체를 분석하지 못하는 듯**(중요 원인 파악 실패). Freshdesk conversations는 **페이지당 30개**이므로 **페이지네이션으로 전체 대화**를 수집해야 함.
- 백엔드 측에서는 테넌트 관련 테이블(`tenant_orgs`, `tenants`, `tenant_platform` 등)이 분리되어 있고, 고정 정보임에도 불필요한 API/DB 호출이 반복되어 **지연을 키우는 것으로 의심**됨.

## 목표
- UX
  - 탭 2개(티켓 분석/채팅)는 유지.
  - 채팅 기능은 유지하되 **검색 소스 선택은 단일 선택만 허용**.
  - 분석 탭에서는 
    - (A) "티켓 분석 요약(2~3 섹션)" + 
    - (B) "필드 업데이트 제안 카드" 를 제공.
  - `source` 필드는 필드 업데이트 제안/적용에서 제외.

- 데이터 완전성
  - 티켓 분석 시 **모든 conversation 페이지를 순회**하여 전체 대화를 수집/분석.

- 성능
  - 분석 요청 p95 체감 시간을 유의미하게 단축.
  - 테넌트 고정 데이터는 캐싱/통합하여 반복 조회 제거.

## 범위
### In-scope
- Frontend (`project-a/frontend`)
  - 채팅 소스 선택 단일 선택 강제.
  - 분석 탭 렌더링: (요약 섹션 2~3개) + (필드 제안 카드).
  - 필드 제안/적용에서 `source` 제외.

- Backend (`agent-platform`)
  - `/api/assist/analyze`가 분석에 필요한 **전체 conversations**를 수집하도록 개선(페이지네이션).
  - 테넌트 관련 데이터 접근을 단순화/캐싱하여 불필요한 호출을 줄임.

### Out-of-scope (현재 라운드)
- UI 전면 리디자인, ShadCN/React 전환 등 큰 프레임워크 변경
- 다국어/권한 정책 전면 개편

## 사용자 스토리
1. 상담원은 티켓을 열고 분석 탭에서 "분석 시작"을 눌러, 
   - 2~3개 섹션 타이틀로 요약된 분석 결과와
   - 추천 필드 값(중첩필드 leaf 검색 포함)
   을 본다.
2. 상담원은 필드 제안 카드에서 값 일부를 수정 후 "변경 사항 적용"을 눌러 티켓을 업데이트한다.
3. 상담원은 채팅 탭에서 검색 소스를 **하나만 선택**하고 질문한다.

## 기능 요구사항
### FR-1 탭 유지
- 분석/채팅 탭은 유지.

### FR-2 채팅 소스 단일 선택
- 기존 다중 선택 UI를 단일 선택으로 변경.
- 선택 변경 시 이전 선택은 해제.

### FR-3 티켓 분석: 전체 대화 수집
- Conversations API는 `per_page=30`으로 페이지네이션.
- 티켓에 따라 50개 이상 가능 → **모든 페이지**를 수집.

### FR-4 티켓 분석: 요약 형태
- 결과는 2~3개의 섹션(예: "핵심 이슈", "원인", "현재 상태/시도한 것")으로 출력.
- 형식적인 요약(불릿 나열/정형 템플릿)보다 상담원이 빠르게 판단 가능한 내용 위주.

### FR-5 필드 제안
- `nested_field`는 3단계 leaf를 **검색 입력(datalist)**로 선택 가능.
- `source` 필드는 제안/적용에서 제외.

## 비기능 요구사항
- 성능: 분석 결과가 사용자에게 체감상 빠르게 표시(진행 티커/스트리밍 유지 가능).
- 안정성: Freshdesk 업데이트 시 숫자/라벨 혼용으로 `NaN` 또는 `invalid_field`가 발생하지 않도록 타입 처리.

## 수용 기준(간단)
- (AC1) 채팅 소스가 1개만 선택된다.
- (AC2) 분석 요청 시 conversations 페이지네이션으로 전체 대화를 포함한다(50개 이상 티켓에서도).
- (AC3) 분석 결과가 2~3개 섹션 타이틀로 렌더링된다.
- (AC4) 필드 제안에서 `source`는 보이지 않으며, 업데이트 payload에도 포함되지 않는다.
- (AC5) 필드 적용 시 `priority/status` 등의 숫자 필드가 `NaN`이 되지 않는다.
